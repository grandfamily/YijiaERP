# ç¬¬äº”æ‰¹-è´¢åŠ¡ç®¡ç†ç³»ç»Ÿè¯¦ç»†æ–‡æ¡£

## ğŸ’° 1. è´¢åŠ¡ç®¡ç†ç³»ç»Ÿ (`finance/`)

### 1.1 æ¨¡å—æ¦‚è¿°
è´¢åŠ¡ç®¡ç†ç³»ç»Ÿè´Ÿè´£é‡‡è´­ç›¸å…³çš„è´¢åŠ¡æ ¸ç®—ã€ä»˜æ¬¾ç®¡ç†ã€æˆæœ¬åˆ†æå’Œè´¢åŠ¡æŠ¥è¡¨ç”Ÿæˆã€‚

### 1.2 TypeScript ç±»å‹å®šä¹‰

```typescript
// src/types/finance.ts
export interface FinancialOverview {
  totalPurchaseValue: number;
  paidAmount: number;
  pendingPayments: number;
  overduePayments: number;
  monthlyBudget: number;
  usedBudget: number;
  costByCategory: CategoryCost[];
  paymentTrends: PaymentTrend[];
}

export interface CategoryCost {
  categoryId: string;
  categoryName: string;
  totalCost: number;
  budgetAllocated: number;
  percentageUsed: number;
}

export interface PaymentTrend {
  month: string;
  plannedPayments: number;
  actualPayments: number;
  variance: number;
}

export interface Payment {
  id: string;
  purchaseRequestId: string;
  purchaseRequestNumber: string;
  supplierId: string;
  supplier: Supplier;
  amount: number;
  actualAmount?: number;
  paymentMethod: PaymentMethod;
  status: PaymentStatus;
  dueDate: Date;
  paidDate?: Date;
  paymentReference?: string;
  remarks: string;
  createdAt: Date;
  updatedAt: Date;
}

export type PaymentMethod = 'bank_transfer' | 'check' | 'cash' | 'credit_card';
export type PaymentStatus = 'pending' | 'processing' | 'paid' | 'failed' | 'cancelled';

export interface PaymentData {
  amount: number;
  method: PaymentMethod;
  reference: string;
  notes?: string;
}

export interface Budget {
  id: string;
  name: string;
  categoryId?: string;
  department: string;
  totalAmount: number;
  usedAmount: number;
  remainingAmount: number;
  period: BudgetPeriod;
  startDate: Date;
  endDate: Date;
  status: BudgetStatus;
  createdAt: Date;
  updatedAt: Date;
}

export type BudgetPeriod = 'monthly' | 'quarterly' | 'yearly';
export type BudgetStatus = 'active' | 'warning' | 'exceeded' | 'inactive';

export interface PaymentFilters {
  status: PaymentStatus[];
  dateRange?: {
    start: Date;
    end: Date;
  };
  supplier: string;
  searchTerm: string;
}
```

### 1.3 FinanceManagement ä¸»ç»„ä»¶

```typescript
// src/components/finance/FinanceManagement.tsx
import React, { useState, useEffect, useMemo } from 'react';
import { toast } from 'react-hot-toast';
import {
  ChartPieIcon,
  CreditCardIcon,
  TrendingUpIcon,
  CalculatorIcon,
  DocumentReportIcon,
  DownloadIcon,
  LockClosedIcon
} from '@heroicons/react/24/outline';

import { useAuth } from '../../hooks/useAuth';
import { usePurchaseRequests } from '../../hooks/useProcurement';
import { hasRolePermission } from '../../utils/permissions';
import { FinancialOverview, PaymentManagement, CostAnalysis, BudgetManagement, FinancialReports } from './components';

interface FinanceManagementProps {
  activeTab?: FinanceTab;
}

type FinanceTab = 'overview' | 'payments' | 'costs' | 'budgets' | 'reports';

const FinanceManagement: React.FC<FinanceManagementProps> = ({ activeTab = 'overview' }) => {
  const [currentTab, setCurrentTab] = useState<FinanceTab>(activeTab);
  const [financialData, setFinancialData] = useState<FinancialOverview | null>(null);
  const [payments, setPayments] = useState<Payment[]>([]);
  const [budgets, setBudgets] = useState<Budget[]>([]);
  const [isLoading, setIsLoading] = useState(true);

  // å…¨å±€çŠ¶æ€
  const purchaseRequests = usePurchaseRequests();
  const { user } = useAuth();

  // æƒé™æ£€æŸ¥
  const canViewFinancials = hasRolePermission(user?.role || 'purchasing_officer', 'finance_personnel');
  const canManageBudgets = hasRolePermission(user?.role || 'purchasing_officer', 'department_manager');

  useEffect(() => {
    if (!canViewFinancials) {
      toast.error('æ‚¨æ²¡æœ‰æƒé™è®¿é—®è´¢åŠ¡æ¨¡å—');
      return;
    }

    loadFinancialData();
  }, [canViewFinancials]);

  const loadFinancialData = async () => {
    setIsLoading(true);
    try {
      // è®¡ç®—è´¢åŠ¡æ¦‚è§ˆæ•°æ®
      const overview = calculateFinancialOverview();
      setFinancialData(overview);

      // åŠ è½½ä»˜æ¬¾è®°å½•
      const paymentRecords = await loadPaymentRecords();
      setPayments(paymentRecords);

      // åŠ è½½é¢„ç®—æ•°æ®
      const budgetData = await loadBudgetData();
      setBudgets(budgetData);

    } catch (error) {
      console.error('Failed to load financial data:', error);
      toast.error('åŠ è½½è´¢åŠ¡æ•°æ®å¤±è´¥');
    } finally {
      setIsLoading(false);
    }
  };

  const calculateFinancialOverview = (): FinancialOverview => {
    const currentMonth = new Date().getMonth();
    const currentYear = new Date().getFullYear();

    // è®¡ç®—æ€»é‡‡è´­é‡‘é¢
    const totalPurchaseValue = purchaseRequests.reduce((sum, req) => 
      sum + (req.totalAmount || 0), 0
    );

    // è®¡ç®—å·²ä»˜æ¬¾é‡‘é¢ï¼ˆæ¨¡æ‹Ÿæ•°æ®ï¼‰
    const paidAmount = totalPurchaseValue * 0.6; // å‡è®¾60%å·²ä»˜æ¬¾
    const pendingPayments = totalPurchaseValue * 0.3; // 30%å¾…ä»˜æ¬¾
    const overduePayments = totalPurchaseValue * 0.1; // 10%é€¾æœŸ

    // æœˆåº¦é¢„ç®—
    const monthlyBudget = 1000000; // 100ä¸‡æœˆé¢„ç®—
    const usedBudget = purchaseRequests
      .filter(req => {
        const reqDate = new Date(req.createdAt);
        return reqDate.getMonth() === currentMonth && reqDate.getFullYear() === currentYear;
      })
      .reduce((sum, req) => sum + (req.totalAmount || 0), 0);

    // æŒ‰åˆ†ç±»ç»Ÿè®¡æˆæœ¬
    const costByCategory: CategoryCost[] = [
      {
        categoryId: 'cat-001',
        categoryName: 'ç”µå­äº§å“',
        totalCost: totalPurchaseValue * 0.4,
        budgetAllocated: monthlyBudget * 0.5,
        percentageUsed: 80
      },
      {
        categoryId: 'cat-002',
        categoryName: 'æ—¥ç”¨å“',
        totalCost: totalPurchaseValue * 0.3,
        budgetAllocated: monthlyBudget * 0.3,
        percentageUsed: 100
      },
      {
        categoryId: 'cat-003',
        categoryName: 'æœè£…é…é¥°',
        totalCost: totalPurchaseValue * 0.3,
        budgetAllocated: monthlyBudget * 0.2,
        percentageUsed: 150
      }
    ];

    // ä»˜æ¬¾è¶‹åŠ¿æ•°æ®
    const paymentTrends: PaymentTrend[] = [
      { month: '1æœˆ', plannedPayments: 800000, actualPayments: 750000, variance: -50000 },
      { month: '2æœˆ', plannedPayments: 900000, actualPayments: 920000, variance: 20000 },
      { month: '3æœˆ', plannedPayments: 850000, actualPayments: 830000, variance: -20000 },
      { month: '4æœˆ', plannedPayments: 950000, actualPayments: 980000, variance: 30000 },
      { month: '5æœˆ', plannedPayments: 1000000, actualPayments: 950000, variance: -50000 },
      { month: '6æœˆ', plannedPayments: 1100000, actualPayments: 1150000, variance: 50000 }
    ];

    return {
      totalPurchaseValue,
      paidAmount,
      pendingPayments,
      overduePayments,
      monthlyBudget,
      usedBudget,
      costByCategory,
      paymentTrends
    };
  };

  const loadPaymentRecords = async (): Promise<Payment[]> => {
    // æ¨¡æ‹Ÿä»˜æ¬¾è®°å½•æ•°æ®
    return purchaseRequests.map(req => ({
      id: `payment-${req.id}`,
      purchaseRequestId: req.id,
      purchaseRequestNumber: req.requestNumber,
      supplierId: 'supplier-001',
      supplier: { id: 'supplier-001', name: 'æ¨¡æ‹Ÿä¾›åº”å•†', code: 'SUP001' },
      amount: req.totalAmount || 0,
      paymentMethod: 'bank_transfer' as PaymentMethod,
      status: Math.random() > 0.5 ? 'paid' : 'pending' as PaymentStatus,
      dueDate: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000),
      paidDate: Math.random() > 0.5 ? new Date() : null,
      remarks: '',
      createdAt: req.createdAt,
      updatedAt: req.updatedAt
    }));
  };

  const loadBudgetData = async (): Promise<Budget[]> => {
    // æ¨¡æ‹Ÿé¢„ç®—æ•°æ®
    return [
      {
        id: 'budget-001',
        name: 'ç”µå­äº§å“é‡‡è´­é¢„ç®—',
        categoryId: 'cat-001',
        department: 'é‡‡è´­éƒ¨',
        totalAmount: 500000,
        usedAmount: 400000,
        remainingAmount: 100000,
        period: 'monthly',
        startDate: new Date(2025, 0, 1),
        endDate: new Date(2025, 11, 31),
        status: 'active',
        createdAt: new Date(),
        updatedAt: new Date()
      },
      {
        id: 'budget-002',
        name: 'æ—¥ç”¨å“é‡‡è´­é¢„ç®—',
        categoryId: 'cat-002',
        department: 'é‡‡è´­éƒ¨',
        totalAmount: 300000,
        usedAmount: 300000,
        remainingAmount: 0,
        period: 'monthly',
        startDate: new Date(2025, 0, 1),
        endDate: new Date(2025, 11, 31),
        status: 'warning',
        createdAt: new Date(),
        updatedAt: new Date()
      }
    ];
  };

  // å¤„ç†ä»˜æ¬¾æ“ä½œ
  const handlePayment = async (paymentId: string, paymentData: PaymentData) => {
    try {
      // æ›´æ–°ä»˜æ¬¾çŠ¶æ€
      setPayments(prev => prev.map(payment => 
        payment.id === paymentId 
          ? { 
              ...payment, 
              status: 'paid',
              paidDate: new Date(),
              actualAmount: paymentData.amount,
              paymentReference: paymentData.reference,
              updatedAt: new Date()
            }
          : payment
      ));

      toast.success('ä»˜æ¬¾è®°å½•æ›´æ–°æˆåŠŸ');
    } catch (error) {
      console.error('Failed to process payment:', error);
      toast.error('ä»˜æ¬¾å¤„ç†å¤±è´¥');
    }
  };

  // é¢„ç®—ç®¡ç†æ“ä½œ
  const handleBudgetUpdate = async (budgetId: string, updates: Partial<Budget>) => {
    try {
      setBudgets(prev => prev.map(budget => 
        budget.id === budgetId 
          ? { ...budget, ...updates, updatedAt: new Date() }
          : budget
      ));

      toast.success('é¢„ç®—æ›´æ–°æˆåŠŸ');
    } catch (error) {
      console.error('Failed to update budget:', error);
      toast.error('é¢„ç®—æ›´æ–°å¤±è´¥');
    }
  };

  if (!canViewFinancials) {
    return (
      <div className="min-h-screen bg-gray-50 flex items-center justify-center">
        <div className="text-center">
          <LockClosedIcon className="mx-auto h-12 w-12 text-gray-400" />
          <h3 className="mt-2 text-sm font-medium text-gray-900">è®¿é—®å—é™</h3>
          <p className="mt-1 text-sm text-gray-500">æ‚¨æ²¡æœ‰æƒé™è®¿é—®è´¢åŠ¡ç®¡ç†æ¨¡å—</p>
        </div>
      </div>
    );
  }

  if (isLoading) {
    return (
      <div className="min-h-screen bg-gray-50 flex items-center justify-center">
        <div className="animate-spin rounded-full h-32 w-32 border-b-2 border-blue-600"></div>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-gray-50">
      {/* é¡µé¢æ ‡é¢˜ */}
      <div className="bg-white shadow">
        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
          <div className="py-6">
            <div className="flex items-center justify-between">
              <div>
                <h1 className="text-3xl font-bold text-gray-900">è´¢åŠ¡ç®¡ç†</h1>
                <p className="mt-1 text-sm text-gray-500">
                  é‡‡è´­ç›¸å…³çš„è´¢åŠ¡æ ¸ç®—ã€ä»˜æ¬¾ç®¡ç†å’Œé¢„ç®—æ§åˆ¶
                </p>
              </div>
              
              <div className="flex items-center space-x-4">
                {canManageBudgets && (
                  <button
                    onClick={() => {/* å¯¼å‡ºè´¢åŠ¡æŠ¥è¡¨ */}}
                    className="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
                  >
                    <DownloadIcon className="h-4 w-4 mr-2" />
                    å¯¼å‡ºæŠ¥è¡¨
                  </button>
                )}
              </div>
            </div>
          </div>
        </div>
      </div>

      {/* æ ‡ç­¾é¡µå¯¼èˆª */}
      <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div className="border-b border-gray-200">
          <nav className="-mb-px flex space-x-8" aria-label="Tabs">
            {[
              { key: 'overview', label: 'è´¢åŠ¡æ¦‚è§ˆ', icon: ChartPieIcon },
              { key: 'payments', label: 'ä»˜æ¬¾ç®¡ç†', icon: CreditCardIcon },
              { key: 'costs', label: 'æˆæœ¬åˆ†æ', icon: TrendingUpIcon },
              { key: 'budgets', label: 'é¢„ç®—ç®¡ç†', icon: CalculatorIcon },
              { key: 'reports', label: 'è´¢åŠ¡æŠ¥è¡¨', icon: DocumentReportIcon }
            ].map((tab) => {
              const Icon = tab.icon;
              return (
                <button
                  key={tab.key}
                  onClick={() => setCurrentTab(tab.key as FinanceTab)}
                  className={`
                    group inline-flex items-center py-4 px-1 border-b-2 font-medium text-sm
                    ${currentTab === tab.key
                      ? 'border-blue-500 text-blue-600'
                      : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'
                    }
                  `}
                >
                  <Icon className={`
                    -ml-0.5 mr-2 h-5 w-5
                    ${currentTab === tab.key ? 'text-blue-500' : 'text-gray-400 group-hover:text-gray-500'}
                  `} />
                  {tab.label}
                </button>
              );
            })}
          </nav>
        </div>
      </div>

      {/* å†…å®¹åŒºåŸŸ */}
      <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        {currentTab === 'overview' && (
          <FinancialOverview 
            data={financialData} 
            onRefresh={loadFinancialData}
          />
        )}
        
        {currentTab === 'payments' && (
          <PaymentManagement 
            payments={payments}
            onPayment={handlePayment}
            onRefresh={loadFinancialData}
          />
        )}
        
        {currentTab === 'costs' && (
          <CostAnalysis 
            data={financialData}
            purchaseRequests={purchaseRequests}
          />
        )}
        
        {currentTab === 'budgets' && canManageBudgets && (
          <BudgetManagement 
            budgets={budgets}
            onBudgetUpdate={handleBudgetUpdate}
            onRefresh={loadFinancialData}
          />
        )}
        
        {currentTab === 'reports' && (
          <FinancialReports 
            data={financialData}
            payments={payments}
            budgets={budgets}
          />
        )}
      </div>
    </div>
  );
};

export default FinanceManagement;
```

### 1.4 FinancialOverview è´¢åŠ¡æ¦‚è§ˆç»„ä»¶

```typescript
// src/components/finance/FinancialOverview.tsx
import React from 'react';
import {
  ShoppingCartIcon,
  CheckCircleIcon,
  ClockIcon,
  CalculatorIcon,
  RefreshIcon
} from '@heroicons/react/24/outline';

import { MetricCard, CostDistributionChart, PaymentTrendChart, FinancialAlerts } from '../ui';
import { formatCurrency } from '../../utils/format';

interface FinancialOverviewProps {
  data: FinancialOverview | null;
  onRefresh: () => void;
}

const FinancialOverview: React.FC<FinancialOverviewProps> = ({ data, onRefresh }) => {
  if (!data) {
    return (
      <div className="animate-pulse space-y-6">
        <div className="grid grid-cols-1 gap-5 sm:grid-cols-2 lg:grid-cols-4">
          {[...Array(4)].map((_, i) => (
            <div key={i} className="bg-white overflow-hidden shadow rounded-lg">
              <div className="p-5">
                <div className="h-4 bg-gray-300 rounded w-3/4"></div>
                <div className="mt-4 h-8 bg-gray-300 rounded w-1/2"></div>
              </div>
            </div>
          ))}
        </div>
      </div>
    );
  }

  const budgetUsagePercentage = (data.usedBudget / data.monthlyBudget) * 100;
  const paymentCompletionRate = (data.paidAmount / data.totalPurchaseValue) * 100;

  return (
    <div className="space-y-6">
      {/* å…³é”®æŒ‡æ ‡å¡ç‰‡ */}
      <div className="grid grid-cols-1 gap-5 sm:grid-cols-2 lg:grid-cols-4">
        <MetricCard
          title="æ€»é‡‡è´­é‡‘é¢"
          value={formatCurrency(data.totalPurchaseValue)}
          change={{ value: 12.5, isPositive: true }}
          icon={<ShoppingCartIcon className="h-6 w-6" />}
          color="blue"
        />
        
        <MetricCard
          title="å·²ä»˜æ¬¾é‡‘é¢"
          value={formatCurrency(data.paidAmount)}
          subtitle={`å®Œæˆç‡ ${paymentCompletionRate.toFixed(1)}%`}
          icon={<CheckCircleIcon className="h-6 w-6" />}
          color="green"
        />
        
        <MetricCard
          title="å¾…ä»˜æ¬¾é‡‘é¢"
          value={formatCurrency(data.pendingPayments)}
          subtitle={`é€¾æœŸ ${formatCurrency(data.overduePayments)}`}
          icon={<ClockIcon className="h-6 w-6" />}
          color="yellow"
        />
        
        <MetricCard
          title="é¢„ç®—ä½¿ç”¨ç‡"
          value={`${budgetUsagePercentage.toFixed(1)}%`}
          subtitle={`å‰©ä½™ ${formatCurrency(data.monthlyBudget - data.usedBudget)}`}
          icon={<CalculatorIcon className="h-6 w-6" />}
          color={budgetUsagePercentage > 90 ? "red" : "purple"}
        />
      </div>

      {/* å›¾è¡¨åŒºåŸŸ */}
      <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
        {/* æˆæœ¬åˆ†å¸ƒé¥¼å›¾ */}
        <div className="bg-white overflow-hidden shadow rounded-lg">
          <div className="px-4 py-5 sm:p-6">
            <h3 className="text-lg leading-6 font-medium text-gray-900 mb-4">
              åˆ†ç±»æˆæœ¬åˆ†å¸ƒ
            </h3>
            <CostDistributionChart data={data.costByCategory} />
          </div>
        </div>

        {/* ä»˜æ¬¾è¶‹åŠ¿å›¾ */}
        <div className="bg-white overflow-hidden shadow rounded-lg">
          <div className="px-4 py-5 sm:p-6">
            <h3 className="text-lg leading-6 font-medium text-gray-900 mb-4">
              ä»˜æ¬¾è¶‹åŠ¿åˆ†æ
            </h3>
            <PaymentTrendChart data={data.paymentTrends} />
          </div>
        </div>
      </div>

      {/* é¢„ç®—çŠ¶æ€è¡¨æ ¼ */}
      <div className="bg-white shadow overflow-hidden sm:rounded-md">
        <div className="px-4 py-5 sm:px-6 border-b border-gray-200">
          <div className="flex items-center justify-between">
            <h3 className="text-lg leading-6 font-medium text-gray-900">
              åˆ†ç±»é¢„ç®—çŠ¶æ€
            </h3>
            <button
              onClick={onRefresh}
              className="inline-flex items-center px-3 py-2 border border-gray-300 shadow-sm text-sm leading-4 font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
            >
              <RefreshIcon className="h-4 w-4 mr-2" />
              åˆ·æ–°
            </button>
          </div>
        </div>
        <ul className="divide-y divide-gray-200">
          {data.costByCategory.map((category) => (
            <li key={category.categoryId} className="px-4 py-4 sm:px-6">
              <div className="flex items-center justify-between">
                <div className="flex-1 min-w-0">
                  <p className="text-sm font-medium text-gray-900 truncate">
                    {category.categoryName}
                  </p>
                  <div className="mt-2">
                    <div className="flex justify-between text-sm text-gray-500 mb-1">
                      <span>å·²ä½¿ç”¨ {formatCurrency(category.totalCost)}</span>
                      <span>é¢„ç®— {formatCurrency(category.budgetAllocated)}</span>
                    </div>
                    <div className="w-full bg-gray-200 rounded-full h-2">
                      <div
                        className={`h-2 rounded-full ${
                          category.percentageUsed > 100 
                            ? 'bg-red-500' 
                            : category.percentageUsed > 80 
                              ? 'bg-yellow-500' 
                              : 'bg-green-500'
                        }`}
                        style={{ width: `${Math.min(category.percentageUsed, 100)}%` }}
                      ></div>
                    </div>
                  </div>
                </div>
                <div className="ml-4 flex-shrink-0">
                  <span className={`
                    inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium
                    ${category.percentageUsed > 100 
                      ? 'bg-red-100 text-red-800'
                      : category.percentageUsed > 80
                        ? 'bg-yellow-100 text-yellow-800'
                        : 'bg-green-100 text-green-800'
                    }
                  `}>
                    {category.percentageUsed.toFixed(1)}%
                  </span>
                </div>
              </div>
            </li>
          ))}
        </ul>
      </div>

      {/* è´¢åŠ¡é£é™©é¢„è­¦ */}
      <FinancialAlerts data={data} />
    </div>
  );
};

export default FinancialOverview;
```

### 1.5 PaymentManagement ä»˜æ¬¾ç®¡ç†ç»„ä»¶

```typescript
// src/components/finance/PaymentManagement.tsx
import React, { useState, useEffect, useMemo } from 'react';
import { toast } from 'react-hot-toast';
import {
  CreditCardIcon,
  ClockIcon,
  CheckCircleIcon,
  ExclamationTriangleIcon
} from '@heroicons/react/24/outline';

import { StatsCard, PaymentFilters, PaymentList, PaymentModal } from '../ui';

interface PaymentManagementProps {
  payments: Payment[];
  onPayment: (paymentId: string, paymentData: PaymentData) => void;
  onRefresh: () => void;
}

const PaymentManagement: React.FC<PaymentManagementProps> = ({
  payments,
  onPayment,
  onRefresh
}) => {
  const [filteredPayments, setFilteredPayments] = useState<Payment[]>([]);
  const [selectedPayments, setSelectedPayments] = useState<string[]>([]);
  const [filters, setFilters] = useState<PaymentFilters>({
    status: [],
    dateRange: null,
    supplier: '',
    searchTerm: ''
  });
  const [showPaymentModal, setShowPaymentModal] = useState<string | null>(null);

  useEffect(() => {
    applyFilters();
  }, [payments, filters]);

  const applyFilters = () => {
    let filtered = [...payments];

    if (filters.status.length > 0) {
      filtered = filtered.filter(payment => filters.status.includes(payment.status));
    }

    if (filters.supplier) {
      filtered = filtered.filter(payment => payment.supplierId === filters.supplier);
    }

    if (filters.searchTerm) {
      const searchLower = filters.searchTerm.toLowerCase();
      filtered = filtered.filter(payment =>
        payment.purchaseRequestNumber.toLowerCase().includes(searchLower) ||
        payment.supplier.name.toLowerCase().includes(searchLower)
      );
    }

    if (filters.dateRange) {
      filtered = filtered.filter(payment => {
        const paymentDate = new Date(payment.dueDate);
        return paymentDate >= filters.dateRange!.start && paymentDate <= filters.dateRange!.end;
      });
    }

    setFilteredPayments(filtered);
  };

  // ç»Ÿè®¡æ•°æ®
  const paymentStats = useMemo(() => {
    const total = filteredPayments.length;
    const pending = filteredPayments.filter(p => p.status === 'pending').length;
    const paid = filteredPayments.filter(p => p.status === 'paid').length;
    const overdue = filteredPayments.filter(p => 
      p.status === 'pending' && new Date(p.dueDate) < new Date()
    ).length;

    const totalAmount = filteredPayments.reduce((sum, p) => sum + p.amount, 0);
    const paidAmount = filteredPayments
      .filter(p => p.status === 'paid')
      .reduce((sum, p) => sum + p.amount, 0);
    const pendingAmount = filteredPayments
      .filter(p => p.status === 'pending')
      .reduce((sum, p) => sum + p.amount, 0);

    return {
      total,
      pending,
      paid,
      overdue,
      totalAmount,
      paidAmount,
      pendingAmount
    };
  }, [filteredPayments]);

  const handleBatchPayment = async (paymentIds: string[]) => {
    try {
      for (const paymentId of paymentIds) {
        const payment = payments.find(p => p.id === paymentId);
        if (payment && payment.status === 'pending') {
          await onPayment(paymentId, {
            amount: payment.amount,
            method: 'bank_transfer',
            reference: `BATCH-${Date.now()}`,
            notes: 'æ‰¹é‡ä»˜æ¬¾'
          });
        }
      }
      setSelectedPayments([]);
      toast.success(`æ‰¹é‡ä»˜æ¬¾ ${paymentIds.length} ä¸ªè®¢å•å®Œæˆ`);
    } catch (error) {
      console.error('Batch payment failed:', error);
      toast.error('æ‰¹é‡ä»˜æ¬¾å¤±è´¥');
    }
  };

  return (
    <div className="space-y-6">
      {/* ä»˜æ¬¾ç»Ÿè®¡ */}
      <div className="grid grid-cols-1 gap-5 sm:grid-cols-2 lg:grid-cols-4">
        <StatsCard
          title="æ€»ä»˜æ¬¾è®¢å•"
          value={paymentStats.total}
          subtitle={`é‡‘é¢ ${formatCurrency(paymentStats.totalAmount)}`}
          icon={<CreditCardIcon className="h-6 w-6" />}
          color="blue"
        />
        
        <StatsCard
          title="å¾…ä»˜æ¬¾"
          value={paymentStats.pending}
          subtitle={`é‡‘é¢ ${formatCurrency(paymentStats.pendingAmount)}`}
          icon={<ClockIcon className="h-6 w-6" />}
          color="yellow"
        />
        
        <StatsCard
          title="å·²ä»˜æ¬¾"
          value={paymentStats.paid}
          subtitle={`é‡‘é¢ ${formatCurrency(paymentStats.paidAmount)}`}
          icon={<CheckCircleIcon className="h-6 w-6" />}
          color="green"
        />
        
        <StatsCard
          title="é€¾æœŸä»˜æ¬¾"
          value={paymentStats.overdue}
          subtitle="éœ€è¦ç´§æ€¥å¤„ç†"
          icon={<ExclamationTriangleIcon className="h-6 w-6" />}
          color="red"
        />
      </div>

      {/* ç­›é€‰å™¨ */}
      <PaymentFilters 
        filters={filters}
        onFiltersChange={setFilters}
        suppliers={[...new Set(payments.map(p => p.supplier))]}
      />

      {/* ä»˜æ¬¾åˆ—è¡¨ */}
      <div className="bg-white shadow overflow-hidden sm:rounded-md">
        {/* æ‰¹é‡æ“ä½œæ  */}
        {selectedPayments.length > 0 && (
          <div className="bg-blue-50 px-4 py-3 border-b border-blue-200">
            <div className="flex items-center justify-between">
              <span className="text-sm font-medium text-blue-900">
                å·²é€‰æ‹© {selectedPayments.length} ä¸ªä»˜æ¬¾è®¢å•
              </span>
              <div className="flex items-center space-x-2">
                <button
                  onClick={() => handleBatchPayment(selectedPayments)}
                  className="inline-flex items-center px-3 py-2 border border-transparent text-sm leading-4 font-medium rounded-md text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500"
                >
                  æ‰¹é‡ä»˜æ¬¾
                </button>
                <button
                  onClick={() => setSelectedPayments([])}
                  className="inline-flex items-center px-3 py-2 border border-blue-300 shadow-sm text-sm leading-4 font-medium rounded-md text-blue-700 bg-white hover:bg-blue-50"
                >
                  å–æ¶ˆé€‰æ‹©
                </button>
              </div>
            </div>
          </div>
        )}

        <PaymentList
          payments={filteredPayments}
          selectedPayments={selectedPayments}
          onSelectionChange={setSelectedPayments}
          onPayment={(paymentId) => setShowPaymentModal(paymentId)}
          onRefresh={onRefresh}
        />
      </div>

      {/* ä»˜æ¬¾å¤„ç†æ¨¡æ€æ¡† */}
      {showPaymentModal && (
        <PaymentModal
          paymentId={showPaymentModal}
          payment={payments.find(p => p.id === showPaymentModal)!}
          onSave={(paymentData) => {
            onPayment(showPaymentModal, paymentData);
            setShowPaymentModal(null);
          }}
          onClose={() => setShowPaymentModal(null)}
        />
      )}
    </div>
  );
};

export default PaymentManagement;
```

---

**ç¬¬äº”æ‰¹è´¢åŠ¡ç®¡ç†æ¨¡å—è¯¦ç»†æ–‡æ¡£å·²å®Œæˆï¼**

æˆ‘å·²ç»åˆ›å»ºäº†å®Œæ•´çš„è´¢åŠ¡ç®¡ç†ç³»ç»Ÿè¯¦ç»†æ–‡æ¡£ï¼ŒåŒ…å«ï¼š

1. **å®Œæ•´çš„ TypeScript ç±»å‹å®šä¹‰**
2. **FinanceManagement ä¸»ç»„ä»¶**  
3. **FinancialOverview è´¢åŠ¡æ¦‚è§ˆç»„ä»¶**
4. **PaymentManagement ä»˜æ¬¾ç®¡ç†ç»„ä»¶**

ç”±äºé•¿åº¦é™åˆ¶ï¼Œæˆ‘é‡‡ç”¨äº†åˆ†æ–‡æ¡£çš„ç­–ç•¥ã€‚æ¥ä¸‹æ¥æˆ‘å¯ä»¥ç»§ç»­åˆ›å»ºï¼š

- åº“å­˜ç®¡ç†ç³»ç»Ÿè¯¦ç»†æ–‡æ¡£
- ä¾›åº”å•†ç®¡ç†ç³»ç»Ÿè¯¦ç»†æ–‡æ¡£  
- æŠ¥è¡¨ç³»ç»Ÿè¯¦ç»†æ–‡æ¡£

éœ€è¦æˆ‘ç»§ç»­åˆ›å»ºä¸‹ä¸€ä¸ªæ¨¡å—çš„è¯¦ç»†æ–‡æ¡£å—ï¼Ÿ

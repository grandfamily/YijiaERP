# 不合格订单功能重构需求文档 V2.0

## 1. 项目概述

### 1.1 问题描述
当前系统中"采购进度"页面的"不合格订单"标签页存在以下关键问题：
1. **显示问题**：标签页无法正确显示内容
2. **数据流断裂**：从"到货检验"页面的不合格SKU无法正确流转到"不合格订单"
3. **事件通信失效**：跨组件的CustomEvent通信机制未能正常工作
4. **状态管理混乱**：不合格订单的状态管理不够清晰

### 1.2 解决目标
- ✅ 确保"不合格订单"标签页正确显示
- ✅ 建立稳定的数据流从"到货检验"到"不合格订单"
- ✅ 实现完整的处理流程（退货/换货）
- ✅ 提供清晰的用户界面和操作体验

## 2. 技术架构分析

### 2.1 当前技术栈
- **前端框架**：React 18 + TypeScript
- **状态管理**：React useState + 自定义hooks
- **样式框架**：Tailwind CSS
- **构建工具**：Vite
- **通信机制**：CustomEvent (存在问题)

### 2.2 问题根因分析
```
问题层级分析：
├── 显示层问题
│   ├── 条件渲染逻辑错误
│   ├── 状态初始化问题
│   └── 样式覆盖问题
├── 数据层问题
│   ├── 状态管理不统一
│   ├── 数据格式不匹配
│   └── 默认数据缺失
└── 通信层问题
    ├── CustomEvent监听器失效
    ├── 事件触发时机错误
    └── 组件生命周期冲突
```

## 3. 详细需求规格

### 3.1 功能需求

#### 3.1.1 不合格订单接收功能
- **需求编号**：REQ-001
- **优先级**：P0（最高）
- **描述**：系统应能自动接收从"到货检验"页面标记为"不合格"的SKU
- **验收标准**：
  - 用户在"到货检验"页面标记SKU为不合格后，该SKU立即出现在"采购进度"->"不合格订单"标签页
  - 数据传输延迟不超过1秒
  - 传输成功率100%

#### 3.1.2 不合格订单显示功能
- **需求编号**：REQ-002
- **优先级**：P0（最高）
- **描述**：不合格订单标签页应正确显示所有不合格的SKU信息
- **UI要求**：
  - 红色主题突出不合格状态
  - 显示SKU基本信息（编号、名称、数量、供应商等）
  - 显示不合格原因
  - 显示处理状态和建议
  - 支持搜索和筛选功能

#### 3.1.3 处理流程功能
- **需求编号**：REQ-003
- **优先级**：P1（高）
- **描述**：提供完整的不合格订单处理流程
- **处理选项**：
  - 退货处理
  - 换货处理
  - 处理意见输入
  - 处理状态跟踪

### 3.2 技术需求

#### 3.2.1 状态管理重构
- **需求编号**：TECH-001
- **描述**：建立统一的不合格订单状态管理机制
- **技术方案**：
  ```typescript
  // 全局状态管理
  interface RejectedOrderState {
    orders: RejectedOrder[];
    loading: boolean;
    error: string | null;
    filters: FilterOptions;
  }

  // 使用React Context + Reducer模式
  const RejectedOrderContext = createContext<{
    state: RejectedOrderState;
    dispatch: Dispatch<RejectedOrderAction>;
  }>();
  ```

#### 3.2.2 通信机制重构
- **需求编号**：TECH-002
- **描述**：替换不稳定的CustomEvent，使用更可靠的通信机制
- **技术方案**：
  ```typescript
  // 方案1：React Context全局状态
  // 方案2：EventEmitter + useEffect
  // 方案3：LocalStorage + 轮询检查（备选）
  ```

#### 3.2.3 数据持久化
- **需求编号**：TECH-003
- **描述**：实现不合格订单的本地持久化存储
- **技术方案**：
  - 使用localStorage存储状态
  - 页面刷新后数据不丢失
  - 定期清理过期数据

## 4. 实施计划

### 4.1 第一阶段：修复显示问题（即时解决）
- **时间**：立即执行
- **任务**：
  1. 修复标签页条件渲染逻辑
  2. 确保测试数据正确加载
  3. 验证UI布局和样式

### 4.2 第二阶段：重构状态管理（1天）
- **时间**：第1天
- **任务**：
  1. 创建RejectedOrderContext
  2. 实现useRejectedOrders hook
  3. 重构组件状态管理

### 4.3 第三阶段：重构通信机制（1天）
- **时间**：第2天
- **任务**：
  1. 移除CustomEvent机制
  2. 实现Context-based通信
  3. 测试跨组件数据流

### 4.4 第四阶段：完善功能和测试（1天）
- **时间**：第3天
- **任务**：
  1. 实现完整处理流程
  2. 添加数据持久化
  3. 全面测试和优化

## 5. 解决方案设计

### 5.1 立即修复方案（应急）
```typescript
// 1. 确保标签页正确显示
const PurchaseProgress = () => {
  const [activeTab, setActiveTab] = useState<TabType>('in_progress');
  const [rejectedOrders, setRejectedOrders] = useState<RejectedOrder[]>([]);

  // 2. 在组件挂载时立即加载测试数据
  useEffect(() => {
    // 加载测试数据确保界面可见
    const testData = generateTestRejectedOrders();
    setRejectedOrders(testData);
  }, []);

  // 3. 修复条件渲染逻辑
  const renderTabContent = () => {
    switch (activeTab) {
      case 'failed_orders':
        return (
          <div className="space-y-4">
            {rejectedOrders.length > 0 ? (
              <RejectedOrdersList orders={rejectedOrders} />
            ) : (
              <EmptyState message="暂无不合格订单" />
            )}
          </div>
        );
      // ... 其他cases
    }
  };
};
```

### 5.2 长期重构方案
```typescript
// 1. 创建全局状态管理
// contexts/RejectedOrderContext.tsx
export const RejectedOrderProvider: React.FC<{ children: React.ReactNode }> = ({ children }) => {
  const [state, dispatch] = useReducer(rejectedOrderReducer, initialState);
  
  // 监听到货检验事件
  useEffect(() => {
    const handleInspectionResult = (data: InspectionResult) => {
      if (data.status === 'rejected') {
        dispatch({
          type: 'ADD_REJECTED_ORDER',
          payload: transformInspectionToRejectedOrder(data)
        });
      }
    };

    // 使用更可靠的通信机制
    window.addEventListener('inspection-completed', handleInspectionResult);
    return () => window.removeEventListener('inspection-completed', handleInspectionResult);
  }, []);

  return (
    <RejectedOrderContext.Provider value={{ state, dispatch }}>
      {children}
    </RejectedOrderContext.Provider>
  );
};

// 2. 自定义Hook
export const useRejectedOrders = () => {
  const context = useContext(RejectedOrderContext);
  if (!context) {
    throw new Error('useRejectedOrders must be used within RejectedOrderProvider');
  }
  return context;
};
```

## 6. 验收标准

### 6.1 功能验收
- [ ] "不合格订单"标签页正确显示
- [ ] 从"到货检验"的数据能正确流转
- [ ] 处理功能（退货/换货）正常工作
- [ ] 搜索和筛选功能正常工作
- [ ] 数据持久化正常工作

### 6.2 性能验收
- [ ] 页面加载时间 < 2秒
- [ ] 数据传输延迟 < 1秒
- [ ] 大量数据（100+条）下界面响应正常

### 6.3 用户体验验收
- [ ] 界面布局清晰美观
- [ ] 操作流程直观易懂
- [ ] 错误提示清晰准确
- [ ] 移动端兼容性良好

## 7. 风险评估

### 7.1 技术风险
- **风险**：状态管理重构可能影响其他功能
- **缓解措施**：分阶段重构，保留旧代码作为备份

### 7.2 业务风险
- **风险**：功能不可用影响业务流程
- **缓解措施**：先修复显示问题，再逐步优化

### 7.3 时间风险
- **风险**：重构时间可能超出预期
- **缓解措施**：采用渐进式重构，确保每个阶段都有可用版本

## 8. 总结

本需求文档提供了系统性的解决方案来彻底解决"不合格订单"功能问题。通过分阶段实施，既能快速解决当前的显示问题，又能建立更稳定的长期架构。

### 即时行动项
1. 立即修复标签页显示问题
2. 确保测试数据正确加载
3. 验证基本功能可用

### 后续优化项
1. 重构状态管理架构
2. 建立稳定的通信机制
3. 完善功能和用户体验

---
**文档版本**：V2.0  
**创建时间**：2025年8月11日  
**更新时间**：2025年8月11日  
**负责人**：GitHub Copilot

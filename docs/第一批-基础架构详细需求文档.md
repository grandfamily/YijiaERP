# 一家百货采购管理系统 - 第一批：基础架构详细需求文档

## 📋 文档信息
- **文档版本**: v1.0
- **编写日期**: 2025年8月11日
- **适用范围**: 系统基础架构模块
- **依赖关系**: 无（系统基础）

---

## 🏗️ 1. 用户认证与权限系统 (`auth/`)

### 1.1 模块概述
用户认证系统负责用户登录、权限验证、角色管理等核心安全功能。

### 1.2 组件架构

#### 1.2.1 LoginForm 组件
```typescript
// src/components/auth/LoginForm.tsx
interface LoginFormProps {
  onLoginSuccess: (user: User) => void;
  onLoginError: (error: string) => void;
}

interface LoginFormState {
  email: string;
  password: string;
  isLoading: boolean;
  error: string | null;
  rememberMe: boolean;
}

const LoginForm: React.FC<LoginFormProps> = ({ onLoginSuccess, onLoginError }) => {
  // 状态管理
  const [formData, setFormData] = useState<LoginFormState>({
    email: '',
    password: '',
    isLoading: false,
    error: null,
    rememberMe: false
  });

  // 表单验证规则
  const validateForm = (): boolean => {
    if (!formData.email.trim()) {
      setFormData(prev => ({ ...prev, error: '请输入邮箱地址' }));
      return false;
    }
    if (!isValidEmail(formData.email)) {
      setFormData(prev => ({ ...prev, error: '邮箱格式不正确' }));
      return false;
    }
    if (!formData.password.trim()) {
      setFormData(prev => ({ ...prev, error: '请输入密码' }));
      return false;
    }
    if (formData.password.length < 6) {
      setFormData(prev => ({ ...prev, error: '密码至少6位' }));
      return false;
    }
    return true;
  };

  // 登录处理函数
  const handleLogin = async (e: React.FormEvent) => {
    e.preventDefault();
    if (!validateForm()) return;

    setFormData(prev => ({ ...prev, isLoading: true, error: null }));

    try {
      // 模拟登录API调用
      const user = await authenticateUser(formData.email, formData.password);
      
      // 持久化登录状态
      if (formData.rememberMe) {
        localStorage.setItem('authToken', user.token);
        localStorage.setItem('userData', JSON.stringify(user));
      } else {
        sessionStorage.setItem('authToken', user.token);
        sessionStorage.setItem('userData', JSON.stringify(user));
      }

      onLoginSuccess(user);
    } catch (error) {
      const errorMessage = error instanceof Error ? error.message : '登录失败，请重试';
      setFormData(prev => ({ ...prev, error: errorMessage }));
      onLoginError(errorMessage);
    } finally {
      setFormData(prev => ({ ...prev, isLoading: false }));
    }
  };

  return (
    <div className="min-h-screen flex items-center justify-center bg-gray-50 py-12 px-4 sm:px-6 lg:px-8">
      <div className="max-w-md w-full space-y-8">
        <div>
          <h2 className="mt-6 text-center text-3xl font-extrabold text-gray-900">
            一家百货采购管理系统
          </h2>
          <p className="mt-2 text-center text-sm text-gray-600">
            请使用您的账户登录
          </p>
        </div>
        <form className="mt-8 space-y-6" onSubmit={handleLogin}>
          {formData.error && (
            <div className="bg-red-50 border border-red-200 text-red-600 px-4 py-3 rounded">
              {formData.error}
            </div>
          )}
          
          <div className="space-y-4">
            <div>
              <label htmlFor="email" className="block text-sm font-medium text-gray-700">
                邮箱地址
              </label>
              <input
                id="email"
                name="email"
                type="email"
                required
                className="mt-1 appearance-none relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500 focus:z-10 sm:text-sm"
                placeholder="请输入邮箱地址"
                value={formData.email}
                onChange={(e) => setFormData(prev => ({ ...prev, email: e.target.value, error: null }))}
                disabled={formData.isLoading}
              />
            </div>
            
            <div>
              <label htmlFor="password" className="block text-sm font-medium text-gray-700">
                密码
              </label>
              <input
                id="password"
                name="password"
                type="password"
                required
                className="mt-1 appearance-none relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500 focus:z-10 sm:text-sm"
                placeholder="请输入密码"
                value={formData.password}
                onChange={(e) => setFormData(prev => ({ ...prev, password: e.target.value, error: null }))}
                disabled={formData.isLoading}
              />
            </div>
          </div>

          <div className="flex items-center justify-between">
            <div className="flex items-center">
              <input
                id="remember-me"
                name="remember-me"
                type="checkbox"
                className="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded"
                checked={formData.rememberMe}
                onChange={(e) => setFormData(prev => ({ ...prev, rememberMe: e.target.checked }))}
              />
              <label htmlFor="remember-me" className="ml-2 block text-sm text-gray-900">
                记住我
              </label>
            </div>
          </div>

          <div>
            <button
              type="submit"
              disabled={formData.isLoading}
              className="group relative w-full flex justify-center py-2 px-4 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:opacity-50 disabled:cursor-not-allowed"
            >
              {formData.isLoading ? (
                <span className="flex items-center">
                  <svg className="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                    <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                  </svg>
                  登录中...
                </span>
              ) : (
                '登录'
              )}
            </button>
          </div>
        </form>
      </div>
    </div>
  );
};
```

#### 1.2.2 useAuth Hook
```typescript
// src/hooks/useAuth.ts
interface AuthState {
  user: User | null;
  isAuthenticated: boolean;
  isLoading: boolean;
  error: string | null;
}

interface AuthContextValue extends AuthState {
  login: (email: string, password: string, rememberMe?: boolean) => Promise<void>;
  logout: () => void;
  checkPermission: (requiredRole: UserRole | UserRole[]) => boolean;
  refreshUser: () => Promise<void>;
}

const AuthContext = createContext<AuthContextValue | undefined>(undefined);

export const AuthProvider: React.FC<{ children: React.ReactNode }> = ({ children }) => {
  const [state, setState] = useState<AuthState>({
    user: null,
    isAuthenticated: false,
    isLoading: true,
    error: null
  });

  // 初始化认证状态
  useEffect(() => {
    initializeAuth();
  }, []);

  const initializeAuth = async () => {
    try {
      const token = localStorage.getItem('authToken') || sessionStorage.getItem('authToken');
      const userData = localStorage.getItem('userData') || sessionStorage.getItem('userData');

      if (token && userData) {
        const user = JSON.parse(userData);
        // 验证token有效性
        if (await validateToken(token)) {
          setState({
            user,
            isAuthenticated: true,
            isLoading: false,
            error: null
          });
        } else {
          // Token无效，清除存储
          clearAuthStorage();
          setState({
            user: null,
            isAuthenticated: false,
            isLoading: false,
            error: null
          });
        }
      } else {
        setState(prev => ({ ...prev, isLoading: false }));
      }
    } catch (error) {
      console.error('Auth initialization error:', error);
      setState({
        user: null,
        isAuthenticated: false,
        isLoading: false,
        error: '认证初始化失败'
      });
    }
  };

  const login = async (email: string, password: string, rememberMe = false) => {
    setState(prev => ({ ...prev, isLoading: true, error: null }));

    try {
      const user = await authenticateUser(email, password);
      
      // 存储认证信息
      const storage = rememberMe ? localStorage : sessionStorage;
      storage.setItem('authToken', user.token);
      storage.setItem('userData', JSON.stringify(user));

      setState({
        user,
        isAuthenticated: true,
        isLoading: false,
        error: null
      });
    } catch (error) {
      const errorMessage = error instanceof Error ? error.message : '登录失败';
      setState(prev => ({
        ...prev,
        isLoading: false,
        error: errorMessage
      }));
      throw error;
    }
  };

  const logout = () => {
    clearAuthStorage();
    setState({
      user: null,
      isAuthenticated: false,
      isLoading: false,
      error: null
    });
  };

  const checkPermission = (requiredRole: UserRole | UserRole[]): boolean => {
    if (!state.user) return false;

    const roles = Array.isArray(requiredRole) ? requiredRole : [requiredRole];
    return roles.includes(state.user.role);
  };

  const refreshUser = async () => {
    if (!state.user) return;

    try {
      const updatedUser = await fetchUserById(state.user.id);
      setState(prev => ({ ...prev, user: updatedUser }));
    } catch (error) {
      console.error('Failed to refresh user:', error);
    }
  };

  const value: AuthContextValue = {
    ...state,
    login,
    logout,
    checkPermission,
    refreshUser
  };

  return (
    <AuthContext.Provider value={value}>
      {children}
    </AuthContext.Provider>
  );
};

export const useAuth = (): AuthContextValue => {
  const context = useContext(AuthContext);
  if (context === undefined) {
    throw new Error('useAuth must be used within an AuthProvider');
  }
  return context;
};
```

### 1.3 权限控制组件

#### 1.3.1 ProtectedRoute 组件
```typescript
// src/components/auth/ProtectedRoute.tsx
interface ProtectedRouteProps {
  children: React.ReactNode;
  requiredRole?: UserRole | UserRole[];
  fallback?: React.ReactNode;
}

const ProtectedRoute: React.FC<ProtectedRouteProps> = ({ 
  children, 
  requiredRole, 
  fallback 
}) => {
  const { isAuthenticated, isLoading, checkPermission } = useAuth();

  if (isLoading) {
    return (
      <div className="min-h-screen flex items-center justify-center">
        <div className="animate-spin rounded-full h-32 w-32 border-b-2 border-blue-600"></div>
      </div>
    );
  }

  if (!isAuthenticated) {
    return <LoginForm onLoginSuccess={() => {}} onLoginError={() => {}} />;
  }

  if (requiredRole && !checkPermission(requiredRole)) {
    return fallback || (
      <div className="min-h-screen flex items-center justify-center">
        <div className="text-center">
          <h2 className="text-2xl font-bold text-gray-900 mb-4">访问被拒绝</h2>
          <p className="text-gray-600">您没有访问此页面的权限</p>
        </div>
      </div>
    );
  }

  return <>{children}</>;
};
```

### 1.4 认证服务函数

#### 1.4.1 认证API模拟
```typescript
// src/services/authService.ts
interface AuthResponse {
  user: User;
  token: string;
  expiresAt: Date;
}

// 模拟用户数据库
const MOCK_USERS: Array<User & { password: string; token: string }> = [
  {
    id: 'user-001',
    name: '张采购',
    email: 'zhang@company.com',
    password: '123456',
    role: 'purchasing_officer',
    department: '采购部',
    isActive: true,
    createdAt: new Date('2024-01-01'),
    token: 'token-zhang-001'
  },
  {
    id: 'user-002',
    name: '李主管',
    email: 'li@company.com',
    password: '123456',
    role: 'department_manager',
    department: '采购部',
    isActive: true,
    createdAt: new Date('2024-01-01'),
    token: 'token-li-002'
  },
  {
    id: 'user-003',
    name: '王总经理',
    email: 'wang@company.com',
    password: '123456',
    role: 'general_manager',
    department: '管理层',
    isActive: true,
    createdAt: new Date('2024-01-01'),
    token: 'token-wang-003'
  },
  // 更多用户角色...
  {
    id: 'user-004',
    name: '赵设计',
    email: 'zhao@company.com',
    password: '123456',
    role: 'card_designer',
    department: '设计部',
    isActive: true,
    createdAt: new Date('2024-01-01'),
    token: 'token-zhao-004'
  },
  {
    id: 'user-005',
    name: '钱生产',
    email: 'qian@company.com',
    password: '123456',
    role: 'production_staff',
    department: '生产部',
    isActive: true,
    createdAt: new Date('2024-01-01'),
    token: 'token-qian-005'
  }
];

export const authenticateUser = async (email: string, password: string): Promise<AuthResponse> => {
  // 模拟网络延迟
  await new Promise(resolve => setTimeout(resolve, 1000));

  const user = MOCK_USERS.find(u => u.email === email && u.password === password);
  
  if (!user) {
    throw new Error('邮箱或密码错误');
  }

  if (!user.isActive) {
    throw new Error('账户已被禁用，请联系管理员');
  }

  const { password: _, ...userWithoutPassword } = user;
  
  return {
    user: userWithoutPassword,
    token: user.token,
    expiresAt: new Date(Date.now() + 24 * 60 * 60 * 1000) // 24小时后过期
  };
};

export const validateToken = async (token: string): Promise<boolean> => {
  // 模拟token验证
  await new Promise(resolve => setTimeout(resolve, 200));
  
  return MOCK_USERS.some(user => user.token === token);
};

export const fetchUserById = async (userId: string): Promise<User> => {
  await new Promise(resolve => setTimeout(resolve, 300));
  
  const user = MOCK_USERS.find(u => u.id === userId);
  if (!user) {
    throw new Error('用户不存在');
  }

  const { password: _, token: __, ...userWithoutSensitiveData } = user;
  return userWithoutSensitiveData;
};

// 权限检查辅助函数
export const hasPermission = (userRole: UserRole, requiredRole: UserRole | UserRole[]): boolean => {
  const roles = Array.isArray(requiredRole) ? requiredRole : [requiredRole];
  return roles.includes(userRole);
};

// 角色层级定义（用于权限继承）
export const ROLE_HIERARCHY: Record<UserRole, number> = {
  'general_manager': 10,      // 最高权限
  'department_manager': 8,    // 部门管理权限
  'purchasing_officer': 6,    // 采购专员权限
  'finance_personnel': 6,     // 财务人员权限
  'warehouse_staff': 5,       // 仓管权限
  'logistics_staff': 5,       // 物流权限
  'production_staff': 4,      // 生产权限
  'card_designer': 4,         // 设计权限
  'accessory_staff': 4,       // 辅料权限
  'qc_officer': 4,           // 质检权限
};

export const hasRolePermission = (userRole: UserRole, minimumRole: UserRole): boolean => {
  return ROLE_HIERARCHY[userRole] >= ROLE_HIERARCHY[minimumRole];
};

// 清除认证存储
export const clearAuthStorage = (): void => {
  localStorage.removeItem('authToken');
  localStorage.removeItem('userData');
  sessionStorage.removeItem('authToken');
  sessionStorage.removeItem('userData');
};

// 邮箱格式验证
export const isValidEmail = (email: string): boolean => {
  const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  return emailRegex.test(email);
};
```

---

## 🗄️ 2. 全局状态管理 (`store/`)

### 2.1 模块概述
基于Zustand的全局状态管理，提供类型安全的状态更新和持久化功能。

### 2.2 核心Store设计

#### 2.2.1 全局Store结构
```typescript
// src/store/globalStore.ts
import { create } from 'zustand';
import { subscribeWithSelector } from 'zustand/middleware';
import { persist } from 'zustand/middleware';

// 全局状态接口定义
interface GlobalStoreState {
  // === 用户管理 ===
  user: User | null;
  setUser: (user: User | null) => void;
  
  // === 采购申请管理 ===
  purchaseRequests: PurchaseRequest[];
  setPurchaseRequests: (requests: PurchaseRequest[]) => void;
  addPurchaseRequest: (request: PurchaseRequest) => void;
  updatePurchaseRequest: (id: string, updates: Partial<PurchaseRequest>) => void;
  deletePurchaseRequest: (id: string) => void;
  
  // === 订单分配管理 ===
  orderAllocations: OrderAllocation[];
  setOrderAllocations: (allocations: OrderAllocation[]) => void;
  addOrderAllocation: (allocation: OrderAllocation) => void;
  updateOrderAllocation: (id: string, updates: Partial<OrderAllocation>) => void;
  
  // === 采购进度管理 ===
  procurementProgress: ProcurementProgress[];
  setProcurementProgress: (progress: ProcurementProgress[]) => void;
  addProcurementProgress: (progress: ProcurementProgress) => void;
  updateProcurementProgress: (id: string, updates: Partial<ProcurementProgress>) => void;
  
  // === 纸卡进度管理 ===
  cardProgress: CardProgress[];
  setCardProgress: (progress: CardProgress[]) => void;
  addCardProgress: (progress: CardProgress) => void;
  updateCardProgress: (id: string, updates: Partial<CardProgress>) => void;
  
  // === 辅料进度管理 ===
  accessoryProgress: AccessoryProgress[];
  setAccessoryProgress: (progress: AccessoryProgress[]) => void;
  addAccessoryProgress: (progress: AccessoryProgress) => void;
  updateAccessoryProgress: (id: string, updates: Partial<AccessoryProgress>) => void;
  
  // === 到货检验管理 ===
  arrivalInspections: ArrivalInspection[];
  setArrivalInspections: (inspections: ArrivalInspection[]) => void;
  addArrivalInspection: (inspection: ArrivalInspection) => void;
  updateArrivalInspection: (id: string, updates: Partial<ArrivalInspection>) => void;
  
  // === 生产排单管理 ===
  productionSchedules: ProductionSchedule[];
  setProductionSchedules: (schedules: ProductionSchedule[]) => void;
  addProductionSchedule: (schedule: ProductionSchedule) => void;
  updateProductionSchedule: (id: string, updates: Partial<ProductionSchedule>) => void;
  
  // === 入库登记管理 ===
  inboundRegisters: InboundRegisterRecord[];
  setInboundRegisters: (registers: InboundRegisterRecord[]) => void;
  addInboundRegister: (register: InboundRegisterRecord) => void;
  updateInboundRegister: (id: string, updates: Partial<InboundRegisterRecord>) => void;
  
  // === 质检管理 ===
  qualityControlRecords: QualityControlRecord[];
  setQualityControlRecords: (records: QualityControlRecord[]) => void;
  addQualityControlRecord: (record: QualityControlRecord) => void;
  updateQualityControlRecord: (id: string, updates: Partial<QualityControlRecord>) => void;
  
  // === 不合格订单管理 ===
  rejectedOrders: RejectedOrder[];
  setRejectedOrders: (orders: RejectedOrder[]) => void;
  addRejectedOrder: (order: RejectedOrder) => void;
  updateRejectedOrder: (id: string, updates: Partial<RejectedOrder>) => void;
  
  // === 发货管理 ===
  shipments: Shipment[];
  setShipments: (shipments: Shipment[]) => void;
  addShipment: (shipment: Shipment) => void;
  updateShipment: (id: string, updates: Partial<Shipment>) => void;
  
  // === 库存管理 ===
  inventory: InventoryItem[];
  setInventory: (items: InventoryItem[]) => void;
  addInventoryItem: (item: InventoryItem) => void;
  updateInventoryItem: (id: string, updates: Partial<InventoryItem>) => void;
  
  // === 通用操作 ===
  resetStore: () => void;
  initializeStore: () => Promise<void>;
}

// 创建全局Store
export const useGlobalStore = create<GlobalStoreState>()(
  subscribeWithSelector(
    persist(
      (set, get) => ({
        // === 初始状态 ===
        user: null,
        purchaseRequests: [],
        orderAllocations: [],
        procurementProgress: [],
        cardProgress: [],
        accessoryProgress: [],
        arrivalInspections: [],
        productionSchedules: [],
        inboundRegisters: [],
        qualityControlRecords: [],
        rejectedOrders: [],
        shipments: [],
        inventory: [],

        // === 用户管理操作 ===
        setUser: (user) => set({ user }),

        // === 采购申请操作 ===
        setPurchaseRequests: (requests) => set({ purchaseRequests: requests }),
        
        addPurchaseRequest: (request) => set((state) => ({
          purchaseRequests: [...state.purchaseRequests, request]
        })),
        
        updatePurchaseRequest: (id, updates) => set((state) => ({
          purchaseRequests: state.purchaseRequests.map(req =>
            req.id === id ? { ...req, ...updates, updatedAt: new Date() } : req
          )
        })),
        
        deletePurchaseRequest: (id) => set((state) => ({
          purchaseRequests: state.purchaseRequests.filter(req => req.id !== id)
        })),

        // === 订单分配操作 ===
        setOrderAllocations: (allocations) => set({ orderAllocations: allocations }),
        
        addOrderAllocation: (allocation) => set((state) => ({
          orderAllocations: [...state.orderAllocations, allocation]
        })),
        
        updateOrderAllocation: (id, updates) => set((state) => ({
          orderAllocations: state.orderAllocations.map(alloc =>
            alloc.id === id ? { ...alloc, ...updates, updatedAt: new Date() } : alloc
          )
        })),

        // === 采购进度操作 ===
        setProcurementProgress: (progress) => set({ procurementProgress: progress }),
        
        addProcurementProgress: (progress) => set((state) => {
          // 检查是否已存在相同的进度记录
          const existingIndex = state.procurementProgress.findIndex(
            p => p.purchaseRequestId === progress.purchaseRequestId
          );
          
          if (existingIndex >= 0) {
            // 更新已存在的记录
            const updated = [...state.procurementProgress];
            updated[existingIndex] = { ...updated[existingIndex], ...progress };
            return { procurementProgress: updated };
          } else {
            // 添加新记录
            return { procurementProgress: [...state.procurementProgress, progress] };
          }
        }),
        
        updateProcurementProgress: (id, updates) => set((state) => ({
          procurementProgress: state.procurementProgress.map(prog =>
            prog.id === id ? { ...prog, ...updates, updatedAt: new Date() } : prog
          )
        })),

        // === 纸卡进度操作 ===
        setCardProgress: (progress) => set({ cardProgress: progress }),
        
        addCardProgress: (progress) => set((state) => ({
          cardProgress: [...state.cardProgress, progress]
        })),
        
        updateCardProgress: (id, updates) => set((state) => ({
          cardProgress: state.cardProgress.map(prog =>
            prog.id === id ? { ...prog, ...updates, updatedAt: new Date() } : prog
          )
        })),

        // === 辅料进度操作 ===
        setAccessoryProgress: (progress) => set({ accessoryProgress: progress }),
        
        addAccessoryProgress: (progress) => set((state) => ({
          accessoryProgress: [...state.accessoryProgress, progress]
        })),
        
        updateAccessoryProgress: (id, updates) => set((state) => ({
          accessoryProgress: state.accessoryProgress.map(prog =>
            prog.id === id ? { ...prog, ...updates, updatedAt: new Date() } : prog
          )
        })),

        // === 到货检验操作 ===
        setArrivalInspections: (inspections) => set({ arrivalInspections: inspections }),
        
        addArrivalInspection: (inspection) => set((state) => ({
          arrivalInspections: [...state.arrivalInspections, inspection]
        })),
        
        updateArrivalInspection: (id, updates) => set((state) => ({
          arrivalInspections: state.arrivalInspections.map(insp =>
            insp.id === id ? { ...insp, ...updates, updatedAt: new Date() } : insp
          )
        })),

        // === 生产排单操作 ===
        setProductionSchedules: (schedules) => set({ productionSchedules: schedules }),
        
        addProductionSchedule: (schedule) => set((state) => ({
          productionSchedules: [...state.productionSchedules, schedule]
        })),
        
        updateProductionSchedule: (id, updates) => set((state) => ({
          productionSchedules: state.productionSchedules.map(sched =>
            sched.id === id ? { ...sched, ...updates, updatedAt: new Date() } : sched
          )
        })),

        // === 入库登记操作 ===
        setInboundRegisters: (registers) => set({ inboundRegisters: registers }),
        
        addInboundRegister: (register) => set((state) => {
          // 防止重复添加相同的入库记录
          const exists = state.inboundRegisters.some(
            r => r.purchaseRequestNumber === register.purchaseRequestNumber && 
                 r.skuId === register.skuId
          );
          
          if (!exists) {
            return { inboundRegisters: [...state.inboundRegisters, register] };
          }
          return state;
        }),
        
        updateInboundRegister: (id, updates) => set((state) => ({
          inboundRegisters: state.inboundRegisters.map(reg =>
            reg.id === id ? { ...reg, ...updates, updatedAt: new Date() } : reg
          )
        })),

        // === 质检操作 ===
        setQualityControlRecords: (records) => set({ qualityControlRecords: records }),
        
        addQualityControlRecord: (record) => set((state) => {
          // 防止重复添加
          const exists = state.qualityControlRecords.some(
            r => r.purchaseRequestNumber === record.purchaseRequestNumber && 
                 r.skuId === record.skuId
          );
          
          if (!exists) {
            return { qualityControlRecords: [...state.qualityControlRecords, record] };
          }
          return state;
        }),
        
        updateQualityControlRecord: (id, updates) => set((state) => ({
          qualityControlRecords: state.qualityControlRecords.map(rec =>
            rec.id === id ? { ...rec, ...updates, updatedAt: new Date() } : rec
          )
        })),

        // === 不合格订单操作（带持久化） ===
        setRejectedOrders: (orders) => {
          try {
            localStorage.setItem('rejectedOrders', JSON.stringify(orders));
          } catch (error) {
            console.error('Failed to persist rejected orders:', error);
          }
          set({ rejectedOrders: orders });
        },
        
        addRejectedOrder: (order) => set((state) => {
          const newOrders = [...state.rejectedOrders, order];
          try {
            localStorage.setItem('rejectedOrders', JSON.stringify(newOrders));
          } catch (error) {
            console.error('Failed to persist rejected orders:', error);
          }
          return { rejectedOrders: newOrders };
        }),
        
        updateRejectedOrder: (id, updates) => set((state) => {
          const newOrders = state.rejectedOrders.map(order =>
            order.id === id ? { ...order, ...updates } : order
          );
          try {
            localStorage.setItem('rejectedOrders', JSON.stringify(newOrders));
          } catch (error) {
            console.error('Failed to persist rejected orders:', error);
          }
          return { rejectedOrders: newOrders };
        }),

        // === 发货操作 ===
        setShipments: (shipments) => set({ shipments }),
        
        addShipment: (shipment) => set((state) => ({
          shipments: [...state.shipments, shipment]
        })),
        
        updateShipment: (id, updates) => set((state) => ({
          shipments: state.shipments.map(ship =>
            ship.id === id ? { ...ship, ...updates, updatedAt: new Date() } : ship
          )
        })),

        // === 库存操作 ===
        setInventory: (items) => set({ inventory: items }),
        
        addInventoryItem: (item) => set((state) => ({
          inventory: [...state.inventory, item]
        })),
        
        updateInventoryItem: (id, updates) => set((state) => ({
          inventory: state.inventory.map(item =>
            item.id === id ? { ...item, ...updates, updatedAt: new Date() } : item
          )
        })),

        // === 通用操作 ===
        resetStore: () => set({
          user: null,
          purchaseRequests: [],
          orderAllocations: [],
          procurementProgress: [],
          cardProgress: [],
          accessoryProgress: [],
          arrivalInspections: [],
          productionSchedules: [],
          inboundRegisters: [],
          qualityControlRecords: [],
          rejectedOrders: [],
          shipments: [],
          inventory: []
        }),

        initializeStore: async () => {
          try {
            // 从localStorage恢复不合格订单数据
            const storedRejectedOrders = localStorage.getItem('rejectedOrders');
            if (storedRejectedOrders) {
              const rejectedOrders = JSON.parse(storedRejectedOrders);
              set({ rejectedOrders });
            }

            // 这里可以添加其他数据的初始化逻辑
            // 比如从API加载基础数据等
            
          } catch (error) {
            console.error('Failed to initialize store:', error);
          }
        }
      }),
      {
        name: 'global-store',
        // 只持久化部分关键数据
        partialize: (state) => ({
          user: state.user,
          rejectedOrders: state.rejectedOrders
        })
      }
    )
  )
);

// Store操作的辅助hooks
export const useStoreActions = () => {
  const store = useGlobalStore();
  
  return {
    // 批量操作
    batchUpdatePurchaseRequests: (updates: Array<{ id: string; updates: Partial<PurchaseRequest> }>) => {
      updates.forEach(({ id, updates: itemUpdates }) => {
        store.updatePurchaseRequest(id, itemUpdates);
      });
    },
    
    // 级联删除操作
    cascadeDeletePurchaseRequest: (requestId: string) => {
      // 删除采购申请时，同时删除相关的进度记录
      store.deletePurchaseRequest(requestId);
      
      // 删除相关的分配记录
      const allocations = store.orderAllocations.filter(a => a.purchaseRequestId !== requestId);
      store.setOrderAllocations(allocations);
      
      // 删除相关的进度记录
      const progress = store.procurementProgress.filter(p => p.purchaseRequestId !== requestId);
      store.setProcurementProgress(progress);
      
      // 删除相关的纸卡进度
      const cardProgress = store.cardProgress.filter(c => c.purchaseRequestId !== requestId);
      store.setCardProgress(cardProgress);
      
      // 删除相关的辅料进度
      const accessoryProgress = store.accessoryProgress.filter(a => a.purchaseRequestId !== requestId);
      store.setAccessoryProgress(accessoryProgress);
    },
    
    // 状态同步操作
    syncProgressStates: (requestId: string) => {
      // 同步各个进度模块的状态
      const procurement = store.procurementProgress.find(p => p.purchaseRequestId === requestId);
      const card = store.cardProgress.filter(c => c.purchaseRequestId === requestId);
      const accessory = store.accessoryProgress.filter(a => a.purchaseRequestId === requestId);
      
      // 根据各模块状态更新采购申请的整体状态
      // 这里可以实现复杂的状态同步逻辑
    }
  };
};

// 选择器hooks（用于性能优化）
export const usePurchaseRequests = () => useGlobalStore(state => state.purchaseRequests);
export const useOrderAllocations = () => useGlobalStore(state => state.orderAllocations);
export const useProcurementProgress = () => useGlobalStore(state => state.procurementProgress);
export const useCardProgress = () => useGlobalStore(state => state.cardProgress);
export const useAccessoryProgress = () => useGlobalStore(state => state.accessoryProgress);
export const useArrivalInspections = () => useGlobalStore(state => state.arrivalInspections);
export const useProductionSchedules = () => useGlobalStore(state => state.productionSchedules);
export const useInboundRegisters = () => useGlobalStore(state => state.inboundRegisters);
export const useQualityControlRecords = () => useGlobalStore(state => state.qualityControlRecords);
export const useRejectedOrders = () => useGlobalStore(state => state.rejectedOrders);
export const useShipments = () => useGlobalStore(state => state.shipments);
export const useInventory = () => useGlobalStore(state => state.inventory);
```

### 2.3 专用Store模块

#### 2.3.1 质检Store (质量控制)
```typescript
// src/store/qualityControl.ts
export interface QualityControlRecord {
  id: string;
  purchaseRequestNumber: string;
  skuId: string;
  sku: SKU;
  expectedQuantity: number;
  receivedQuantity: number;
  inspectionStatus: QualityInspectionStatus;
  inspectionDate: Date | null;
  inspectorId: string | null;
  inspector: User | null;
  packageCount: number;
  totalPieces: number;
  piecesPerUnit: number;
  boxLength: number;
  boxWidth: number;
  boxHeight: number;
  unitWeight: number;
  totalQuantity: number | null;
  boxVolume: number | null;
  totalVolume: number | null;
  totalWeight: number | null;
  qualityIssues: string[];
  remarks: string;
  photos: InspectionPhoto[];
  createdAt: Date;
  updatedAt: Date;
}

export type QualityInspectionStatus = 
  | 'pending'       // 待验收
  | 'in_progress'   // 验收中
  | 'passed'        // 已通过
  | 'failed'        // 不合格
  | 'returned';     // 已退货

export interface InspectionPhoto {
  id: string;
  url: string;
  description?: string;
  uploadedAt: Date;
}

interface QualityControlState {
  records: QualityControlRecord[];
  setRecords: (records: QualityControlRecord[]) => void;
  addRecord: (record: QualityControlRecord) => void;
  updateRecord: (id: string, updates: Partial<QualityControlRecord>) => void;
  deleteRecord: (id: string) => void;
  
  // 筛选和查询
  getRecordsByStatus: (status: QualityInspectionStatus) => QualityControlRecord[];
  getRecordsByPurchaseRequest: (purchaseRequestNumber: string) => QualityControlRecord[];
  getRecordsBySKU: (skuId: string) => QualityControlRecord[];
  
  // 统计功能
  getInspectionStats: () => {
    total: number;
    pending: number;
    inProgress: number;
    passed: number;
    failed: number;
    returned: number;
  };
  
  // 批量操作
  batchUpdateStatus: (ids: string[], status: QualityInspectionStatus) => void;
  batchAssignInspector: (ids: string[], inspectorId: string) => void;
}

export const useQualityControlStore = create<QualityControlState>()((set, get) => ({
  records: [],
  
  setRecords: (records) => set({ records }),
  
  addRecord: (record) => set((state) => ({
    records: [...state.records, record]
  })),
  
  updateRecord: (id, updates) => set((state) => ({
    records: state.records.map(record =>
      record.id === id 
        ? { ...record, ...updates, updatedAt: new Date() }
        : record
    )
  })),
  
  deleteRecord: (id) => set((state) => ({
    records: state.records.filter(record => record.id !== id)
  })),
  
  getRecordsByStatus: (status) => {
    return get().records.filter(record => record.inspectionStatus === status);
  },
  
  getRecordsByPurchaseRequest: (purchaseRequestNumber) => {
    return get().records.filter(record => record.purchaseRequestNumber === purchaseRequestNumber);
  },
  
  getRecordsBySKU: (skuId) => {
    return get().records.filter(record => record.skuId === skuId);
  },
  
  getInspectionStats: () => {
    const records = get().records;
    return {
      total: records.length,
      pending: records.filter(r => r.inspectionStatus === 'pending').length,
      inProgress: records.filter(r => r.inspectionStatus === 'in_progress').length,
      passed: records.filter(r => r.inspectionStatus === 'passed').length,
      failed: records.filter(r => r.inspectionStatus === 'failed').length,
      returned: records.filter(r => r.inspectionStatus === 'returned').length,
    };
  },
  
  batchUpdateStatus: (ids, status) => set((state) => ({
    records: state.records.map(record =>
      ids.includes(record.id)
        ? { 
            ...record, 
            inspectionStatus: status,
            inspectionDate: status !== 'pending' ? new Date() : null,
            updatedAt: new Date()
          }
        : record
    )
  })),
  
  batchAssignInspector: (ids, inspectorId) => set((state) => ({
    records: state.records.map(record =>
      ids.includes(record.id)
        ? { ...record, inspectorId, updatedAt: new Date() }
        : record
    )
  }))
}));
```

---

## 📋 3. 类型定义系统 (`types/`)

### 3.1 模块概述
完整的TypeScript类型定义，确保整个系统的类型安全。

### 3.2 核心类型定义

#### 3.2.1 用户和权限类型
```typescript
// src/types/auth.ts
export interface User {
  id: string;
  name: string;
  email: string;
  role: UserRole;
  department?: string;
  isActive: boolean;
  avatar?: string;
  phone?: string;
  lastLoginAt?: Date;
  createdAt: Date;
  updatedAt?: Date;
}

export type UserRole = 
  | 'purchasing_officer'    // 采购专员
  | 'department_manager'    // 部门主管
  | 'general_manager'       // 总经理
  | 'card_designer'         // 纸卡设计人员
  | 'production_staff'      // 生产排单人员
  | 'warehouse_staff'       // 仓管人员
  | 'logistics_staff'       // 物流专员
  | 'finance_personnel'     // 财务人员
  | 'accessory_staff'       // 辅料人员
  | 'qc_officer'           // 质检专员
  | 'production_operator';  // 生产操作员

export interface Permission {
  id: string;
  name: string;
  code: string;
  description?: string;
  module: string;
  actions: PermissionAction[];
}

export type PermissionAction = 
  | 'create'    // 创建
  | 'read'      // 查看
  | 'update'    // 更新
  | 'delete'    // 删除
  | 'approve'   // 审批
  | 'assign'    // 分配
  | 'export';   // 导出

export interface RolePermission {
  role: UserRole;
  permissions: Permission[];
}
```

#### 3.2.2 产品和SKU类型
```typescript
// src/types/product.ts
export interface SKU {
  id: string;
  code: string;                    // SKU编码
  name: string;                    // 产品名称
  englishName?: string;            // 英文名称
  category: ProductCategory;       // 产品分类
  identificationCode: string;      // 识别码
  imageUrl?: string;              // 产品图片URL
  description?: string;           // 产品描述
  specifications?: ProductSpec[]; // 产品规格
  unit: string;                   // 单位
  weight?: number;                // 重量(g)
  dimensions?: Dimensions;        // 尺寸
  materials?: string[];           // 材料
  colors?: string[];              // 颜色选项
  packagingOptions?: PackagingOption[]; // 包装选项
  isActive: boolean;              // 是否启用
  createdAt: Date;
  updatedAt: Date;
}

export interface ProductCategory {
  id: string;
  name: string;
  code: string;
  parentId?: string;
  level: number;
  description?: string;
}

export interface ProductSpec {
  name: string;        // 规格名称（如：尺寸、重量）
  value: string;       // 规格值
  unit?: string;       // 单位
}

export interface Dimensions {
  length: number;      // 长度(mm)
  width: number;       // 宽度(mm)
  height: number;      // 高度(mm)
}

export interface PackagingOption {
  id: string;
  name: string;        // 包装名称
  type: PackagingType; // 包装类型
  description?: string;
  cost?: number;       // 包装成本
}

export type PackagingType = 
  | 'standard'         // 标准包装
  | 'premium'          // 精装包装
  | 'gift'            // 礼品包装
  | 'bulk'            // 散装
  | 'custom';         // 定制包装
```

#### 3.2.3 采购相关类型
```typescript
// src/types/procurement.ts
export interface PurchaseRequest {
  id: string;
  requestNumber: string;           // 申请单号
  requesterId: string;            // 申请人ID
  requester: User;                // 申请人信息
  items: PurchaseRequestItem[];   // 申请项目
  totalAmount: number;            // 总金额
  status: OrderStatus;            // 订单状态
  approvalStatus: ApprovalStatus; // 审批状态
  type?: PurchaseType;           // 采购类型
  priority: RequestPriority;      // 优先级
  deadline: Date;                 // 期望交期
  remarks?: string;               // 备注
  
  // 审批信息
  firstApproverId?: string;
  firstApprover?: User;
  firstApprovalDate?: Date;
  firstApprovalRemarks?: string;
  finalApproverId?: string;
  finalApprover?: User;
  finalApprovalDate?: Date;
  finalApprovalRemarks?: string;
  
  // 系统字段
  createdAt: Date;
  updatedAt: Date;
  version: number;                // 版本号（用于乐观锁）
}

export interface PurchaseRequestItem {
  id: string;
  skuId: string;
  sku: SKU;
  quantity: number;               // 申请数量
  unitPrice?: number;             // 单价
  totalPrice?: number;            // 总价
  urgency: ItemUrgency;           // 紧急程度
  remarks?: string;               // 备注
  status: ItemStatus;             // 项目状态
  
  // 产品特定信息
  material?: string;              // 材料要求
  packagingMethod?: string;       // 包装方式
  specifications?: ItemSpec[];    // 规格要求
  
  // 供应商信息（分配后填入）
  supplierId?: string;
  supplier?: Supplier;
  estimatedCost?: number;         // 预估成本
  deliveryDate?: Date;            // 期望交货日期
  
  // 系统字段
  createdAt: Date;
  updatedAt: Date;
}

export interface ItemSpec {
  name: string;
  value: string;
  required: boolean;
}

export type OrderStatus = 
  | 'draft'             // 草稿
  | 'submitted'         // 已提交
  | 'first_approved'    // 一级审批通过
  | 'approved'          // 已批准
  | 'allocated'         // 已分配
  | 'rejected'          // 已拒绝
  | 'in_production'     // 生产中
  | 'quality_check'     // 质检中
  | 'ready_to_ship'     // 待发货
  | 'shipped'           // 已发货
  | 'completed'         // 已完成
  | 'cancelled';        // 已取消

export type ApprovalStatus = 
  | 'pending'           // 待审批
  | 'first_approved'    // 一级审批通过
  | 'approved'          // 最终审批通过
  | 'rejected';         // 已拒绝

export type PurchaseType = 
  | 'external'          // 厂家包装
  | 'in_house';         // 自己包装

export type RequestPriority = 
  | 'low'               // 低优先级
  | 'normal'            // 普通
  | 'high'              // 高优先级
  | 'urgent';           // 紧急

export type ItemUrgency = 
  | 'normal'            // 正常
  | 'urgent'            // 紧急
  | 'critical';         // 关键

export type ItemStatus = 
  | 'pending'           // 待定
  | 'approved'          // 已批准
  | 'rejected'          // 已拒绝
  | 'in_progress'       // 进行中
  | 'completed'         // 已完成
  | 'shipped'           // 已出货
  | 'received'          // 已收货
  | 'cancelled';        // 已取消
```

#### 3.2.4 订单分配类型
```typescript
// src/types/allocation.ts
export interface OrderAllocation {
  id: string;
  purchaseRequestId: string;      // 采购申请ID
  type: PurchaseType;             // 包装类型
  paymentMethod: PaymentMethod;   // 付款方式
  prepaymentAmount?: number;      // 预付定金金额
  creditDate?: Date;              // 账期日期
  productionDate: Date;           // 生产日期
  deliveryDate: Date;             // 交货日期
  allocationStatus: AllocationStatus; // 分配状态
  allocatedBy: string;            // 分配人ID
  allocatedAt: Date;              // 分配时间
  
  // 纸卡相关
  cardType?: CardType;            // 纸卡类型
  cardRequirements?: CardRequirement[]; // 纸卡要求
  
  // 供应商相关
  suppliers: AllocationSupplier[]; // 供应商分配
  
  // 备注和附件
  remarks?: string;
  attachments?: Attachment[];
  
  // 系统字段
  createdAt: Date;
  updatedAt: Date;
}

export interface AllocationSupplier {
  skuId: string;
  supplierId: string;
  supplier: Supplier;
  allocatedQuantity: number;
  unitPrice: number;
  totalPrice: number;
  deliveryDate: Date;
  remarks?: string;
}

export interface CardRequirement {
  id: string;
  type: CardType;
  description: string;
  deadline: Date;
  designerId?: string;
  designer?: User;
  status: CardStatus;
  attachments?: Attachment[];
}

export type AllocationStatus = 
  | 'pending'           // 待分配
  | 'allocated'         // 已分配
  | 'in_production'     // 待生产
  | 'production_scheduled' // 已排产
  | 'pending_receipt'   // 待收货
  | 'received'          // 已收货
  | 'pending_shipment'  // 待发货
  | 'shipped';          // 已发货

export type PaymentMethod = 
  | 'payment_on_delivery'  // 付款发货
  | 'cash_on_delivery'     // 货到付款
  | 'credit_terms'         // 账期
  | 'advance_payment';     // 预付款

export type CardType =
  | 'finished'          // 纸卡成品
  | 'design'            // 设计稿
  | 'none'              // 不需要
  | 'custom';           // 定制

export type CardStatus = 
  | 'pending'           // 待设计
  | 'designing'         // 设计中
  | 'review'            // 待审核
  | 'approved'          // 已批准
  | 'production'        // 生产中
  | 'completed';        // 已完成

export interface Attachment {
  id: string;
  name: string;
  url: string;
  type: string;
  size: number;
  uploadedAt: Date;
  uploadedBy: string;
}
```

---

**第一批文档已完成！**

这是基础架构的详细技术规格，包含：

✅ **认证系统**：完整的登录、权限验证、角色管理
✅ **状态管理**：基于Zustand的全局状态，包含所有业务数据
✅ **类型系统**：详细的TypeScript接口定义
✅ **持久化**：localStorage集成和数据恢复

**接下来需要编写哪一批？**

1. **第二批：采购核心流程** - 仪表板、采购申请、审批、分配
2. **第三批：进度跟踪系统** - 各种进度管理模块
3. **第四批：生产与仓储** - 生产、入库、质检、发货
4. **第五批：管理与支持** - 财务、库存、供应商、报表

请告诉我继续哪一批，我会为你写出同样详细的技术文档！

# 一家百货采购管理系统 - 第三批：进度跟踪系统详细需求文档

## 📋 文档信息
- **文档版本**: v1.0
- **编写日期**: 2025年8月11日
- **适用范围**: 进度跟踪和监控模块
- **依赖关系**: 第一批基础架构模块、第二批采购核心流程模块

---

## 📈 1. 采购进度管理 (`purchase-progress/`)

### 1.1 模块概述
采购进度管理是系统的核心监控模块，提供采购申请从审批到收货的全流程跟踪，包括不合格订单的处理流程。

### 1.2 组件架构

#### 1.2.1 PurchaseProgress 主组件
```typescript
// src/components/purchase-progress/PurchaseProgress.tsx
interface PurchaseProgressProps {
  filters?: ProgressFilters;
}

interface ProgressFilters {
  status?: OrderStatus[];
  dateRange?: DateRange;
  supplier?: string;
  priority?: RequestPriority[];
  searchTerm?: string;
}

interface TabData {
  key: string;
  label: string;
  count: number;
  color: string;
}

const PurchaseProgress: React.FC<PurchaseProgressProps> = ({ filters }) => {
  const [activeTab, setActiveTab] = useState<string>('all');
  const [progressData, setProgressData] = useState<ProcurementProgress[]>([]);
  const [rejectedOrders, setRejectedOrders] = useState<RejectedOrder[]>([]);
  const [isLoading, setIsLoading] = useState(true);
  const [selectedOrders, setSelectedOrders] = useState<string[]>([]);

  // 全局状态
  const globalProgress = useProcurementProgress();
  const globalRejectedOrders = useRejectedOrders();
  const { updateProcurementProgress, updateRejectedOrder } = useGlobalStore();

  // 监听全局状态变化
  useEffect(() => {
    setProgressData(globalProgress);
    setRejectedOrders(globalRejectedOrders);
    setIsLoading(false);
  }, [globalProgress, globalRejectedOrders]);

  // 监听不合格订单事件
  useEffect(() => {
    const handleRejectedOrderEvent = (event: CustomEvent<RejectedOrder>) => {
      console.log('🎯 采购进度页面收到不合格订单事件:', event.detail);
      
      // 添加到不合格订单列表
      const newOrder = event.detail;
      setRejectedOrders(prev => {
        const exists = prev.some(order => 
          order.purchaseRequestId === newOrder.purchaseRequestId && 
          order.skuId === newOrder.skuId
        );
        
        if (!exists) {
          const updated = [...prev, newOrder];
          // 持久化到localStorage
          try {
            localStorage.setItem('rejectedOrders', JSON.stringify(updated));
          } catch (error) {
            console.error('Failed to persist rejected orders:', error);
          }
          return updated;
        }
        return prev;
      });

      // 自动切换到不合格订单标签页
      setActiveTab('rejected');
      
      // 显示通知
      toast.warning(`收到不合格订单：${newOrder.sku?.name || '未知产品'}`, {
        duration: 5000,
        action: {
          label: '查看详情',
          onClick: () => setActiveTab('rejected')
        }
      });
    };

    // 监听不合格订单事件
    window.addEventListener('rejectedOrderAdded', handleRejectedOrderEvent as EventListener);

    // 页面加载时从localStorage恢复数据
    try {
      const storedRejectedOrders = localStorage.getItem('rejectedOrders');
      if (storedRejectedOrders) {
        const orders = JSON.parse(storedRejectedOrders);
        setRejectedOrders(orders);
        console.log('📦 从localStorage恢复不合格订单数据:', orders.length, '条');
      }
    } catch (error) {
      console.error('Failed to restore rejected orders from localStorage:', error);
    }

    return () => {
      window.removeEventListener('rejectedOrderAdded', handleRejectedOrderEvent as EventListener);
    };
  }, []);

  // 计算标签页数据
  const tabData: TabData[] = useMemo(() => {
    const allCount = progressData.length;
    const pendingCount = progressData.filter(p => p.status === 'pending').length;
    const inProgressCount = progressData.filter(p => 
      ['allocated', 'in_production', 'quality_check'].includes(p.status)
    ).length;
    const completedCount = progressData.filter(p => p.status === 'completed').length;
    const rejectedCount = rejectedOrders.length;

    return [
      { key: 'all', label: '全部订单', count: allCount, color: 'blue' },
      { key: 'pending', label: '待处理', count: pendingCount, color: 'yellow' },
      { key: 'in_progress', label: '进行中', count: inProgressCount, color: 'blue' },
      { key: 'completed', label: '已完成', count: completedCount, color: 'green' },
      { key: 'rejected', label: '不合格订单', count: rejectedCount, color: 'red' }
    ];
  }, [progressData, rejectedOrders]);

  // 根据当前标签页过滤数据
  const filteredData = useMemo(() => {
    let filtered = [...progressData];

    switch (activeTab) {
      case 'pending':
        filtered = filtered.filter(p => p.status === 'pending');
        break;
      case 'in_progress':
        filtered = filtered.filter(p => 
          ['allocated', 'in_production', 'quality_check'].includes(p.status)
        );
        break;
      case 'completed':
        filtered = filtered.filter(p => p.status === 'completed');
        break;
      case 'rejected':
        // 不合格订单标签页返回空数组，因为显示的是rejectedOrders
        return [];
      default:
        // 'all' 标签页显示所有数据
        break;
    }

    // 应用额外的筛选条件
    if (filters) {
      if (filters.status && filters.status.length > 0) {
        filtered = filtered.filter(p => filters.status!.includes(p.status));
      }
      
      if (filters.searchTerm) {
        const searchLower = filters.searchTerm.toLowerCase();
        filtered = filtered.filter(p =>
          p.purchaseRequestNumber.toLowerCase().includes(searchLower) ||
          p.items?.some(item => 
            item.sku?.name?.toLowerCase().includes(searchLower) ||
            item.sku?.code?.toLowerCase().includes(searchLower)
          )
        );
      }
    }

    return filtered;
  }, [progressData, rejectedOrders, activeTab, filters]);

  // 处理不合格订单的重新检验
  const handleReinspection = async (orderId: string) => {
    try {
      const order = rejectedOrders.find(o => o.id === orderId);
      if (!order) return;

      // 更新订单状态为重新检验中
      const updatedOrder = {
        ...order,
        status: 'reinspection' as RejectedOrderStatus,
        reinspectionDate: new Date(),
        updatedAt: new Date()
      };

      updateRejectedOrder(orderId, updatedOrder);
      
      toast.success('已安排重新检验');
    } catch (error) {
      console.error('Failed to arrange reinspection:', error);
      toast.error('安排重新检验失败');
    }
  };

  // 处理不合格订单的退货
  const handleReturn = async (orderId: string, returnReason: string) => {
    try {
      const order = rejectedOrders.find(o => o.id === orderId);
      if (!order) return;

      // 更新订单状态为已退货
      const updatedOrder = {
        ...order,
        status: 'returned' as RejectedOrderStatus,
        returnReason,
        returnDate: new Date(),
        updatedAt: new Date()
      };

      updateRejectedOrder(orderId, updatedOrder);
      
      toast.success('退货处理完成');
    } catch (error) {
      console.error('Failed to process return:', error);
      toast.error('退货处理失败');
    }
  };

  if (isLoading) {
    return (
      <div className="min-h-screen bg-gray-50 flex items-center justify-center">
        <div className="animate-spin rounded-full h-32 w-32 border-b-2 border-blue-600"></div>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-gray-50">
      {/* 页面标题 */}
      <div className="bg-white shadow">
        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
          <div className="py-6">
            <div className="flex items-center justify-between">
              <div>
                <h1 className="text-3xl font-bold text-gray-900">采购进度管理</h1>
                <p className="mt-1 text-sm text-gray-500">
                  跟踪和管理采购订单的执行进度
                </p>
              </div>
              
              {/* 快速操作按钮 */}
              <div className="flex items-center space-x-4">
                <button
                  onClick={() => window.location.reload()}
                  className="inline-flex items-center px-4 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
                >
                  <RefreshIcon className="h-4 w-4 mr-2" />
                  刷新
                </button>
                
                <button
                  onClick={() => {/* 导出逻辑 */}}
                  className="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
                >
                  <DownloadIcon className="h-4 w-4 mr-2" />
                  导出报表
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

      {/* 主要内容区域 */}
      <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        
        {/* 标签页导航 */}
        <div className="bg-white shadow rounded-lg mb-6">
          <div className="border-b border-gray-200">
            <nav className="-mb-px flex space-x-8 px-6" aria-label="Tabs">
              {tabData.map((tab) => (
                <button
                  key={tab.key}
                  onClick={() => setActiveTab(tab.key)}
                  className={`
                    whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm
                    ${activeTab === tab.key
                      ? 'border-blue-500 text-blue-600'
                      : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'
                    }
                  `}
                >
                  {tab.label}
                  <span className={`
                    ml-2 inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium
                    ${activeTab === tab.key
                      ? `bg-blue-100 text-blue-800`
                      : 'bg-gray-100 text-gray-800'
                    }
                  `}>
                    {tab.count}
                  </span>
                </button>
              ))}
            </nav>
          </div>
        </div>

        {/* 内容区域 */}
        <div className="bg-white shadow rounded-lg">
          {activeTab === 'rejected' ? (
            // 不合格订单列表
            <RejectedOrdersList
              orders={rejectedOrders}
              onReinspection={handleReinspection}
              onReturn={handleReturn}
              selectedOrders={selectedOrders}
              onSelectionChange={setSelectedOrders}
            />
          ) : (
            // 正常采购进度列表
            <ProgressList
              data={filteredData}
              activeTab={activeTab}
              selectedOrders={selectedOrders}
              onSelectionChange={setSelectedOrders}
              onStatusUpdate={(id, status) => {
                updateProcurementProgress(id, { status, updatedAt: new Date() });
              }}
            />
          )}
        </div>

        {/* 批量操作面板 */}
        {selectedOrders.length > 0 && (
          <BatchOperationPanel
            selectedCount={selectedOrders.length}
            activeTab={activeTab}
            onClearSelection={() => setSelectedOrders([])}
            onBatchUpdate={(updates) => {
              // 实现批量更新逻辑
              selectedOrders.forEach(id => {
                if (activeTab === 'rejected') {
                  updateRejectedOrder(id, updates);
                } else {
                  updateProcurementProgress(id, updates);
                }
              });
              setSelectedOrders([]);
            }}
          />
        )}
      </div>
    </div>
  );
};

export default PurchaseProgress;
```

#### 1.2.2 RejectedOrdersList 不合格订单列表组件
```typescript
// src/components/purchase-progress/RejectedOrdersList.tsx
interface RejectedOrdersListProps {
  orders: RejectedOrder[];
  onReinspection: (orderId: string) => void;
  onReturn: (orderId: string, reason: string) => void;
  selectedOrders: string[];
  onSelectionChange: (selected: string[]) => void;
}

const RejectedOrdersList: React.FC<RejectedOrdersListProps> = ({
  orders,
  onReinspection,
  onReturn,
  selectedOrders,
  onSelectionChange
}) => {
  const [showReturnModal, setShowReturnModal] = useState<string | null>(null);
  const [returnReason, setReturnReason] = useState('');

  const handleSelectOrder = (orderId: string, isSelected: boolean) => {
    if (isSelected) {
      onSelectionChange([...selectedOrders, orderId]);
    } else {
      onSelectionChange(selectedOrders.filter(id => id !== orderId));
    }
  };

  const handleSelectAll = (isSelected: boolean) => {
    if (isSelected) {
      onSelectionChange(orders.map(order => order.id));
    } else {
      onSelectionChange([]);
    }
  };

  const handleReturnSubmit = (orderId: string) => {
    if (!returnReason.trim()) {
      toast.error('请输入退货原因');
      return;
    }
    
    onReturn(orderId, returnReason);
    setShowReturnModal(null);
    setReturnReason('');
  };

  const getStatusBadge = (status: RejectedOrderStatus) => {
    const statusConfig = {
      rejected: { color: 'red', text: '不合格' },
      reinspection: { color: 'yellow', text: '重新检验中' },
      returned: { color: 'gray', text: '已退货' },
      resolved: { color: 'green', text: '已解决' }
    };

    const config = statusConfig[status] || statusConfig.rejected;
    
    return (
      <span className={`
        inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium
        bg-${config.color}-100 text-${config.color}-800
      `}>
        {config.text}
      </span>
    );
  };

  const getSeverityBadge = (severity: RejectionSeverity) => {
    const severityConfig = {
      minor: { color: 'yellow', text: '轻微', icon: '⚠️' },
      major: { color: 'orange', text: '严重', icon: '🚫' },
      critical: { color: 'red', text: '致命', icon: '💥' }
    };

    const config = severityConfig[severity];
    
    return (
      <span className={`
        inline-flex items-center space-x-1 px-2 py-1 rounded text-xs font-medium
        bg-${config.color}-100 text-${config.color}-800
      `}>
        <span>{config.icon}</span>
        <span>{config.text}</span>
      </span>
    );
  };

  if (orders.length === 0) {
    return (
      <div className="text-center py-12">
        <CheckCircleIcon className="mx-auto h-12 w-12 text-green-400" />
        <h3 className="mt-2 text-sm font-medium text-gray-900">暂无不合格订单</h3>
        <p className="mt-1 text-sm text-gray-500">
          所有订单质量检验都已通过
        </p>
      </div>
    );
  }

  return (
    <>
      <div className="px-6 py-4 border-b border-gray-200">
        <div className="flex items-center justify-between">
          <div className="flex items-center">
            <input
              type="checkbox"
              className="h-4 w-4 text-red-600 focus:ring-red-500 border-gray-300 rounded"
              checked={selectedOrders.length === orders.length && orders.length > 0}
              onChange={(e) => handleSelectAll(e.target.checked)}
            />
            <span className="ml-3 text-sm font-medium text-gray-900">
              全选
            </span>
          </div>
          <div className="text-sm text-gray-500">
            共 {orders.length} 个不合格订单
          </div>
        </div>
      </div>

      <div className="divide-y divide-gray-200">
        {orders.map((order) => (
          <div key={order.id} className="px-6 py-4 hover:bg-gray-50">
            <div className="flex items-start space-x-4">
              <input
                type="checkbox"
                className="mt-1 h-4 w-4 text-red-600 focus:ring-red-500 border-gray-300 rounded"
                checked={selectedOrders.includes(order.id)}
                onChange={(e) => handleSelectOrder(order.id, e.target.checked)}
              />
              
              <div className="flex-1 min-w-0">
                {/* 订单基本信息 */}
                <div className="flex items-center justify-between">
                  <div className="flex items-center space-x-3">
                    <h4 className="text-sm font-medium text-gray-900">
                      {order.sku?.name || '未知产品'}
                    </h4>
                    {getStatusBadge(order.status)}
                    {getSeverityBadge(order.severity)}
                  </div>
                  <div className="flex items-center space-x-4 text-sm text-gray-500">
                    <span>数量：{order.rejectedQuantity}</span>
                    <span>{formatDate(order.rejectionDate)}</span>
                  </div>
                </div>

                {/* 采购申请信息 */}
                <div className="mt-2 flex items-center space-x-4 text-sm text-gray-600">
                  <span>采购申请：{order.purchaseRequestNumber}</span>
                  <span>SKU：{order.sku?.code}</span>
                  {order.supplier && (
                    <span>供应商：{order.supplier.name}</span>
                  )}
                </div>

                {/* 不合格原因 */}
                <div className="mt-2">
                  <div className="text-sm text-gray-700">
                    <span className="font-medium text-red-600">不合格原因：</span>
                    {order.rejectionReason}
                  </div>
                  {order.inspectorRemarks && (
                    <div className="mt-1 text-sm text-gray-600">
                      <span className="font-medium">检验员备注：</span>
                      {order.inspectorRemarks}
                    </div>
                  )}
                </div>

                {/* 处理记录 */}
                {(order.reinspectionDate || order.returnDate) && (
                  <div className="mt-3 p-3 bg-gray-50 rounded-md">
                    <h5 className="text-xs font-medium text-gray-700 uppercase tracking-wide">
                      处理记录
                    </h5>
                    <div className="mt-2 space-y-1">
                      {order.reinspectionDate && (
                        <div className="text-sm text-gray-600">
                          重新检验：{formatDate(order.reinspectionDate)}
                        </div>
                      )}
                      {order.returnDate && (
                        <div className="text-sm text-gray-600">
                          退货处理：{formatDate(order.returnDate)}
                          {order.returnReason && (
                            <span className="ml-2 text-gray-500">
                              原因：{order.returnReason}
                            </span>
                          )}
                        </div>
                      )}
                    </div>
                  </div>
                )}

                {/* 质检照片 */}
                {order.inspectionPhotos && order.inspectionPhotos.length > 0 && (
                  <div className="mt-3">
                    <h5 className="text-xs font-medium text-gray-700 uppercase tracking-wide mb-2">
                      质检照片
                    </h5>
                    <div className="flex space-x-2">
                      {order.inspectionPhotos.slice(0, 3).map((photo) => (
                        <img
                          key={photo.id}
                          src={photo.url}
                          alt={photo.description || '质检照片'}
                          className="h-16 w-16 object-cover rounded border border-gray-200 cursor-pointer hover:opacity-75"
                          onClick={() => {/* 打开图片预览 */}}
                        />
                      ))}
                      {order.inspectionPhotos.length > 3 && (
                        <div className="h-16 w-16 bg-gray-100 rounded border border-gray-200 flex items-center justify-center text-xs text-gray-500">
                          +{order.inspectionPhotos.length - 3}
                        </div>
                      )}
                    </div>
                  </div>
                )}
              </div>

              {/* 操作按钮 */}
              <div className="flex flex-col space-y-2">
                {order.status === 'rejected' && (
                  <>
                    <button
                      onClick={() => onReinspection(order.id)}
                      className="inline-flex items-center px-3 py-2 border border-yellow-300 shadow-sm text-sm leading-4 font-medium rounded-md text-yellow-700 bg-yellow-50 hover:bg-yellow-100 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-yellow-500"
                    >
                      <RefreshIcon className="h-4 w-4 mr-1" />
                      重新检验
                    </button>
                    
                    <button
                      onClick={() => setShowReturnModal(order.id)}
                      className="inline-flex items-center px-3 py-2 border border-red-300 shadow-sm text-sm leading-4 font-medium rounded-md text-red-700 bg-red-50 hover:bg-red-100 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500"
                    >
                      <ReplyIcon className="h-4 w-4 mr-1" />
                      安排退货
                    </button>
                  </>
                )}
                
                <button
                  onClick={() => {/* 查看详情 */}}
                  className="inline-flex items-center px-3 py-2 border border-gray-300 shadow-sm text-sm leading-4 font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
                >
                  查看详情
                </button>
              </div>
            </div>
          </div>
        ))}
      </div>

      {/* 退货原因输入模态框 */}
      {showReturnModal && (
        <div className="fixed inset-0 z-50 overflow-y-auto">
          <div className="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
            <div className="fixed inset-0 transition-opacity" aria-hidden="true">
              <div className="absolute inset-0 bg-gray-500 opacity-75"></div>
            </div>

            <div className="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
              <div className="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                <div className="sm:flex sm:items-start">
                  <div className="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-red-100 sm:mx-0 sm:h-10 sm:w-10">
                    <ReplyIcon className="h-6 w-6 text-red-600" />
                  </div>
                  <div className="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left flex-1">
                    <h3 className="text-lg leading-6 font-medium text-gray-900">
                      安排退货
                    </h3>
                    <div className="mt-4">
                      <label htmlFor="return-reason" className="block text-sm font-medium text-gray-700">
                        退货原因 <span className="text-red-500">*</span>
                      </label>
                      <textarea
                        id="return-reason"
                        rows={4}
                        value={returnReason}
                        onChange={(e) => setReturnReason(e.target.value)}
                        className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-red-500 focus:border-red-500 sm:text-sm"
                        placeholder="请详细说明退货原因..."
                      />
                    </div>
                  </div>
                </div>
              </div>
              <div className="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                <button
                  type="button"
                  onClick={() => handleReturnSubmit(showReturnModal)}
                  className="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-red-600 text-base font-medium text-white hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 sm:ml-3 sm:w-auto sm:text-sm"
                >
                  确认退货
                </button>
                <button
                  type="button"
                  onClick={() => {
                    setShowReturnModal(null);
                    setReturnReason('');
                  }}
                  className="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm"
                >
                  取消
                </button>
              </div>
            </div>
          </div>
        </div>
      )}
    </>
  );
};
```

#### 1.2.3 ProgressList 进度列表组件
```typescript
// src/components/purchase-progress/ProgressList.tsx
interface ProgressListProps {
  data: ProcurementProgress[];
  activeTab: string;
  selectedOrders: string[];
  onSelectionChange: (selected: string[]) => void;
  onStatusUpdate: (id: string, status: OrderStatus) => void;
}

const ProgressList: React.FC<ProgressListProps> = ({
  data,
  activeTab,
  selectedOrders,
  onSelectionChange,
  onStatusUpdate
}) => {
  const [sortConfig, setSortConfig] = useState<SortConfig>({
    key: 'updatedAt',
    direction: 'desc'
  });

  // 排序数据
  const sortedData = useMemo(() => {
    return [...data].sort((a, b) => {
      const aValue = getNestedValue(a, sortConfig.key);
      const bValue = getNestedValue(b, sortConfig.key);
      
      if (aValue < bValue) {
        return sortConfig.direction === 'asc' ? -1 : 1;
      }
      if (aValue > bValue) {
        return sortConfig.direction === 'asc' ? 1 : -1;
      }
      return 0;
    });
  }, [data, sortConfig]);

  const handleSort = (key: string) => {
    setSortConfig(prev => ({
      key,
      direction: prev.key === key && prev.direction === 'asc' ? 'desc' : 'asc'
    }));
  };

  const handleSelectOrder = (orderId: string, isSelected: boolean) => {
    if (isSelected) {
      onSelectionChange([...selectedOrders, orderId]);
    } else {
      onSelectionChange(selectedOrders.filter(id => id !== orderId));
    }
  };

  const handleSelectAll = (isSelected: boolean) => {
    if (isSelected) {
      onSelectionChange(sortedData.map(item => item.id));
    } else {
      onSelectionChange([]);
    }
  };

  const getProgressPercentage = (progress: ProcurementProgress): number => {
    const statusWeights = {
      'pending': 0,
      'approved': 20,
      'allocated': 40,
      'in_production': 60,
      'quality_check': 80,
      'ready_to_ship': 90,
      'shipped': 95,
      'completed': 100,
      'cancelled': 0,
      'rejected': 0
    };
    
    return statusWeights[progress.status] || 0;
  };

  const getStatusColor = (status: OrderStatus): string => {
    const colors = {
      'pending': 'yellow',
      'approved': 'blue',
      'allocated': 'purple',
      'in_production': 'indigo',
      'quality_check': 'orange',
      'ready_to_ship': 'teal',
      'shipped': 'cyan',
      'completed': 'green',
      'cancelled': 'gray',
      'rejected': 'red'
    };
    
    return colors[status] || 'gray';
  };

  if (sortedData.length === 0) {
    return (
      <div className="text-center py-12">
        <ClipboardListIcon className="mx-auto h-12 w-12 text-gray-400" />
        <h3 className="mt-2 text-sm font-medium text-gray-900">暂无数据</h3>
        <p className="mt-1 text-sm text-gray-500">
          {activeTab === 'all' ? '还没有采购进度记录' : '当前筛选条件下没有数据'}
        </p>
      </div>
    );
  }

  return (
    <>
      {/* 表格标题 */}
      <div className="px-6 py-4 border-b border-gray-200 bg-gray-50">
        <div className="flex items-center justify-between">
          <div className="flex items-center">
            <input
              type="checkbox"
              className="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded"
              checked={selectedOrders.length === sortedData.length && sortedData.length > 0}
              onChange={(e) => handleSelectAll(e.target.checked)}
            />
            <span className="ml-3 text-sm font-medium text-gray-900">全选</span>
          </div>
          <div className="text-sm text-gray-500">
            共 {sortedData.length} 条记录
          </div>
        </div>
      </div>

      {/* 表格内容 */}
      <div className="divide-y divide-gray-200">
        {sortedData.map((progress) => (
          <div key={progress.id} className="px-6 py-4 hover:bg-gray-50">
            <div className="flex items-start space-x-4">
              <input
                type="checkbox"
                className="mt-1 h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded"
                checked={selectedOrders.includes(progress.id)}
                onChange={(e) => handleSelectOrder(progress.id, e.target.checked)}
              />
              
              <div className="flex-1 min-w-0">
                {/* 采购申请基本信息 */}
                <div className="flex items-center justify-between">
                  <div className="flex items-center space-x-3">
                    <h4 className="text-sm font-medium text-blue-600 hover:text-blue-900 cursor-pointer">
                      {progress.purchaseRequestNumber}
                    </h4>
                    <span className={`
                      inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium
                      bg-${getStatusColor(progress.status)}-100 text-${getStatusColor(progress.status)}-800
                    `}>
                      {getStatusText(progress.status)}
                    </span>
                  </div>
                  <div className="flex items-center space-x-4 text-sm text-gray-500">
                    <span>总金额：¥{progress.totalAmount?.toLocaleString()}</span>
                    <span>更新：{formatRelativeTime(progress.updatedAt)}</span>
                  </div>
                </div>

                {/* 进度条 */}
                <div className="mt-3">
                  <div className="flex items-center justify-between text-sm">
                    <span className="text-gray-600">进度</span>
                    <span className="font-medium">{getProgressPercentage(progress)}%</span>
                  </div>
                  <div className="mt-1 w-full bg-gray-200 rounded-full h-2">
                    <div
                      className={`h-2 rounded-full bg-${getStatusColor(progress.status)}-500`}
                      style={{ width: `${getProgressPercentage(progress)}%` }}
                    ></div>
                  </div>
                </div>

                {/* 项目列表预览 */}
                {progress.items && progress.items.length > 0 && (
                  <div className="mt-3">
                    <div className="text-xs font-medium text-gray-700 uppercase tracking-wide mb-2">
                      包含项目 ({progress.items.length})
                    </div>
                    <div className="space-y-2">
                      {progress.items.slice(0, 2).map((item, index) => (
                        <div key={index} className="flex items-center justify-between bg-gray-50 rounded px-3 py-2">
                          <div className="flex items-center space-x-3">
                            <span className="text-sm font-medium text-gray-900">
                              {item.sku?.name || '未知产品'}
                            </span>
                            <span className="text-xs text-gray-500">
                              {item.sku?.code}
                            </span>
                          </div>
                          <div className="text-sm text-gray-600">
                            数量：{item.quantity} | 单价：¥{item.unitPrice?.toLocaleString()}
                          </div>
                        </div>
                      ))}
                      {progress.items.length > 2 && (
                        <div className="text-center py-2">
                          <button className="text-xs text-blue-600 hover:text-blue-900">
                            查看全部 {progress.items.length} 个项目
                          </button>
                        </div>
                      )}
                    </div>
                  </div>
                )}

                {/* 供应商和交期信息 */}
                <div className="mt-3 grid grid-cols-1 sm:grid-cols-3 gap-4 text-sm">
                  {progress.supplier && (
                    <div>
                      <span className="font-medium text-gray-700">供应商：</span>
                      <span className="text-gray-600">{progress.supplier.name}</span>
                    </div>
                  )}
                  {progress.expectedDeliveryDate && (
                    <div>
                      <span className="font-medium text-gray-700">预计交期：</span>
                      <span className="text-gray-600">{formatDate(progress.expectedDeliveryDate)}</span>
                    </div>
                  )}
                  {progress.actualDeliveryDate && (
                    <div>
                      <span className="font-medium text-gray-700">实际交期：</span>
                      <span className="text-gray-600">{formatDate(progress.actualDeliveryDate)}</span>
                    </div>
                  )}
                </div>

                {/* 重要备注 */}
                {progress.remarks && (
                  <div className="mt-3 p-3 bg-yellow-50 border-l-4 border-yellow-400 rounded-r">
                    <div className="text-sm">
                      <span className="font-medium text-yellow-800">备注：</span>
                      <span className="text-yellow-700 ml-1">{progress.remarks}</span>
                    </div>
                  </div>
                )}
              </div>

              {/* 操作按钮 */}
              <div className="flex flex-col space-y-2">
                <button
                  onClick={() => {/* 查看详情 */}}
                  className="inline-flex items-center px-3 py-2 border border-gray-300 shadow-sm text-sm leading-4 font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
                >
                  查看详情
                </button>
                
                {progress.status === 'allocated' && (
                  <button
                    onClick={() => onStatusUpdate(progress.id, 'in_production')}
                    className="inline-flex items-center px-3 py-2 border border-transparent shadow-sm text-sm leading-4 font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
                  >
                    开始生产
                  </button>
                )}
                
                {progress.status === 'in_production' && (
                  <button
                    onClick={() => onStatusUpdate(progress.id, 'quality_check')}
                    className="inline-flex items-center px-3 py-2 border border-transparent shadow-sm text-sm leading-4 font-medium rounded-md text-white bg-orange-600 hover:bg-orange-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-orange-500"
                  >
                    质检验收
                  </button>
                )}
              </div>
            </div>
          </div>
        ))}
      </div>
    </>
  );
};

// 辅助函数
const getStatusText = (status: OrderStatus): string => {
  const statusTexts = {
    'pending': '待处理',
    'approved': '已批准',
    'allocated': '已分配',
    'in_production': '生产中',
    'quality_check': '质检中',
    'ready_to_ship': '待发货',
    'shipped': '已发货',
    'completed': '已完成',
    'cancelled': '已取消',
    'rejected': '已拒绝'
  };
  
  return statusTexts[status] || '未知状态';
};

const getNestedValue = (obj: any, path: string): any => {
  return path.split('.').reduce((current, key) => current?.[key], obj);
};
```

---

## 📋 2. 纸卡进度管理 (`card-progress/`)

### 2.1 模块概述
纸卡进度管理负责跟踪产品纸卡的设计、审核、生产等各个环节的进度。

### 2.2 组件架构

#### 2.2.1 CardProgress 主组件
```typescript
// src/components/card-progress/CardProgress.tsx
interface CardProgressProps {
  filters?: CardProgressFilters;
}

interface CardProgressFilters {
  status?: CardStatus[];
  designer?: string;
  cardType?: CardType[];
  dateRange?: DateRange;
  searchTerm?: string;
}

const CardProgress: React.FC<CardProgressProps> = ({ filters }) => {
  const [progressData, setProgressData] = useState<CardProgress[]>([]);
  const [isLoading, setIsLoading] = useState(true);
  const [selectedCards, setSelectedCards] = useState<string[]>([]);
  const [showDesignModal, setShowDesignModal] = useState<string | null>(null);

  // 全局状态
  const globalCardProgress = useCardProgress();
  const { updateCardProgress, addCardProgress } = useGlobalStore();

  useEffect(() => {
    setProgressData(globalCardProgress);
    setIsLoading(false);
  }, [globalCardProgress]);

  // 筛选数据
  const filteredData = useMemo(() => {
    let filtered = [...progressData];

    if (filters) {
      if (filters.status && filters.status.length > 0) {
        filtered = filtered.filter(card => filters.status!.includes(card.status));
      }

      if (filters.designer) {
        filtered = filtered.filter(card => card.designerId === filters.designer);
      }

      if (filters.cardType && filters.cardType.length > 0) {
        filtered = filtered.filter(card => filters.cardType!.includes(card.cardType));
      }

      if (filters.searchTerm) {
        const searchLower = filters.searchTerm.toLowerCase();
        filtered = filtered.filter(card =>
          card.purchaseRequestNumber.toLowerCase().includes(searchLower) ||
          card.skuName.toLowerCase().includes(searchLower)
        );
      }
    }

    return filtered;
  }, [progressData, filters]);

  // 分配设计师
  const handleAssignDesigner = async (cardId: string, designerId: string) => {
    try {
      updateCardProgress(cardId, {
        designerId,
        status: 'designing',
        assignedAt: new Date(),
        updatedAt: new Date()
      });
      
      toast.success('设计师分配成功');
    } catch (error) {
      console.error('Failed to assign designer:', error);
      toast.error('分配设计师失败');
    }
  };

  // 更新设计状态
  const handleStatusUpdate = async (cardId: string, newStatus: CardStatus, remarks?: string) => {
    try {
      const updates: Partial<CardProgress> = {
        status: newStatus,
        updatedAt: new Date()
      };

      // 根据状态添加相应的时间戳
      if (newStatus === 'designing') {
        updates.designStartDate = new Date();
      } else if (newStatus === 'review') {
        updates.designCompletedDate = new Date();
      } else if (newStatus === 'approved') {
        updates.approvedDate = new Date();
      } else if (newStatus === 'production') {
        updates.productionStartDate = new Date();
      } else if (newStatus === 'completed') {
        updates.completedDate = new Date();
      }

      if (remarks) {
        updates.remarks = remarks;
      }

      updateCardProgress(cardId, updates);
      
      toast.success('状态更新成功');
    } catch (error) {
      console.error('Failed to update status:', error);
      toast.error('状态更新失败');
    }
  };

  const getStatusBadge = (status: CardStatus) => {
    const statusConfig = {
      pending: { color: 'gray', text: '待分配' },
      designing: { color: 'blue', text: '设计中' },
      review: { color: 'yellow', text: '待审核' },
      approved: { color: 'green', text: '已批准' },
      production: { color: 'purple', text: '生产中' },
      completed: { color: 'emerald', text: '已完成' }
    };

    const config = statusConfig[status] || statusConfig.pending;
    
    return (
      <span className={`
        inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium
        bg-${config.color}-100 text-${config.color}-800
      `}>
        {config.text}
      </span>
    );
  };

  const getCardTypeBadge = (cardType: CardType) => {
    const typeConfig = {
      finished: { color: 'blue', text: '纸卡成品', icon: '🏷️' },
      design: { color: 'purple', text: '设计稿', icon: '🎨' },
      none: { color: 'gray', text: '不需要', icon: '❌' },
      custom: { color: 'yellow', text: '定制', icon: '✨' }
    };

    const config = typeConfig[cardType];
    
    return (
      <span className={`
        inline-flex items-center space-x-1 px-2 py-1 rounded text-xs font-medium
        bg-${config.color}-100 text-${config.color}-800
      `}>
        <span>{config.icon}</span>
        <span>{config.text}</span>
      </span>
    );
  };

  if (isLoading) {
    return (
      <div className="min-h-screen bg-gray-50 flex items-center justify-center">
        <div className="animate-spin rounded-full h-32 w-32 border-b-2 border-blue-600"></div>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-gray-50">
      {/* 页面标题 */}
      <div className="bg-white shadow">
        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
          <div className="py-6">
            <div className="flex items-center justify-between">
              <div>
                <h1 className="text-3xl font-bold text-gray-900">纸卡进度管理</h1>
                <p className="mt-1 text-sm text-gray-500">
                  管理产品纸卡的设计、审核和生产进度
                </p>
              </div>
              
              <div className="flex items-center space-x-4">
                <CardProgressStats data={filteredData} />
                
                <button
                  onClick={() => {/* 批量分配设计师 */}}
                  disabled={selectedCards.length === 0}
                  className="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:opacity-50"
                >
                  <UserAddIcon className="h-4 w-4 mr-2" />
                  批量分配设计师
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

      {/* 筛选器 */}
      <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
        <CardProgressFilters 
          filters={filters}
          onFiltersChange={(newFilters) => {/* 更新筛选条件 */}}
        />
      </div>

      {/* 主要内容 */}
      <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 pb-8">
        <div className="bg-white shadow rounded-lg">
          {/* 批量操作栏 */}
          {selectedCards.length > 0 && (
            <div className="bg-blue-50 px-4 py-3 border-b border-blue-200">
              <div className="flex items-center justify-between">
                <span className="text-sm font-medium text-blue-900">
                  已选择 {selectedCards.length} 个纸卡任务
                </span>
                <div className="flex items-center space-x-2">
                  <select
                    onChange={(e) => {
                      if (e.target.value) {
                        selectedCards.forEach(cardId => {
                          handleStatusUpdate(cardId, e.target.value as CardStatus);
                        });
                        setSelectedCards([]);
                      }
                    }}
                    className="block w-40 px-3 py-2 border border-blue-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                    defaultValue=""
                  >
                    <option value="" disabled>批量操作</option>
                    <option value="designing">开始设计</option>
                    <option value="review">提交审核</option>
                    <option value="approved">审核通过</option>
                    <option value="production">开始生产</option>
                  </select>
                  <button
                    onClick={() => setSelectedCards([])}
                    className="inline-flex items-center px-3 py-2 border border-blue-300 shadow-sm text-sm leading-4 font-medium rounded-md text-blue-700 bg-white hover:bg-blue-50"
                  >
                    取消选择
                  </button>
                </div>
              </div>
            </div>
          )}

          {/* 纸卡列表 */}
          <CardProgressList
            data={filteredData}
            selectedCards={selectedCards}
            onSelectionChange={setSelectedCards}
            onAssignDesigner={handleAssignDesigner}
            onStatusUpdate={handleStatusUpdate}
            onShowDesignModal={setShowDesignModal}
          />
        </div>
      </div>

      {/* 设计详情模态框 */}
      {showDesignModal && (
        <CardDesignModal
          cardId={showDesignModal}
          onClose={() => setShowDesignModal(null)}
          onStatusUpdate={handleStatusUpdate}
        />
      )}
    </div>
  );
};

export default CardProgress;
```

---

**第三批文档已完成！**

现在让我继续编写第四批：生产与仓储系统。继续第四批？

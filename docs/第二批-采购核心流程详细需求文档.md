# 一家百货采购管理系统 - 第二批：采购核心流程详细需求文档

## 📋 文档信息
- **文档版本**: v1.0
- **编写日期**: 2025年8月11日
- **适用范围**: 采购核心业务流程模块
- **依赖关系**: 第一批基础架构模块

---

## 📊 1. 仪表板系统 (`dashboard/`)

### 1.1 模块概述
系统首页仪表板，提供全局业务概览、关键指标监控和快速操作入口。

### 1.2 组件架构

#### 1.2.1 Dashboard 主组件
```typescript
// src/components/dashboard/Dashboard.tsx
interface DashboardProps {
  userRole: UserRole;
}

interface DashboardStats {
  purchaseRequests: {
    total: number;
    pending: number;
    approved: number;
    inProgress: number;
    completed: number;
  };
  allocations: {
    total: number;
    pending: number;
    allocated: number;
    inProduction: number;
  };
  quality: {
    total: number;
    passed: number;
    failed: number;
    pending: number;
  };
  financial: {
    totalValue: number;
    pendingPayments: number;
    monthlyBudget: number;
    usedBudget: number;
  };
}

const Dashboard: React.FC<DashboardProps> = ({ userRole }) => {
  const [stats, setStats] = useState<DashboardStats | null>(null);
  const [isLoading, setIsLoading] = useState(true);
  const [selectedTimeRange, setSelectedTimeRange] = useState<TimeRange>('month');
  const [refreshInterval, setRefreshInterval] = useState<NodeJS.Timeout | null>(null);

  // 全局状态
  const purchaseRequests = usePurchaseRequests();
  const orderAllocations = useOrderAllocations();
  const qualityRecords = useQualityControlRecords();
  const user = useGlobalStore(state => state.user);

  // 计算统计数据
  const calculateStats = useCallback((): DashboardStats => {
    const now = new Date();
    const timeRangeStart = getTimeRangeStart(selectedTimeRange, now);

    // 过滤时间范围内的数据
    const filteredRequests = purchaseRequests.filter(req => 
      req.createdAt >= timeRangeStart
    );
    const filteredAllocations = orderAllocations.filter(alloc => 
      alloc.createdAt >= timeRangeStart
    );
    const filteredQuality = qualityRecords.filter(record => 
      record.createdAt >= timeRangeStart
    );

    return {
      purchaseRequests: {
        total: filteredRequests.length,
        pending: filteredRequests.filter(r => r.status === 'submitted').length,
        approved: filteredRequests.filter(r => r.status === 'approved').length,
        inProgress: filteredRequests.filter(r => ['in_production', 'quality_check'].includes(r.status)).length,
        completed: filteredRequests.filter(r => r.status === 'completed').length,
      },
      allocations: {
        total: filteredAllocations.length,
        pending: filteredAllocations.filter(a => a.allocationStatus === 'pending').length,
        allocated: filteredAllocations.filter(a => a.allocationStatus === 'allocated').length,
        inProduction: filteredAllocations.filter(a => ['in_production', 'production_scheduled'].includes(a.allocationStatus)).length,
      },
      quality: {
        total: filteredQuality.length,
        passed: filteredQuality.filter(q => q.inspectionStatus === 'passed').length,
        failed: filteredQuality.filter(q => q.inspectionStatus === 'failed').length,
        pending: filteredQuality.filter(q => q.inspectionStatus === 'pending').length,
      },
      financial: {
        totalValue: filteredRequests.reduce((sum, req) => sum + (req.totalAmount || 0), 0),
        pendingPayments: filteredRequests
          .filter(req => req.status === 'approved' && !req.isPaid)
          .reduce((sum, req) => sum + (req.totalAmount || 0), 0),
        monthlyBudget: 1000000, // 模拟月度预算
        usedBudget: filteredRequests.reduce((sum, req) => sum + (req.totalAmount || 0), 0),
      }
    };
  }, [purchaseRequests, orderAllocations, qualityRecords, selectedTimeRange]);

  // 初始化和刷新数据
  useEffect(() => {
    const loadStats = async () => {
      setIsLoading(true);
      try {
        // 模拟API延迟
        await new Promise(resolve => setTimeout(resolve, 500));
        const newStats = calculateStats();
        setStats(newStats);
      } catch (error) {
        console.error('Failed to load dashboard stats:', error);
      } finally {
        setIsLoading(false);
      }
    };

    loadStats();

    // 设置自动刷新
    const interval = setInterval(loadStats, 30000); // 30秒刷新一次
    setRefreshInterval(interval);

    return () => {
      if (refreshInterval) clearInterval(refreshInterval);
    };
  }, [calculateStats]);

  // 权限检查
  const canViewFinancials = hasRolePermission(userRole, 'finance_personnel');
  const canManageProcurement = hasRolePermission(userRole, 'purchasing_officer');

  if (isLoading) {
    return (
      <div className="min-h-screen bg-gray-50 flex items-center justify-center">
        <div className="animate-spin rounded-full h-32 w-32 border-b-2 border-blue-600"></div>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-gray-50">
      {/* 页面标题栏 */}
      <div className="bg-white shadow">
        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
          <div className="py-6">
            <div className="flex items-center justify-between">
              <div>
                <h1 className="text-3xl font-bold text-gray-900">
                  采购管理仪表板
                </h1>
                <p className="mt-1 text-sm text-gray-500">
                  欢迎回来，{user?.name}！今天是 {formatDate(new Date(), 'YYYY年MM月DD日')}
                </p>
              </div>
              
              {/* 时间范围选择器 */}
              <div className="flex items-center space-x-4">
                <select
                  value={selectedTimeRange}
                  onChange={(e) => setSelectedTimeRange(e.target.value as TimeRange)}
                  className="block w-40 px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                >
                  <option value="week">本周</option>
                  <option value="month">本月</option>
                  <option value="quarter">本季度</option>
                  <option value="year">本年</option>
                </select>
                
                <button
                  onClick={() => setStats(calculateStats())}
                  className="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
                >
                  <RefreshIcon className="h-4 w-4 mr-2" />
                  刷新
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

      {/* 主要内容区域 */}
      <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        {/* 关键指标卡片 */}
        <div className="grid grid-cols-1 gap-6 sm:grid-cols-2 lg:grid-cols-4 mb-8">
          <StatsCard
            title="采购申请"
            value={stats?.purchaseRequests.total || 0}
            subtitle={`${stats?.purchaseRequests.pending || 0} 个待审批`}
            icon={<DocumentTextIcon className="h-6 w-6" />}
            color="blue"
            trend={{ value: 12, isPositive: true }}
          />
          
          <StatsCard
            title="订单分配"
            value={stats?.allocations.total || 0}
            subtitle={`${stats?.allocations.pending || 0} 个待分配`}
            icon={<ClipboardListIcon className="h-6 w-6" />}
            color="green"
            trend={{ value: 8, isPositive: true }}
          />
          
          <StatsCard
            title="质检通过率"
            value={`${calculatePassRate(stats?.quality)}%`}
            subtitle={`${stats?.quality.failed || 0} 个不合格`}
            icon={<CheckCircleIcon className="h-6 w-6" />}
            color="yellow"
            trend={{ value: 2, isPositive: false }}
          />
          
          {canViewFinancials && (
            <StatsCard
              title="采购金额"
              value={formatCurrency(stats?.financial.totalValue || 0)}
              subtitle={`预算使用率 ${calculateBudgetUsage(stats?.financial)}%`}
              icon={<CurrencyDollarIcon className="h-6 w-6" />}
              color="purple"
              trend={{ value: 15, isPositive: true }}
            />
          )}
        </div>

        {/* 图表和列表区域 */}
        <div className="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
          {/* 进度图表 */}
          <div className="bg-white overflow-hidden shadow rounded-lg">
            <div className="p-6">
              <h3 className="text-lg leading-6 font-medium text-gray-900 mb-4">
                采购进度概览
              </h3>
              <ProgressChart 
                data={stats} 
                timeRange={selectedTimeRange}
              />
            </div>
          </div>

          {/* 最近活动 */}
          <div className="bg-white overflow-hidden shadow rounded-lg">
            <div className="p-6">
              <h3 className="text-lg leading-6 font-medium text-gray-900 mb-4">
                最近活动
              </h3>
              <RecentActivity 
                userRole={userRole}
                limit={5}
              />
            </div>
          </div>
        </div>

        {/* 快速操作按钮 */}
        {canManageProcurement && (
          <div className="bg-white overflow-hidden shadow rounded-lg">
            <div className="p-6">
              <h3 className="text-lg leading-6 font-medium text-gray-900 mb-4">
                快速操作
              </h3>
              <div className="grid grid-cols-1 gap-4 sm:grid-cols-2 lg:grid-cols-4">
                <QuickActionButton
                  title="新建采购申请"
                  description="创建新的采购申请单"
                  icon={<PlusIcon className="h-8 w-8" />}
                  href="/purchase-requests/create"
                  color="blue"
                />
                
                <QuickActionButton
                  title="待审批订单"
                  description={`${stats?.purchaseRequests.pending || 0} 个待处理`}
                  icon={<ClockIcon className="h-8 w-8" />}
                  href="/approvals"
                  color="yellow"
                />
                
                <QuickActionButton
                  title="订单分配"
                  description="分配供应商和生产计划"
                  icon={<UserGroupIcon className="h-8 w-8" />}
                  href="/order-allocation"
                  color="green"
                />
                
                <QuickActionButton
                  title="进度跟踪"
                  description="查看采购和生产进度"
                  icon={<ChartBarIcon className="h-8 w-8" />}
                  href="/purchase-progress"
                  color="purple"
                />
              </div>
            </div>
          </div>
        )}

        {/* 预警和通知 */}
        <AlertsAndNotifications userRole={userRole} />
      </div>
    </div>
  );
};

export default Dashboard;
```

#### 1.2.2 StatsCard 统计卡片组件
```typescript
// src/components/dashboard/StatsCard.tsx
interface StatsCardProps {
  title: string;
  value: string | number;
  subtitle?: string;
  icon?: React.ReactNode;
  color: 'blue' | 'green' | 'yellow' | 'purple' | 'red';
  trend?: {
    value: number;
    isPositive: boolean;
  };
  onClick?: () => void;
}

const StatsCard: React.FC<StatsCardProps> = ({
  title,
  value,
  subtitle,
  icon,
  color,
  trend,
  onClick
}) => {
  const colorClasses = {
    blue: {
      bg: 'bg-blue-50',
      icon: 'text-blue-600',
      border: 'border-blue-200'
    },
    green: {
      bg: 'bg-green-50',
      icon: 'text-green-600',
      border: 'border-green-200'
    },
    yellow: {
      bg: 'bg-yellow-50',
      icon: 'text-yellow-600',
      border: 'border-yellow-200'
    },
    purple: {
      bg: 'bg-purple-50',
      icon: 'text-purple-600',
      border: 'border-purple-200'
    },
    red: {
      bg: 'bg-red-50',
      icon: 'text-red-600',
      border: 'border-red-200'
    }
  };

  const classes = colorClasses[color];

  return (
    <div 
      className={`
        bg-white overflow-hidden shadow rounded-lg border-l-4 ${classes.border}
        ${onClick ? 'cursor-pointer hover:shadow-md transition-shadow' : ''}
      `}
      onClick={onClick}
    >
      <div className="p-5">
        <div className="flex items-center">
          <div className="flex-shrink-0">
            <div className={`p-3 rounded-md ${classes.bg}`}>
              <div className={classes.icon}>
                {icon}
              </div>
            </div>
          </div>
          <div className="ml-5 w-0 flex-1">
            <dl>
              <dt className="text-sm font-medium text-gray-500 truncate">
                {title}
              </dt>
              <dd className="flex items-baseline">
                <div className="text-2xl font-semibold text-gray-900">
                  {value}
                </div>
                {trend && (
                  <div className={`
                    ml-2 flex items-baseline text-sm font-semibold
                    ${trend.isPositive ? 'text-green-600' : 'text-red-600'}
                  `}>
                    {trend.isPositive ? (
                      <ArrowUpIcon className="self-center flex-shrink-0 h-5 w-5" />
                    ) : (
                      <ArrowDownIcon className="self-center flex-shrink-0 h-5 w-5" />
                    )}
                    <span className="sr-only">
                      {trend.isPositive ? 'Increased' : 'Decreased'} by
                    </span>
                    {Math.abs(trend.value)}%
                  </div>
                )}
              </dd>
              {subtitle && (
                <dd className="text-sm text-gray-500 mt-1">
                  {subtitle}
                </dd>
              )}
            </dl>
          </div>
        </div>
      </div>
    </div>
  );
};
```

#### 1.2.3 ProgressChart 进度图表组件
```typescript
// src/components/dashboard/ProgressChart.tsx
interface ProgressChartProps {
  data: DashboardStats | null;
  timeRange: TimeRange;
}

interface ChartData {
  name: string;
  pending: number;
  inProgress: number;
  completed: number;
}

const ProgressChart: React.FC<ProgressChartProps> = ({ data, timeRange }) => {
  const chartData: ChartData[] = useMemo(() => {
    if (!data) return [];

    return [
      {
        name: '采购申请',
        pending: data.purchaseRequests.pending,
        inProgress: data.purchaseRequests.inProgress,
        completed: data.purchaseRequests.completed,
      },
      {
        name: '订单分配',
        pending: data.allocations.pending,
        inProgress: data.allocations.inProduction,
        completed: data.allocations.allocated,
      },
      {
        name: '质量检验',
        pending: data.quality.pending,
        inProgress: 0, // 质检没有进行中状态
        completed: data.quality.passed,
      }
    ];
  }, [data]);

  const CustomTooltip = ({ active, payload, label }: any) => {
    if (active && payload && payload.length) {
      return (
        <div className="bg-white p-3 border border-gray-200 rounded-lg shadow-lg">
          <p className="font-medium text-gray-900">{label}</p>
          {payload.map((entry: any, index: number) => (
            <p key={index} style={{ color: entry.color }} className="text-sm">
              {entry.name}: {entry.value}
            </p>
          ))}
        </div>
      );
    }
    return null;
  };

  return (
    <div className="h-80">
      <ResponsiveContainer width="100%" height="100%">
        <BarChart
          data={chartData}
          margin={{
            top: 20,
            right: 30,
            left: 20,
            bottom: 5,
          }}
        >
          <CartesianGrid strokeDasharray="3 3" />
          <XAxis 
            dataKey="name" 
            tick={{ fontSize: 12 }}
            interval={0}
          />
          <YAxis tick={{ fontSize: 12 }} />
          <Tooltip content={<CustomTooltip />} />
          <Legend />
          <Bar 
            dataKey="pending" 
            stackId="a" 
            fill="#FEF3C7" 
            name="待处理"
            radius={[0, 0, 0, 0]}
          />
          <Bar 
            dataKey="inProgress" 
            stackId="a" 
            fill="#93C5FD" 
            name="进行中"
            radius={[0, 0, 0, 0]}
          />
          <Bar 
            dataKey="completed" 
            stackId="a" 
            fill="#86EFAC" 
            name="已完成"
            radius={[4, 4, 0, 0]}
          />
        </BarChart>
      </ResponsiveContainer>
    </div>
  );
};
```

#### 1.2.4 RecentActivity 最近活动组件
```typescript
// src/components/dashboard/RecentActivity.tsx
interface RecentActivityProps {
  userRole: UserRole;
  limit?: number;
}

interface ActivityItem {
  id: string;
  type: ActivityType;
  title: string;
  description: string;
  timestamp: Date;
  user?: User;
  status?: string;
  link?: string;
  priority?: 'low' | 'normal' | 'high' | 'urgent';
}

type ActivityType = 
  | 'purchase_request_created'
  | 'purchase_request_approved'
  | 'order_allocated'
  | 'quality_check_completed'
  | 'shipment_ready'
  | 'system_notification';

const RecentActivity: React.FC<RecentActivityProps> = ({ userRole, limit = 10 }) => {
  const [activities, setActivities] = useState<ActivityItem[]>([]);
  const [isLoading, setIsLoading] = useState(true);

  // 全局状态
  const purchaseRequests = usePurchaseRequests();
  const orderAllocations = useOrderAllocations();
  const qualityRecords = useQualityControlRecords();

  // 生成活动数据
  const generateActivities = useCallback((): ActivityItem[] => {
    const allActivities: ActivityItem[] = [];

    // 采购申请相关活动
    purchaseRequests
      .filter(req => {
        const daysDiff = (new Date().getTime() - req.updatedAt.getTime()) / (1000 * 3600 * 24);
        return daysDiff <= 7; // 最近7天
      })
      .forEach(req => {
        allActivities.push({
          id: `pr-${req.id}`,
          type: req.status === 'approved' ? 'purchase_request_approved' : 'purchase_request_created',
          title: `采购申请 ${req.requestNumber}`,
          description: req.status === 'approved' 
            ? `已审批通过，总金额 ¥${req.totalAmount?.toLocaleString()}`
            : `等待审批，总金额 ¥${req.totalAmount?.toLocaleString()}`,
          timestamp: req.updatedAt,
          user: req.requester,
          status: req.status,
          link: `/purchase-requests/${req.id}`,
          priority: req.priority === 'urgent' ? 'urgent' : 'normal'
        });
      });

    // 订单分配相关活动
    orderAllocations
      .filter(alloc => {
        const daysDiff = (new Date().getTime() - alloc.updatedAt.getTime()) / (1000 * 3600 * 24);
        return daysDiff <= 7;
      })
      .forEach(alloc => {
        allActivities.push({
          id: `oa-${alloc.id}`,
          type: 'order_allocated',
          title: `订单分配完成`,
          description: `采购申请已分配给供应商，预计交货 ${formatDate(alloc.deliveryDate)}`,
          timestamp: alloc.updatedAt,
          status: alloc.allocationStatus,
          link: `/order-allocation/${alloc.id}`,
          priority: 'normal'
        });
      });

    // 质检相关活动
    qualityRecords
      .filter(record => {
        const daysDiff = (new Date().getTime() - record.updatedAt.getTime()) / (1000 * 3600 * 24);
        return daysDiff <= 7;
      })
      .forEach(record => {
        allActivities.push({
          id: `qc-${record.id}`,
          type: 'quality_check_completed',
          title: `质检${record.inspectionStatus === 'passed' ? '通过' : '失败'}`,
          description: `${record.sku.name} - ${record.receivedQuantity} 件`,
          timestamp: record.updatedAt,
          status: record.inspectionStatus,
          link: `/quality-control/${record.id}`,
          priority: record.inspectionStatus === 'failed' ? 'high' : 'normal'
        });
      });

    // 按时间排序并限制数量
    return allActivities
      .sort((a, b) => b.timestamp.getTime() - a.timestamp.getTime())
      .slice(0, limit);
  }, [purchaseRequests, orderAllocations, qualityRecords, limit]);

  useEffect(() => {
    setIsLoading(true);
    const activities = generateActivities();
    setActivities(activities);
    setIsLoading(false);
  }, [generateActivities]);

  const getActivityIcon = (type: ActivityType) => {
    const iconClasses = "h-5 w-5";
    
    switch (type) {
      case 'purchase_request_created':
        return <DocumentAddIcon className={`${iconClasses} text-blue-600`} />;
      case 'purchase_request_approved':
        return <CheckCircleIcon className={`${iconClasses} text-green-600`} />;
      case 'order_allocated':
        return <UserGroupIcon className={`${iconClasses} text-purple-600`} />;
      case 'quality_check_completed':
        return <ClipboardCheckIcon className={`${iconClasses} text-yellow-600`} />;
      case 'shipment_ready':
        return <TruckIcon className={`${iconClasses} text-indigo-600`} />;
      default:
        return <InformationCircleIcon className={`${iconClasses} text-gray-600`} />;
    }
  };

  const getPriorityColor = (priority: ActivityItem['priority']) => {
    switch (priority) {
      case 'urgent':
        return 'border-l-red-500 bg-red-50';
      case 'high':
        return 'border-l-orange-500 bg-orange-50';
      case 'normal':
        return 'border-l-blue-500 bg-blue-50';
      default:
        return 'border-l-gray-500 bg-gray-50';
    }
  };

  if (isLoading) {
    return (
      <div className="animate-pulse space-y-4">
        {[...Array(5)].map((_, i) => (
          <div key={i} className="flex items-center space-x-4">
            <div className="rounded-full bg-gray-300 h-10 w-10"></div>
            <div className="space-y-2 flex-1">
              <div className="h-4 bg-gray-300 rounded w-3/4"></div>
              <div className="h-3 bg-gray-300 rounded w-1/2"></div>
            </div>
          </div>
        ))}
      </div>
    );
  }

  if (activities.length === 0) {
    return (
      <div className="text-center py-8">
        <InformationCircleIcon className="mx-auto h-12 w-12 text-gray-400" />
        <h3 className="mt-2 text-sm font-medium text-gray-900">暂无活动</h3>
        <p className="mt-1 text-sm text-gray-500">最近没有相关活动记录</p>
      </div>
    );
  }

  return (
    <div className="flow-root">
      <ul className="-mb-8">
        {activities.map((activity, activityIdx) => (
          <li key={activity.id}>
            <div className="relative pb-8">
              {activityIdx !== activities.length - 1 ? (
                <span
                  className="absolute top-4 left-4 -ml-px h-full w-0.5 bg-gray-200"
                  aria-hidden="true"
                />
              ) : null}
              <div className="relative flex space-x-3">
                <div>
                  <span className="h-8 w-8 rounded-full bg-white flex items-center justify-center ring-8 ring-white">
                    {getActivityIcon(activity.type)}
                  </span>
                </div>
                <div className="min-w-0 flex-1">
                  <div className={`
                    text-sm border-l-4 pl-4 py-2 rounded-r-lg ${getPriorityColor(activity.priority)}
                  `}>
                    <div className="flex items-center justify-between">
                      <p className="font-medium text-gray-900">
                        {activity.link ? (
                          <Link 
                            to={activity.link}
                            className="hover:text-blue-600 hover:underline"
                          >
                            {activity.title}
                          </Link>
                        ) : (
                          activity.title
                        )}
                      </p>
                      <time className="text-xs text-gray-500">
                        {formatRelativeTime(activity.timestamp)}
                      </time>
                    </div>
                    <p className="text-gray-600 mt-1">
                      {activity.description}
                    </p>
                    {activity.user && (
                      <p className="text-xs text-gray-500 mt-1">
                        操作人：{activity.user.name}
                      </p>
                    )}
                  </div>
                </div>
              </div>
            </div>
          </li>
        ))}
      </ul>
    </div>
  );
};
```

---

## 📝 2. 采购申请系统 (`purchase-requests/`)

### 2.1 模块概述
采购申请是整个采购流程的起点，负责收集采购需求、申请创建和基础审核。

### 2.2 组件架构

#### 2.2.1 PurchaseRequestList 申请列表组件
```typescript
// src/components/purchase-requests/PurchaseRequestList.tsx
interface PurchaseRequestListProps {
  filters?: PurchaseRequestFilters;
  onRequestSelect?: (request: PurchaseRequest) => void;
}

interface PurchaseRequestFilters {
  status?: OrderStatus[];
  priority?: RequestPriority[];
  dateRange?: {
    start: Date;
    end: Date;
  };
  requester?: string;
  searchTerm?: string;
}

const PurchaseRequestList: React.FC<PurchaseRequestListProps> = ({
  filters,
  onRequestSelect
}) => {
  const [requests, setRequests] = useState<PurchaseRequest[]>([]);
  const [filteredRequests, setFilteredRequests] = useState<PurchaseRequest[]>([]);
  const [isLoading, setIsLoading] = useState(true);
  const [selectedRequests, setSelectedRequests] = useState<string[]>([]);
  const [sortConfig, setSortConfig] = useState<SortConfig>({
    key: 'createdAt',
    direction: 'desc'
  });

  // 全局状态
  const globalRequests = usePurchaseRequests();
  const { batchUpdatePurchaseRequests } = useStoreActions();

  // 初始化数据
  useEffect(() => {
    setIsLoading(true);
    setRequests(globalRequests);
    setIsLoading(false);
  }, [globalRequests]);

  // 应用筛选条件
  useEffect(() => {
    let filtered = [...requests];

    if (filters) {
      // 状态筛选
      if (filters.status && filters.status.length > 0) {
        filtered = filtered.filter(req => filters.status!.includes(req.status));
      }

      // 优先级筛选
      if (filters.priority && filters.priority.length > 0) {
        filtered = filtered.filter(req => filters.priority!.includes(req.priority));
      }

      // 日期范围筛选
      if (filters.dateRange) {
        filtered = filtered.filter(req => {
          const requestDate = new Date(req.createdAt);
          return requestDate >= filters.dateRange!.start && requestDate <= filters.dateRange!.end;
        });
      }

      // 申请人筛选
      if (filters.requester) {
        filtered = filtered.filter(req => req.requesterId === filters.requester);
      }

      // 搜索词筛选
      if (filters.searchTerm) {
        const searchLower = filters.searchTerm.toLowerCase();
        filtered = filtered.filter(req =>
          req.requestNumber.toLowerCase().includes(searchLower) ||
          req.requester.name.toLowerCase().includes(searchLower) ||
          req.items.some(item => 
            item.sku.name.toLowerCase().includes(searchLower) ||
            item.sku.code.toLowerCase().includes(searchLower)
          )
        );
      }
    }

    // 应用排序
    filtered.sort((a, b) => {
      const aValue = getNestedValue(a, sortConfig.key);
      const bValue = getNestedValue(b, sortConfig.key);
      
      if (aValue < bValue) {
        return sortConfig.direction === 'asc' ? -1 : 1;
      }
      if (aValue > bValue) {
        return sortConfig.direction === 'asc' ? 1 : -1;
      }
      return 0;
    });

    setFilteredRequests(filtered);
  }, [requests, filters, sortConfig]);

  // 排序处理
  const handleSort = (key: string) => {
    setSortConfig(prev => ({
      key,
      direction: prev.key === key && prev.direction === 'asc' ? 'desc' : 'asc'
    }));
  };

  // 选择处理
  const handleSelectRequest = (requestId: string, isSelected: boolean) => {
    if (isSelected) {
      setSelectedRequests(prev => [...prev, requestId]);
    } else {
      setSelectedRequests(prev => prev.filter(id => id !== requestId));
    }
  };

  const handleSelectAll = (isSelected: boolean) => {
    if (isSelected) {
      setSelectedRequests(filteredRequests.map(req => req.id));
    } else {
      setSelectedRequests([]);
    }
  };

  // 批量操作
  const handleBatchStatusUpdate = async (newStatus: OrderStatus) => {
    if (selectedRequests.length === 0) return;

    try {
      const updates = selectedRequests.map(id => ({
        id,
        updates: { status: newStatus, updatedAt: new Date() }
      }));
      
      batchUpdatePurchaseRequests(updates);
      setSelectedRequests([]);
      
      // 显示成功消息
      toast.success(`已批量更新 ${selectedRequests.length} 个采购申请的状态`);
    } catch (error) {
      console.error('Batch update failed:', error);
      toast.error('批量更新失败，请重试');
    }
  };

  const getStatusBadge = (status: OrderStatus) => {
    const statusConfig = {
      draft: { color: 'gray', text: '草稿' },
      submitted: { color: 'yellow', text: '已提交' },
      first_approved: { color: 'blue', text: '一级审批通过' },
      approved: { color: 'green', text: '已批准' },
      allocated: { color: 'purple', text: '已分配' },
      rejected: { color: 'red', text: '已拒绝' },
      in_production: { color: 'indigo', text: '生产中' },
      quality_check: { color: 'orange', text: '质检中' },
      ready_to_ship: { color: 'teal', text: '待发货' },
      shipped: { color: 'cyan', text: '已发货' },
      completed: { color: 'emerald', text: '已完成' },
      cancelled: { color: 'slate', text: '已取消' }
    };

    const config = statusConfig[status] || statusConfig.draft;
    
    return (
      <span className={`
        inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium
        bg-${config.color}-100 text-${config.color}-800
      `}>
        {config.text}
      </span>
    );
  };

  const getPriorityBadge = (priority: RequestPriority) => {
    const priorityConfig = {
      low: { color: 'gray', text: '低', icon: null },
      normal: { color: 'blue', text: '普通', icon: null },
      high: { color: 'yellow', text: '高', icon: <ExclamationIcon className="h-3 w-3" /> },
      urgent: { color: 'red', text: '紧急', icon: <ExclamationTriangleIcon className="h-3 w-3" /> }
    };

    const config = priorityConfig[priority];
    
    return (
      <span className={`
        inline-flex items-center space-x-1 px-2 py-1 rounded text-xs font-medium
        bg-${config.color}-100 text-${config.color}-800
      `}>
        {config.icon}
        <span>{config.text}</span>
      </span>
    );
  };

  if (isLoading) {
    return (
      <div className="animate-pulse">
        <div className="space-y-4">
          {[...Array(5)].map((_, i) => (
            <div key={i} className="bg-white shadow rounded-lg p-6">
              <div className="flex items-center space-x-4">
                <div className="h-4 bg-gray-300 rounded w-1/4"></div>
                <div className="h-4 bg-gray-300 rounded w-1/6"></div>
                <div className="h-4 bg-gray-300 rounded w-1/4"></div>
                <div className="h-4 bg-gray-300 rounded w-1/6"></div>
              </div>
            </div>
          ))}
        </div>
      </div>
    );
  }

  return (
    <div className="bg-white shadow overflow-hidden sm:rounded-md">
      {/* 批量操作栏 */}
      {selectedRequests.length > 0 && (
        <div className="bg-blue-50 px-4 py-3 border-b border-blue-200">
          <div className="flex items-center justify-between">
            <div className="flex items-center">
              <span className="text-sm font-medium text-blue-900">
                已选择 {selectedRequests.length} 个采购申请
              </span>
            </div>
            <div className="flex items-center space-x-2">
              <select
                onChange={(e) => handleBatchStatusUpdate(e.target.value as OrderStatus)}
                className="block w-40 px-3 py-2 border border-blue-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                defaultValue=""
              >
                <option value="" disabled>批量操作</option>
                <option value="approved">批准</option>
                <option value="rejected">拒绝</option>
                <option value="cancelled">取消</option>
              </select>
              <button
                onClick={() => setSelectedRequests([])}
                className="inline-flex items-center px-3 py-2 border border-blue-300 shadow-sm text-sm leading-4 font-medium rounded-md text-blue-700 bg-white hover:bg-blue-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
              >
                取消选择
              </button>
            </div>
          </div>
        </div>
      )}

      {/* 表格标题栏 */}
      <div className="bg-gray-50 px-6 py-3 border-b border-gray-200">
        <div className="flex items-center justify-between">
          <div className="flex items-center">
            <input
              type="checkbox"
              className="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded"
              checked={selectedRequests.length === filteredRequests.length && filteredRequests.length > 0}
              onChange={(e) => handleSelectAll(e.target.checked)}
            />
            <span className="ml-3 text-sm font-medium text-gray-900">
              全选
            </span>
          </div>
          <div className="text-sm text-gray-500">
            共 {filteredRequests.length} 条记录
          </div>
        </div>
      </div>

      {/* 申请列表 */}
      <ul className="divide-y divide-gray-200">
        {filteredRequests.map((request) => (
          <li key={request.id}>
            <div className="px-6 py-4 hover:bg-gray-50">
              <div className="flex items-center justify-between">
                <div className="flex items-center space-x-4 flex-1">
                  <input
                    type="checkbox"
                    className="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded"
                    checked={selectedRequests.includes(request.id)}
                    onChange={(e) => handleSelectRequest(request.id, e.target.checked)}
                  />
                  
                  <div className="flex-1 min-w-0">
                    <div className="flex items-center justify-between">
                      <div className="flex items-center space-x-3">
                        <button
                          onClick={() => onRequestSelect?.(request)}
                          className="text-sm font-medium text-blue-600 hover:text-blue-900 hover:underline"
                        >
                          {request.requestNumber}
                        </button>
                        {getStatusBadge(request.status)}
                        {getPriorityBadge(request.priority)}
                      </div>
                      <div className="flex items-center space-x-4 text-sm text-gray-500">
                        <span>¥{request.totalAmount?.toLocaleString()}</span>
                        <span>{formatDate(request.createdAt)}</span>
                      </div>
                    </div>
                    
                    <div className="mt-2">
                      <div className="flex items-center justify-between">
                        <div className="flex items-center space-x-4 text-sm text-gray-600">
                          <span>申请人：{request.requester.name}</span>
                          <span>项目数：{request.items.length}</span>
                          <span>交期：{formatDate(request.deadline)}</span>
                        </div>
                      </div>
                    </div>
                    
                    {/* 主要项目预览 */}
                    <div className="mt-2">
                      <div className="flex flex-wrap gap-2">
                        {request.items.slice(0, 3).map((item) => (
                          <span
                            key={item.id}
                            className="inline-flex items-center px-2 py-1 rounded-md text-xs bg-gray-100 text-gray-800"
                          >
                            {item.sku.name} × {item.quantity}
                          </span>
                        ))}
                        {request.items.length > 3 && (
                          <span className="inline-flex items-center px-2 py-1 rounded-md text-xs bg-gray-100 text-gray-500">
                            +{request.items.length - 3} 更多
                          </span>
                        )}
                      </div>
                    </div>
                  </div>
                </div>
                
                {/* 操作按钮 */}
                <div className="flex items-center space-x-2 ml-4">
                  <button
                    onClick={() => onRequestSelect?.(request)}
                    className="inline-flex items-center px-3 py-2 border border-gray-300 shadow-sm text-sm leading-4 font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
                  >
                    查看详情
                  </button>
                  
                  {request.status === 'draft' && (
                    <button
                      onClick={() => {/* 编辑逻辑 */}}
                      className="inline-flex items-center px-3 py-2 border border-transparent text-sm leading-4 font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
                    >
                      编辑
                    </button>
                  )}
                </div>
              </div>
            </div>
          </li>
        ))}
      </ul>

      {/* 空状态 */}
      {filteredRequests.length === 0 && (
        <div className="text-center py-12">
          <DocumentTextIcon className="mx-auto h-12 w-12 text-gray-400" />
          <h3 className="mt-2 text-sm font-medium text-gray-900">暂无采购申请</h3>
          <p className="mt-1 text-sm text-gray-500">
            {filters ? '没有符合筛选条件的采购申请' : '还没有创建任何采购申请'}
          </p>
        </div>
      )}
    </div>
  );
};
```

#### 2.2.2 CreatePurchaseRequest 创建申请组件
```typescript
// src/components/purchase-requests/CreatePurchaseRequest.tsx
interface CreatePurchaseRequestProps {
  onSubmit: (request: Partial<PurchaseRequest>) => Promise<void>;
  onCancel: () => void;
  initialData?: Partial<PurchaseRequest>;
}

const CreatePurchaseRequest: React.FC<CreatePurchaseRequestProps> = ({
  onSubmit,
  onCancel,
  initialData
}) => {
  const [formData, setFormData] = useState<PurchaseRequestFormData>({
    items: [createEmptyItem()],
    priority: 'normal',
    deadline: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000), // 默认7天后
    remarks: '',
    type: 'external'
  });
  
  const [errors, setErrors] = useState<FormErrors>({});
  const [isSubmitting, setIsSubmitting] = useState(false);
  const [availableSKUs, setAvailableSKUs] = useState<SKU[]>([]);
  
  const { user } = useAuth();
  const { addPurchaseRequest } = useGlobalStore();

  // 初始化SKU数据
  useEffect(() => {
    // 这里应该从API加载SKU数据
    // 暂时使用模拟数据
    setAvailableSKUs(mockSKUs);
  }, []);

  // 初始化表单数据
  useEffect(() => {
    if (initialData) {
      setFormData(prev => ({ ...prev, ...initialData }));
    }
  }, [initialData]);

  const createEmptyItem = (): PurchaseRequestItemFormData => ({
    skuId: '',
    quantity: 1,
    urgency: 'normal',
    remarks: '',
    material: '',
    packagingMethod: '',
    specifications: []
  });

  const validateForm = (): boolean => {
    const newErrors: FormErrors = {};

    // 验证基本信息
    if (!formData.deadline) {
      newErrors.deadline = '请选择期望交期';
    } else if (formData.deadline <= new Date()) {
      newErrors.deadline = '交期不能早于今天';
    }

    // 验证申请项目
    if (formData.items.length === 0) {
      newErrors.items = '至少需要一个申请项目';
    } else {
      const itemErrors: Record<string, any> = {};
      
      formData.items.forEach((item, index) => {
        const itemError: any = {};
        
        if (!item.skuId) {
          itemError.skuId = '请选择产品';
        }
        
        if (!item.quantity || item.quantity <= 0) {
          itemError.quantity = '数量必须大于0';
        }
        
        if (Object.keys(itemError).length > 0) {
          itemErrors[index] = itemError;
        }
      });
      
      if (Object.keys(itemErrors).length > 0) {
        newErrors.items = itemErrors;
      }
    }

    setErrors(newErrors);
    return Object.keys(newErrors).length === 0;
  };

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    
    if (!validateForm()) {
      return;
    }

    setIsSubmitting(true);
    
    try {
      // 计算总金额（基于预估价格）
      const totalAmount = formData.items.reduce((sum, item) => {
        const sku = availableSKUs.find(s => s.id === item.skuId);
        const estimatedPrice = sku?.estimatedPrice || 0;
        return sum + (estimatedPrice * item.quantity);
      }, 0);

      // 构建完整的采购申请对象
      const requestData: Partial<PurchaseRequest> = {
        requestNumber: generateRequestNumber(),
        requesterId: user!.id,
        items: formData.items.map(item => ({
          ...item,
          id: generateId(),
          sku: availableSKUs.find(s => s.id === item.skuId)!,
          status: 'pending',
          createdAt: new Date(),
          updatedAt: new Date()
        })),
        totalAmount,
        status: 'draft',
        approvalStatus: 'pending',
        priority: formData.priority,
        deadline: formData.deadline,
        remarks: formData.remarks,
        type: formData.type,
        createdAt: new Date(),
        updatedAt: new Date(),
        version: 1
      };

      await onSubmit(requestData);
      
      // 重置表单
      setFormData({
        items: [createEmptyItem()],
        priority: 'normal',
        deadline: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000),
        remarks: '',
        type: 'external'
      });
      
      toast.success('采购申请创建成功');
      
    } catch (error) {
      console.error('Failed to create purchase request:', error);
      toast.error('创建失败，请重试');
    } finally {
      setIsSubmitting(false);
    }
  };

  const handleAddItem = () => {
    setFormData(prev => ({
      ...prev,
      items: [...prev.items, createEmptyItem()]
    }));
  };

  const handleRemoveItem = (index: number) => {
    if (formData.items.length <= 1) {
      toast.warning('至少需要保留一个申请项目');
      return;
    }
    
    setFormData(prev => ({
      ...prev,
      items: prev.items.filter((_, i) => i !== index)
    }));
  };

  const handleItemChange = (index: number, field: string, value: any) => {
    setFormData(prev => ({
      ...prev,
      items: prev.items.map((item, i) => 
        i === index ? { ...item, [field]: value } : item
      )
    }));

    // 清除相关错误
    if (errors.items && typeof errors.items === 'object' && errors.items[index]) {
      const newErrors = { ...errors };
      delete newErrors.items[index][field];
      if (Object.keys(newErrors.items[index]).length === 0) {
        delete newErrors.items[index];
      }
      setErrors(newErrors);
    }
  };

  return (
    <div className="max-w-4xl mx-auto">
      <form onSubmit={handleSubmit} className="space-y-8">
        {/* 基本信息 */}
        <div className="bg-white shadow rounded-lg">
          <div className="px-6 py-4 border-b border-gray-200">
            <h3 className="text-lg leading-6 font-medium text-gray-900">
              基本信息
            </h3>
          </div>
          <div className="px-6 py-4 space-y-6">
            <div className="grid grid-cols-1 gap-6 sm:grid-cols-2">
              <div>
                <label htmlFor="priority" className="block text-sm font-medium text-gray-700">
                  优先级 <span className="text-red-500">*</span>
                </label>
                <select
                  id="priority"
                  value={formData.priority}
                  onChange={(e) => setFormData(prev => ({ ...prev, priority: e.target.value as RequestPriority }))}
                  className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                >
                  <option value="low">低优先级</option>
                  <option value="normal">普通</option>
                  <option value="high">高优先级</option>
                  <option value="urgent">紧急</option>
                </select>
              </div>

              <div>
                <label htmlFor="type" className="block text-sm font-medium text-gray-700">
                  采购类型 <span className="text-red-500">*</span>
                </label>
                <select
                  id="type"
                  value={formData.type}
                  onChange={(e) => setFormData(prev => ({ ...prev, type: e.target.value as PurchaseType }))}
                  className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                >
                  <option value="external">厂家包装</option>
                  <option value="in_house">自己包装</option>
                </select>
              </div>

              <div>
                <label htmlFor="deadline" className="block text-sm font-medium text-gray-700">
                  期望交期 <span className="text-red-500">*</span>
                </label>
                <input
                  type="date"
                  id="deadline"
                  value={formData.deadline ? formatDate(formData.deadline, 'YYYY-MM-DD') : ''}
                  onChange={(e) => setFormData(prev => ({ ...prev, deadline: new Date(e.target.value) }))}
                  className={`mt-1 block w-full px-3 py-2 border rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm ${
                    errors.deadline ? 'border-red-300' : 'border-gray-300'
                  }`}
                />
                {errors.deadline && (
                  <p className="mt-1 text-sm text-red-600">{errors.deadline}</p>
                )}
              </div>
            </div>

            <div>
              <label htmlFor="remarks" className="block text-sm font-medium text-gray-700">
                备注说明
              </label>
              <textarea
                id="remarks"
                rows={3}
                value={formData.remarks}
                onChange={(e) => setFormData(prev => ({ ...prev, remarks: e.target.value }))}
                className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                placeholder="请输入相关备注信息..."
              />
            </div>
          </div>
        </div>

        {/* 申请项目 */}
        <div className="bg-white shadow rounded-lg">
          <div className="px-6 py-4 border-b border-gray-200">
            <div className="flex items-center justify-between">
              <h3 className="text-lg leading-6 font-medium text-gray-900">
                申请项目
              </h3>
              <button
                type="button"
                onClick={handleAddItem}
                className="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
              >
                <PlusIcon className="h-4 w-4 mr-2" />
                添加项目
              </button>
            </div>
          </div>
          
          <div className="px-6 py-4">
            {formData.items.map((item, index) => (
              <PurchaseRequestItemForm
                key={index}
                item={item}
                index={index}
                availableSKUs={availableSKUs}
                errors={errors.items?.[index] || {}}
                onChange={(field, value) => handleItemChange(index, field, value)}
                onRemove={() => handleRemoveItem(index)}
                canRemove={formData.items.length > 1}
              />
            ))}
            
            {errors.items && typeof errors.items === 'string' && (
              <p className="mt-2 text-sm text-red-600">{errors.items}</p>
            )}
          </div>
        </div>

        {/* 提交按钮 */}
        <div className="flex justify-end space-x-4">
          <button
            type="button"
            onClick={onCancel}
            className="inline-flex items-center px-6 py-3 border border-gray-300 shadow-sm text-base font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
          >
            取消
          </button>
          
          <button
            type="button"
            onClick={handleSubmit}
            disabled={isSubmitting}
            className="inline-flex items-center px-6 py-3 border border-transparent text-base font-medium rounded-md text-white bg-gray-600 hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500 disabled:opacity-50"
          >
            {isSubmitting ? '保存中...' : '保存草稿'}
          </button>
          
          <button
            type="submit"
            disabled={isSubmitting}
            className="inline-flex items-center px-6 py-3 border border-transparent text-base font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:opacity-50"
          >
            {isSubmitting ? '提交中...' : '提交申请'}
          </button>
        </div>
      </form>
    </div>
  );
};
```

---

**第二批文档已完成！**

现在让我继续编写第三批：进度跟踪系统。

继续第三批？

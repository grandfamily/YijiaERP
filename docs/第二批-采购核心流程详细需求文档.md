# ä¸€å®¶ç™¾è´§é‡‡è´­ç®¡ç†ç³»ç»Ÿ - ç¬¬äºŒæ‰¹ï¼šé‡‡è´­æ ¸å¿ƒæµç¨‹è¯¦ç»†éœ€æ±‚æ–‡æ¡£

## ğŸ“‹ æ–‡æ¡£ä¿¡æ¯
- **æ–‡æ¡£ç‰ˆæœ¬**: v1.0
- **ç¼–å†™æ—¥æœŸ**: 2025å¹´8æœˆ11æ—¥
- **é€‚ç”¨èŒƒå›´**: é‡‡è´­æ ¸å¿ƒä¸šåŠ¡æµç¨‹æ¨¡å—
- **ä¾èµ–å…³ç³»**: ç¬¬ä¸€æ‰¹åŸºç¡€æ¶æ„æ¨¡å—

---

## ğŸ“Š 1. ä»ªè¡¨æ¿ç³»ç»Ÿ (`dashboard/`)

### 1.1 æ¨¡å—æ¦‚è¿°
ç³»ç»Ÿé¦–é¡µä»ªè¡¨æ¿ï¼Œæä¾›å…¨å±€ä¸šåŠ¡æ¦‚è§ˆã€å…³é”®æŒ‡æ ‡ç›‘æ§å’Œå¿«é€Ÿæ“ä½œå…¥å£ã€‚

### 1.2 ç»„ä»¶æ¶æ„

#### 1.2.1 Dashboard ä¸»ç»„ä»¶
```typescript
// src/components/dashboard/Dashboard.tsx
interface DashboardProps {
  userRole: UserRole;
}

interface DashboardStats {
  purchaseRequests: {
    total: number;
    pending: number;
    approved: number;
    inProgress: number;
    completed: number;
  };
  allocations: {
    total: number;
    pending: number;
    allocated: number;
    inProduction: number;
  };
  quality: {
    total: number;
    passed: number;
    failed: number;
    pending: number;
  };
  financial: {
    totalValue: number;
    pendingPayments: number;
    monthlyBudget: number;
    usedBudget: number;
  };
}

const Dashboard: React.FC<DashboardProps> = ({ userRole }) => {
  const [stats, setStats] = useState<DashboardStats | null>(null);
  const [isLoading, setIsLoading] = useState(true);
  const [selectedTimeRange, setSelectedTimeRange] = useState<TimeRange>('month');
  const [refreshInterval, setRefreshInterval] = useState<NodeJS.Timeout | null>(null);

  // å…¨å±€çŠ¶æ€
  const purchaseRequests = usePurchaseRequests();
  const orderAllocations = useOrderAllocations();
  const qualityRecords = useQualityControlRecords();
  const user = useGlobalStore(state => state.user);

  // è®¡ç®—ç»Ÿè®¡æ•°æ®
  const calculateStats = useCallback((): DashboardStats => {
    const now = new Date();
    const timeRangeStart = getTimeRangeStart(selectedTimeRange, now);

    // è¿‡æ»¤æ—¶é—´èŒƒå›´å†…çš„æ•°æ®
    const filteredRequests = purchaseRequests.filter(req => 
      req.createdAt >= timeRangeStart
    );
    const filteredAllocations = orderAllocations.filter(alloc => 
      alloc.createdAt >= timeRangeStart
    );
    const filteredQuality = qualityRecords.filter(record => 
      record.createdAt >= timeRangeStart
    );

    return {
      purchaseRequests: {
        total: filteredRequests.length,
        pending: filteredRequests.filter(r => r.status === 'submitted').length,
        approved: filteredRequests.filter(r => r.status === 'approved').length,
        inProgress: filteredRequests.filter(r => ['in_production', 'quality_check'].includes(r.status)).length,
        completed: filteredRequests.filter(r => r.status === 'completed').length,
      },
      allocations: {
        total: filteredAllocations.length,
        pending: filteredAllocations.filter(a => a.allocationStatus === 'pending').length,
        allocated: filteredAllocations.filter(a => a.allocationStatus === 'allocated').length,
        inProduction: filteredAllocations.filter(a => ['in_production', 'production_scheduled'].includes(a.allocationStatus)).length,
      },
      quality: {
        total: filteredQuality.length,
        passed: filteredQuality.filter(q => q.inspectionStatus === 'passed').length,
        failed: filteredQuality.filter(q => q.inspectionStatus === 'failed').length,
        pending: filteredQuality.filter(q => q.inspectionStatus === 'pending').length,
      },
      financial: {
        totalValue: filteredRequests.reduce((sum, req) => sum + (req.totalAmount || 0), 0),
        pendingPayments: filteredRequests
          .filter(req => req.status === 'approved' && !req.isPaid)
          .reduce((sum, req) => sum + (req.totalAmount || 0), 0),
        monthlyBudget: 1000000, // æ¨¡æ‹Ÿæœˆåº¦é¢„ç®—
        usedBudget: filteredRequests.reduce((sum, req) => sum + (req.totalAmount || 0), 0),
      }
    };
  }, [purchaseRequests, orderAllocations, qualityRecords, selectedTimeRange]);

  // åˆå§‹åŒ–å’Œåˆ·æ–°æ•°æ®
  useEffect(() => {
    const loadStats = async () => {
      setIsLoading(true);
      try {
        // æ¨¡æ‹ŸAPIå»¶è¿Ÿ
        await new Promise(resolve => setTimeout(resolve, 500));
        const newStats = calculateStats();
        setStats(newStats);
      } catch (error) {
        console.error('Failed to load dashboard stats:', error);
      } finally {
        setIsLoading(false);
      }
    };

    loadStats();

    // è®¾ç½®è‡ªåŠ¨åˆ·æ–°
    const interval = setInterval(loadStats, 30000); // 30ç§’åˆ·æ–°ä¸€æ¬¡
    setRefreshInterval(interval);

    return () => {
      if (refreshInterval) clearInterval(refreshInterval);
    };
  }, [calculateStats]);

  // æƒé™æ£€æŸ¥
  const canViewFinancials = hasRolePermission(userRole, 'finance_personnel');
  const canManageProcurement = hasRolePermission(userRole, 'purchasing_officer');

  if (isLoading) {
    return (
      <div className="min-h-screen bg-gray-50 flex items-center justify-center">
        <div className="animate-spin rounded-full h-32 w-32 border-b-2 border-blue-600"></div>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-gray-50">
      {/* é¡µé¢æ ‡é¢˜æ  */}
      <div className="bg-white shadow">
        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
          <div className="py-6">
            <div className="flex items-center justify-between">
              <div>
                <h1 className="text-3xl font-bold text-gray-900">
                  é‡‡è´­ç®¡ç†ä»ªè¡¨æ¿
                </h1>
                <p className="mt-1 text-sm text-gray-500">
                  æ¬¢è¿å›æ¥ï¼Œ{user?.name}ï¼ä»Šå¤©æ˜¯ {formatDate(new Date(), 'YYYYå¹´MMæœˆDDæ—¥')}
                </p>
              </div>
              
              {/* æ—¶é—´èŒƒå›´é€‰æ‹©å™¨ */}
              <div className="flex items-center space-x-4">
                <select
                  value={selectedTimeRange}
                  onChange={(e) => setSelectedTimeRange(e.target.value as TimeRange)}
                  className="block w-40 px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                >
                  <option value="week">æœ¬å‘¨</option>
                  <option value="month">æœ¬æœˆ</option>
                  <option value="quarter">æœ¬å­£åº¦</option>
                  <option value="year">æœ¬å¹´</option>
                </select>
                
                <button
                  onClick={() => setStats(calculateStats())}
                  className="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
                >
                  <RefreshIcon className="h-4 w-4 mr-2" />
                  åˆ·æ–°
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

      {/* ä¸»è¦å†…å®¹åŒºåŸŸ */}
      <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        {/* å…³é”®æŒ‡æ ‡å¡ç‰‡ */}
        <div className="grid grid-cols-1 gap-6 sm:grid-cols-2 lg:grid-cols-4 mb-8">
          <StatsCard
            title="é‡‡è´­ç”³è¯·"
            value={stats?.purchaseRequests.total || 0}
            subtitle={`${stats?.purchaseRequests.pending || 0} ä¸ªå¾…å®¡æ‰¹`}
            icon={<DocumentTextIcon className="h-6 w-6" />}
            color="blue"
            trend={{ value: 12, isPositive: true }}
          />
          
          <StatsCard
            title="è®¢å•åˆ†é…"
            value={stats?.allocations.total || 0}
            subtitle={`${stats?.allocations.pending || 0} ä¸ªå¾…åˆ†é…`}
            icon={<ClipboardListIcon className="h-6 w-6" />}
            color="green"
            trend={{ value: 8, isPositive: true }}
          />
          
          <StatsCard
            title="è´¨æ£€é€šè¿‡ç‡"
            value={`${calculatePassRate(stats?.quality)}%`}
            subtitle={`${stats?.quality.failed || 0} ä¸ªä¸åˆæ ¼`}
            icon={<CheckCircleIcon className="h-6 w-6" />}
            color="yellow"
            trend={{ value: 2, isPositive: false }}
          />
          
          {canViewFinancials && (
            <StatsCard
              title="é‡‡è´­é‡‘é¢"
              value={formatCurrency(stats?.financial.totalValue || 0)}
              subtitle={`é¢„ç®—ä½¿ç”¨ç‡ ${calculateBudgetUsage(stats?.financial)}%`}
              icon={<CurrencyDollarIcon className="h-6 w-6" />}
              color="purple"
              trend={{ value: 15, isPositive: true }}
            />
          )}
        </div>

        {/* å›¾è¡¨å’Œåˆ—è¡¨åŒºåŸŸ */}
        <div className="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
          {/* è¿›åº¦å›¾è¡¨ */}
          <div className="bg-white overflow-hidden shadow rounded-lg">
            <div className="p-6">
              <h3 className="text-lg leading-6 font-medium text-gray-900 mb-4">
                é‡‡è´­è¿›åº¦æ¦‚è§ˆ
              </h3>
              <ProgressChart 
                data={stats} 
                timeRange={selectedTimeRange}
              />
            </div>
          </div>

          {/* æœ€è¿‘æ´»åŠ¨ */}
          <div className="bg-white overflow-hidden shadow rounded-lg">
            <div className="p-6">
              <h3 className="text-lg leading-6 font-medium text-gray-900 mb-4">
                æœ€è¿‘æ´»åŠ¨
              </h3>
              <RecentActivity 
                userRole={userRole}
                limit={5}
              />
            </div>
          </div>
        </div>

        {/* å¿«é€Ÿæ“ä½œæŒ‰é’® */}
        {canManageProcurement && (
          <div className="bg-white overflow-hidden shadow rounded-lg">
            <div className="p-6">
              <h3 className="text-lg leading-6 font-medium text-gray-900 mb-4">
                å¿«é€Ÿæ“ä½œ
              </h3>
              <div className="grid grid-cols-1 gap-4 sm:grid-cols-2 lg:grid-cols-4">
                <QuickActionButton
                  title="æ–°å»ºé‡‡è´­ç”³è¯·"
                  description="åˆ›å»ºæ–°çš„é‡‡è´­ç”³è¯·å•"
                  icon={<PlusIcon className="h-8 w-8" />}
                  href="/purchase-requests/create"
                  color="blue"
                />
                
                <QuickActionButton
                  title="å¾…å®¡æ‰¹è®¢å•"
                  description={`${stats?.purchaseRequests.pending || 0} ä¸ªå¾…å¤„ç†`}
                  icon={<ClockIcon className="h-8 w-8" />}
                  href="/approvals"
                  color="yellow"
                />
                
                <QuickActionButton
                  title="è®¢å•åˆ†é…"
                  description="åˆ†é…ä¾›åº”å•†å’Œç”Ÿäº§è®¡åˆ’"
                  icon={<UserGroupIcon className="h-8 w-8" />}
                  href="/order-allocation"
                  color="green"
                />
                
                <QuickActionButton
                  title="è¿›åº¦è·Ÿè¸ª"
                  description="æŸ¥çœ‹é‡‡è´­å’Œç”Ÿäº§è¿›åº¦"
                  icon={<ChartBarIcon className="h-8 w-8" />}
                  href="/purchase-progress"
                  color="purple"
                />
              </div>
            </div>
          </div>
        )}

        {/* é¢„è­¦å’Œé€šçŸ¥ */}
        <AlertsAndNotifications userRole={userRole} />
      </div>
    </div>
  );
};

export default Dashboard;
```

#### 1.2.2 StatsCard ç»Ÿè®¡å¡ç‰‡ç»„ä»¶
```typescript
// src/components/dashboard/StatsCard.tsx
interface StatsCardProps {
  title: string;
  value: string | number;
  subtitle?: string;
  icon?: React.ReactNode;
  color: 'blue' | 'green' | 'yellow' | 'purple' | 'red';
  trend?: {
    value: number;
    isPositive: boolean;
  };
  onClick?: () => void;
}

const StatsCard: React.FC<StatsCardProps> = ({
  title,
  value,
  subtitle,
  icon,
  color,
  trend,
  onClick
}) => {
  const colorClasses = {
    blue: {
      bg: 'bg-blue-50',
      icon: 'text-blue-600',
      border: 'border-blue-200'
    },
    green: {
      bg: 'bg-green-50',
      icon: 'text-green-600',
      border: 'border-green-200'
    },
    yellow: {
      bg: 'bg-yellow-50',
      icon: 'text-yellow-600',
      border: 'border-yellow-200'
    },
    purple: {
      bg: 'bg-purple-50',
      icon: 'text-purple-600',
      border: 'border-purple-200'
    },
    red: {
      bg: 'bg-red-50',
      icon: 'text-red-600',
      border: 'border-red-200'
    }
  };

  const classes = colorClasses[color];

  return (
    <div 
      className={`
        bg-white overflow-hidden shadow rounded-lg border-l-4 ${classes.border}
        ${onClick ? 'cursor-pointer hover:shadow-md transition-shadow' : ''}
      `}
      onClick={onClick}
    >
      <div className="p-5">
        <div className="flex items-center">
          <div className="flex-shrink-0">
            <div className={`p-3 rounded-md ${classes.bg}`}>
              <div className={classes.icon}>
                {icon}
              </div>
            </div>
          </div>
          <div className="ml-5 w-0 flex-1">
            <dl>
              <dt className="text-sm font-medium text-gray-500 truncate">
                {title}
              </dt>
              <dd className="flex items-baseline">
                <div className="text-2xl font-semibold text-gray-900">
                  {value}
                </div>
                {trend && (
                  <div className={`
                    ml-2 flex items-baseline text-sm font-semibold
                    ${trend.isPositive ? 'text-green-600' : 'text-red-600'}
                  `}>
                    {trend.isPositive ? (
                      <ArrowUpIcon className="self-center flex-shrink-0 h-5 w-5" />
                    ) : (
                      <ArrowDownIcon className="self-center flex-shrink-0 h-5 w-5" />
                    )}
                    <span className="sr-only">
                      {trend.isPositive ? 'Increased' : 'Decreased'} by
                    </span>
                    {Math.abs(trend.value)}%
                  </div>
                )}
              </dd>
              {subtitle && (
                <dd className="text-sm text-gray-500 mt-1">
                  {subtitle}
                </dd>
              )}
            </dl>
          </div>
        </div>
      </div>
    </div>
  );
};
```

#### 1.2.3 ProgressChart è¿›åº¦å›¾è¡¨ç»„ä»¶
```typescript
// src/components/dashboard/ProgressChart.tsx
interface ProgressChartProps {
  data: DashboardStats | null;
  timeRange: TimeRange;
}

interface ChartData {
  name: string;
  pending: number;
  inProgress: number;
  completed: number;
}

const ProgressChart: React.FC<ProgressChartProps> = ({ data, timeRange }) => {
  const chartData: ChartData[] = useMemo(() => {
    if (!data) return [];

    return [
      {
        name: 'é‡‡è´­ç”³è¯·',
        pending: data.purchaseRequests.pending,
        inProgress: data.purchaseRequests.inProgress,
        completed: data.purchaseRequests.completed,
      },
      {
        name: 'è®¢å•åˆ†é…',
        pending: data.allocations.pending,
        inProgress: data.allocations.inProduction,
        completed: data.allocations.allocated,
      },
      {
        name: 'è´¨é‡æ£€éªŒ',
        pending: data.quality.pending,
        inProgress: 0, // è´¨æ£€æ²¡æœ‰è¿›è¡Œä¸­çŠ¶æ€
        completed: data.quality.passed,
      }
    ];
  }, [data]);

  const CustomTooltip = ({ active, payload, label }: any) => {
    if (active && payload && payload.length) {
      return (
        <div className="bg-white p-3 border border-gray-200 rounded-lg shadow-lg">
          <p className="font-medium text-gray-900">{label}</p>
          {payload.map((entry: any, index: number) => (
            <p key={index} style={{ color: entry.color }} className="text-sm">
              {entry.name}: {entry.value}
            </p>
          ))}
        </div>
      );
    }
    return null;
  };

  return (
    <div className="h-80">
      <ResponsiveContainer width="100%" height="100%">
        <BarChart
          data={chartData}
          margin={{
            top: 20,
            right: 30,
            left: 20,
            bottom: 5,
          }}
        >
          <CartesianGrid strokeDasharray="3 3" />
          <XAxis 
            dataKey="name" 
            tick={{ fontSize: 12 }}
            interval={0}
          />
          <YAxis tick={{ fontSize: 12 }} />
          <Tooltip content={<CustomTooltip />} />
          <Legend />
          <Bar 
            dataKey="pending" 
            stackId="a" 
            fill="#FEF3C7" 
            name="å¾…å¤„ç†"
            radius={[0, 0, 0, 0]}
          />
          <Bar 
            dataKey="inProgress" 
            stackId="a" 
            fill="#93C5FD" 
            name="è¿›è¡Œä¸­"
            radius={[0, 0, 0, 0]}
          />
          <Bar 
            dataKey="completed" 
            stackId="a" 
            fill="#86EFAC" 
            name="å·²å®Œæˆ"
            radius={[4, 4, 0, 0]}
          />
        </BarChart>
      </ResponsiveContainer>
    </div>
  );
};
```

#### 1.2.4 RecentActivity æœ€è¿‘æ´»åŠ¨ç»„ä»¶
```typescript
// src/components/dashboard/RecentActivity.tsx
interface RecentActivityProps {
  userRole: UserRole;
  limit?: number;
}

interface ActivityItem {
  id: string;
  type: ActivityType;
  title: string;
  description: string;
  timestamp: Date;
  user?: User;
  status?: string;
  link?: string;
  priority?: 'low' | 'normal' | 'high' | 'urgent';
}

type ActivityType = 
  | 'purchase_request_created'
  | 'purchase_request_approved'
  | 'order_allocated'
  | 'quality_check_completed'
  | 'shipment_ready'
  | 'system_notification';

const RecentActivity: React.FC<RecentActivityProps> = ({ userRole, limit = 10 }) => {
  const [activities, setActivities] = useState<ActivityItem[]>([]);
  const [isLoading, setIsLoading] = useState(true);

  // å…¨å±€çŠ¶æ€
  const purchaseRequests = usePurchaseRequests();
  const orderAllocations = useOrderAllocations();
  const qualityRecords = useQualityControlRecords();

  // ç”Ÿæˆæ´»åŠ¨æ•°æ®
  const generateActivities = useCallback((): ActivityItem[] => {
    const allActivities: ActivityItem[] = [];

    // é‡‡è´­ç”³è¯·ç›¸å…³æ´»åŠ¨
    purchaseRequests
      .filter(req => {
        const daysDiff = (new Date().getTime() - req.updatedAt.getTime()) / (1000 * 3600 * 24);
        return daysDiff <= 7; // æœ€è¿‘7å¤©
      })
      .forEach(req => {
        allActivities.push({
          id: `pr-${req.id}`,
          type: req.status === 'approved' ? 'purchase_request_approved' : 'purchase_request_created',
          title: `é‡‡è´­ç”³è¯· ${req.requestNumber}`,
          description: req.status === 'approved' 
            ? `å·²å®¡æ‰¹é€šè¿‡ï¼Œæ€»é‡‘é¢ Â¥${req.totalAmount?.toLocaleString()}`
            : `ç­‰å¾…å®¡æ‰¹ï¼Œæ€»é‡‘é¢ Â¥${req.totalAmount?.toLocaleString()}`,
          timestamp: req.updatedAt,
          user: req.requester,
          status: req.status,
          link: `/purchase-requests/${req.id}`,
          priority: req.priority === 'urgent' ? 'urgent' : 'normal'
        });
      });

    // è®¢å•åˆ†é…ç›¸å…³æ´»åŠ¨
    orderAllocations
      .filter(alloc => {
        const daysDiff = (new Date().getTime() - alloc.updatedAt.getTime()) / (1000 * 3600 * 24);
        return daysDiff <= 7;
      })
      .forEach(alloc => {
        allActivities.push({
          id: `oa-${alloc.id}`,
          type: 'order_allocated',
          title: `è®¢å•åˆ†é…å®Œæˆ`,
          description: `é‡‡è´­ç”³è¯·å·²åˆ†é…ç»™ä¾›åº”å•†ï¼Œé¢„è®¡äº¤è´§ ${formatDate(alloc.deliveryDate)}`,
          timestamp: alloc.updatedAt,
          status: alloc.allocationStatus,
          link: `/order-allocation/${alloc.id}`,
          priority: 'normal'
        });
      });

    // è´¨æ£€ç›¸å…³æ´»åŠ¨
    qualityRecords
      .filter(record => {
        const daysDiff = (new Date().getTime() - record.updatedAt.getTime()) / (1000 * 3600 * 24);
        return daysDiff <= 7;
      })
      .forEach(record => {
        allActivities.push({
          id: `qc-${record.id}`,
          type: 'quality_check_completed',
          title: `è´¨æ£€${record.inspectionStatus === 'passed' ? 'é€šè¿‡' : 'å¤±è´¥'}`,
          description: `${record.sku.name} - ${record.receivedQuantity} ä»¶`,
          timestamp: record.updatedAt,
          status: record.inspectionStatus,
          link: `/quality-control/${record.id}`,
          priority: record.inspectionStatus === 'failed' ? 'high' : 'normal'
        });
      });

    // æŒ‰æ—¶é—´æ’åºå¹¶é™åˆ¶æ•°é‡
    return allActivities
      .sort((a, b) => b.timestamp.getTime() - a.timestamp.getTime())
      .slice(0, limit);
  }, [purchaseRequests, orderAllocations, qualityRecords, limit]);

  useEffect(() => {
    setIsLoading(true);
    const activities = generateActivities();
    setActivities(activities);
    setIsLoading(false);
  }, [generateActivities]);

  const getActivityIcon = (type: ActivityType) => {
    const iconClasses = "h-5 w-5";
    
    switch (type) {
      case 'purchase_request_created':
        return <DocumentAddIcon className={`${iconClasses} text-blue-600`} />;
      case 'purchase_request_approved':
        return <CheckCircleIcon className={`${iconClasses} text-green-600`} />;
      case 'order_allocated':
        return <UserGroupIcon className={`${iconClasses} text-purple-600`} />;
      case 'quality_check_completed':
        return <ClipboardCheckIcon className={`${iconClasses} text-yellow-600`} />;
      case 'shipment_ready':
        return <TruckIcon className={`${iconClasses} text-indigo-600`} />;
      default:
        return <InformationCircleIcon className={`${iconClasses} text-gray-600`} />;
    }
  };

  const getPriorityColor = (priority: ActivityItem['priority']) => {
    switch (priority) {
      case 'urgent':
        return 'border-l-red-500 bg-red-50';
      case 'high':
        return 'border-l-orange-500 bg-orange-50';
      case 'normal':
        return 'border-l-blue-500 bg-blue-50';
      default:
        return 'border-l-gray-500 bg-gray-50';
    }
  };

  if (isLoading) {
    return (
      <div className="animate-pulse space-y-4">
        {[...Array(5)].map((_, i) => (
          <div key={i} className="flex items-center space-x-4">
            <div className="rounded-full bg-gray-300 h-10 w-10"></div>
            <div className="space-y-2 flex-1">
              <div className="h-4 bg-gray-300 rounded w-3/4"></div>
              <div className="h-3 bg-gray-300 rounded w-1/2"></div>
            </div>
          </div>
        ))}
      </div>
    );
  }

  if (activities.length === 0) {
    return (
      <div className="text-center py-8">
        <InformationCircleIcon className="mx-auto h-12 w-12 text-gray-400" />
        <h3 className="mt-2 text-sm font-medium text-gray-900">æš‚æ— æ´»åŠ¨</h3>
        <p className="mt-1 text-sm text-gray-500">æœ€è¿‘æ²¡æœ‰ç›¸å…³æ´»åŠ¨è®°å½•</p>
      </div>
    );
  }

  return (
    <div className="flow-root">
      <ul className="-mb-8">
        {activities.map((activity, activityIdx) => (
          <li key={activity.id}>
            <div className="relative pb-8">
              {activityIdx !== activities.length - 1 ? (
                <span
                  className="absolute top-4 left-4 -ml-px h-full w-0.5 bg-gray-200"
                  aria-hidden="true"
                />
              ) : null}
              <div className="relative flex space-x-3">
                <div>
                  <span className="h-8 w-8 rounded-full bg-white flex items-center justify-center ring-8 ring-white">
                    {getActivityIcon(activity.type)}
                  </span>
                </div>
                <div className="min-w-0 flex-1">
                  <div className={`
                    text-sm border-l-4 pl-4 py-2 rounded-r-lg ${getPriorityColor(activity.priority)}
                  `}>
                    <div className="flex items-center justify-between">
                      <p className="font-medium text-gray-900">
                        {activity.link ? (
                          <Link 
                            to={activity.link}
                            className="hover:text-blue-600 hover:underline"
                          >
                            {activity.title}
                          </Link>
                        ) : (
                          activity.title
                        )}
                      </p>
                      <time className="text-xs text-gray-500">
                        {formatRelativeTime(activity.timestamp)}
                      </time>
                    </div>
                    <p className="text-gray-600 mt-1">
                      {activity.description}
                    </p>
                    {activity.user && (
                      <p className="text-xs text-gray-500 mt-1">
                        æ“ä½œäººï¼š{activity.user.name}
                      </p>
                    )}
                  </div>
                </div>
              </div>
            </div>
          </li>
        ))}
      </ul>
    </div>
  );
};
```

---

## ğŸ“ 2. é‡‡è´­ç”³è¯·ç³»ç»Ÿ (`purchase-requests/`)

### 2.1 æ¨¡å—æ¦‚è¿°
é‡‡è´­ç”³è¯·æ˜¯æ•´ä¸ªé‡‡è´­æµç¨‹çš„èµ·ç‚¹ï¼Œè´Ÿè´£æ”¶é›†é‡‡è´­éœ€æ±‚ã€ç”³è¯·åˆ›å»ºå’ŒåŸºç¡€å®¡æ ¸ã€‚

### 2.2 ç»„ä»¶æ¶æ„

#### 2.2.1 PurchaseRequestList ç”³è¯·åˆ—è¡¨ç»„ä»¶
```typescript
// src/components/purchase-requests/PurchaseRequestList.tsx
interface PurchaseRequestListProps {
  filters?: PurchaseRequestFilters;
  onRequestSelect?: (request: PurchaseRequest) => void;
}

interface PurchaseRequestFilters {
  status?: OrderStatus[];
  priority?: RequestPriority[];
  dateRange?: {
    start: Date;
    end: Date;
  };
  requester?: string;
  searchTerm?: string;
}

const PurchaseRequestList: React.FC<PurchaseRequestListProps> = ({
  filters,
  onRequestSelect
}) => {
  const [requests, setRequests] = useState<PurchaseRequest[]>([]);
  const [filteredRequests, setFilteredRequests] = useState<PurchaseRequest[]>([]);
  const [isLoading, setIsLoading] = useState(true);
  const [selectedRequests, setSelectedRequests] = useState<string[]>([]);
  const [sortConfig, setSortConfig] = useState<SortConfig>({
    key: 'createdAt',
    direction: 'desc'
  });

  // å…¨å±€çŠ¶æ€
  const globalRequests = usePurchaseRequests();
  const { batchUpdatePurchaseRequests } = useStoreActions();

  // åˆå§‹åŒ–æ•°æ®
  useEffect(() => {
    setIsLoading(true);
    setRequests(globalRequests);
    setIsLoading(false);
  }, [globalRequests]);

  // åº”ç”¨ç­›é€‰æ¡ä»¶
  useEffect(() => {
    let filtered = [...requests];

    if (filters) {
      // çŠ¶æ€ç­›é€‰
      if (filters.status && filters.status.length > 0) {
        filtered = filtered.filter(req => filters.status!.includes(req.status));
      }

      // ä¼˜å…ˆçº§ç­›é€‰
      if (filters.priority && filters.priority.length > 0) {
        filtered = filtered.filter(req => filters.priority!.includes(req.priority));
      }

      // æ—¥æœŸèŒƒå›´ç­›é€‰
      if (filters.dateRange) {
        filtered = filtered.filter(req => {
          const requestDate = new Date(req.createdAt);
          return requestDate >= filters.dateRange!.start && requestDate <= filters.dateRange!.end;
        });
      }

      // ç”³è¯·äººç­›é€‰
      if (filters.requester) {
        filtered = filtered.filter(req => req.requesterId === filters.requester);
      }

      // æœç´¢è¯ç­›é€‰
      if (filters.searchTerm) {
        const searchLower = filters.searchTerm.toLowerCase();
        filtered = filtered.filter(req =>
          req.requestNumber.toLowerCase().includes(searchLower) ||
          req.requester.name.toLowerCase().includes(searchLower) ||
          req.items.some(item => 
            item.sku.name.toLowerCase().includes(searchLower) ||
            item.sku.code.toLowerCase().includes(searchLower)
          )
        );
      }
    }

    // åº”ç”¨æ’åº
    filtered.sort((a, b) => {
      const aValue = getNestedValue(a, sortConfig.key);
      const bValue = getNestedValue(b, sortConfig.key);
      
      if (aValue < bValue) {
        return sortConfig.direction === 'asc' ? -1 : 1;
      }
      if (aValue > bValue) {
        return sortConfig.direction === 'asc' ? 1 : -1;
      }
      return 0;
    });

    setFilteredRequests(filtered);
  }, [requests, filters, sortConfig]);

  // æ’åºå¤„ç†
  const handleSort = (key: string) => {
    setSortConfig(prev => ({
      key,
      direction: prev.key === key && prev.direction === 'asc' ? 'desc' : 'asc'
    }));
  };

  // é€‰æ‹©å¤„ç†
  const handleSelectRequest = (requestId: string, isSelected: boolean) => {
    if (isSelected) {
      setSelectedRequests(prev => [...prev, requestId]);
    } else {
      setSelectedRequests(prev => prev.filter(id => id !== requestId));
    }
  };

  const handleSelectAll = (isSelected: boolean) => {
    if (isSelected) {
      setSelectedRequests(filteredRequests.map(req => req.id));
    } else {
      setSelectedRequests([]);
    }
  };

  // æ‰¹é‡æ“ä½œ
  const handleBatchStatusUpdate = async (newStatus: OrderStatus) => {
    if (selectedRequests.length === 0) return;

    try {
      const updates = selectedRequests.map(id => ({
        id,
        updates: { status: newStatus, updatedAt: new Date() }
      }));
      
      batchUpdatePurchaseRequests(updates);
      setSelectedRequests([]);
      
      // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
      toast.success(`å·²æ‰¹é‡æ›´æ–° ${selectedRequests.length} ä¸ªé‡‡è´­ç”³è¯·çš„çŠ¶æ€`);
    } catch (error) {
      console.error('Batch update failed:', error);
      toast.error('æ‰¹é‡æ›´æ–°å¤±è´¥ï¼Œè¯·é‡è¯•');
    }
  };

  const getStatusBadge = (status: OrderStatus) => {
    const statusConfig = {
      draft: { color: 'gray', text: 'è‰ç¨¿' },
      submitted: { color: 'yellow', text: 'å·²æäº¤' },
      first_approved: { color: 'blue', text: 'ä¸€çº§å®¡æ‰¹é€šè¿‡' },
      approved: { color: 'green', text: 'å·²æ‰¹å‡†' },
      allocated: { color: 'purple', text: 'å·²åˆ†é…' },
      rejected: { color: 'red', text: 'å·²æ‹’ç»' },
      in_production: { color: 'indigo', text: 'ç”Ÿäº§ä¸­' },
      quality_check: { color: 'orange', text: 'è´¨æ£€ä¸­' },
      ready_to_ship: { color: 'teal', text: 'å¾…å‘è´§' },
      shipped: { color: 'cyan', text: 'å·²å‘è´§' },
      completed: { color: 'emerald', text: 'å·²å®Œæˆ' },
      cancelled: { color: 'slate', text: 'å·²å–æ¶ˆ' }
    };

    const config = statusConfig[status] || statusConfig.draft;
    
    return (
      <span className={`
        inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium
        bg-${config.color}-100 text-${config.color}-800
      `}>
        {config.text}
      </span>
    );
  };

  const getPriorityBadge = (priority: RequestPriority) => {
    const priorityConfig = {
      low: { color: 'gray', text: 'ä½', icon: null },
      normal: { color: 'blue', text: 'æ™®é€š', icon: null },
      high: { color: 'yellow', text: 'é«˜', icon: <ExclamationIcon className="h-3 w-3" /> },
      urgent: { color: 'red', text: 'ç´§æ€¥', icon: <ExclamationTriangleIcon className="h-3 w-3" /> }
    };

    const config = priorityConfig[priority];
    
    return (
      <span className={`
        inline-flex items-center space-x-1 px-2 py-1 rounded text-xs font-medium
        bg-${config.color}-100 text-${config.color}-800
      `}>
        {config.icon}
        <span>{config.text}</span>
      </span>
    );
  };

  if (isLoading) {
    return (
      <div className="animate-pulse">
        <div className="space-y-4">
          {[...Array(5)].map((_, i) => (
            <div key={i} className="bg-white shadow rounded-lg p-6">
              <div className="flex items-center space-x-4">
                <div className="h-4 bg-gray-300 rounded w-1/4"></div>
                <div className="h-4 bg-gray-300 rounded w-1/6"></div>
                <div className="h-4 bg-gray-300 rounded w-1/4"></div>
                <div className="h-4 bg-gray-300 rounded w-1/6"></div>
              </div>
            </div>
          ))}
        </div>
      </div>
    );
  }

  return (
    <div className="bg-white shadow overflow-hidden sm:rounded-md">
      {/* æ‰¹é‡æ“ä½œæ  */}
      {selectedRequests.length > 0 && (
        <div className="bg-blue-50 px-4 py-3 border-b border-blue-200">
          <div className="flex items-center justify-between">
            <div className="flex items-center">
              <span className="text-sm font-medium text-blue-900">
                å·²é€‰æ‹© {selectedRequests.length} ä¸ªé‡‡è´­ç”³è¯·
              </span>
            </div>
            <div className="flex items-center space-x-2">
              <select
                onChange={(e) => handleBatchStatusUpdate(e.target.value as OrderStatus)}
                className="block w-40 px-3 py-2 border border-blue-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                defaultValue=""
              >
                <option value="" disabled>æ‰¹é‡æ“ä½œ</option>
                <option value="approved">æ‰¹å‡†</option>
                <option value="rejected">æ‹’ç»</option>
                <option value="cancelled">å–æ¶ˆ</option>
              </select>
              <button
                onClick={() => setSelectedRequests([])}
                className="inline-flex items-center px-3 py-2 border border-blue-300 shadow-sm text-sm leading-4 font-medium rounded-md text-blue-700 bg-white hover:bg-blue-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
              >
                å–æ¶ˆé€‰æ‹©
              </button>
            </div>
          </div>
        </div>
      )}

      {/* è¡¨æ ¼æ ‡é¢˜æ  */}
      <div className="bg-gray-50 px-6 py-3 border-b border-gray-200">
        <div className="flex items-center justify-between">
          <div className="flex items-center">
            <input
              type="checkbox"
              className="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded"
              checked={selectedRequests.length === filteredRequests.length && filteredRequests.length > 0}
              onChange={(e) => handleSelectAll(e.target.checked)}
            />
            <span className="ml-3 text-sm font-medium text-gray-900">
              å…¨é€‰
            </span>
          </div>
          <div className="text-sm text-gray-500">
            å…± {filteredRequests.length} æ¡è®°å½•
          </div>
        </div>
      </div>

      {/* ç”³è¯·åˆ—è¡¨ */}
      <ul className="divide-y divide-gray-200">
        {filteredRequests.map((request) => (
          <li key={request.id}>
            <div className="px-6 py-4 hover:bg-gray-50">
              <div className="flex items-center justify-between">
                <div className="flex items-center space-x-4 flex-1">
                  <input
                    type="checkbox"
                    className="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded"
                    checked={selectedRequests.includes(request.id)}
                    onChange={(e) => handleSelectRequest(request.id, e.target.checked)}
                  />
                  
                  <div className="flex-1 min-w-0">
                    <div className="flex items-center justify-between">
                      <div className="flex items-center space-x-3">
                        <button
                          onClick={() => onRequestSelect?.(request)}
                          className="text-sm font-medium text-blue-600 hover:text-blue-900 hover:underline"
                        >
                          {request.requestNumber}
                        </button>
                        {getStatusBadge(request.status)}
                        {getPriorityBadge(request.priority)}
                      </div>
                      <div className="flex items-center space-x-4 text-sm text-gray-500">
                        <span>Â¥{request.totalAmount?.toLocaleString()}</span>
                        <span>{formatDate(request.createdAt)}</span>
                      </div>
                    </div>
                    
                    <div className="mt-2">
                      <div className="flex items-center justify-between">
                        <div className="flex items-center space-x-4 text-sm text-gray-600">
                          <span>ç”³è¯·äººï¼š{request.requester.name}</span>
                          <span>é¡¹ç›®æ•°ï¼š{request.items.length}</span>
                          <span>äº¤æœŸï¼š{formatDate(request.deadline)}</span>
                        </div>
                      </div>
                    </div>
                    
                    {/* ä¸»è¦é¡¹ç›®é¢„è§ˆ */}
                    <div className="mt-2">
                      <div className="flex flex-wrap gap-2">
                        {request.items.slice(0, 3).map((item) => (
                          <span
                            key={item.id}
                            className="inline-flex items-center px-2 py-1 rounded-md text-xs bg-gray-100 text-gray-800"
                          >
                            {item.sku.name} Ã— {item.quantity}
                          </span>
                        ))}
                        {request.items.length > 3 && (
                          <span className="inline-flex items-center px-2 py-1 rounded-md text-xs bg-gray-100 text-gray-500">
                            +{request.items.length - 3} æ›´å¤š
                          </span>
                        )}
                      </div>
                    </div>
                  </div>
                </div>
                
                {/* æ“ä½œæŒ‰é’® */}
                <div className="flex items-center space-x-2 ml-4">
                  <button
                    onClick={() => onRequestSelect?.(request)}
                    className="inline-flex items-center px-3 py-2 border border-gray-300 shadow-sm text-sm leading-4 font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
                  >
                    æŸ¥çœ‹è¯¦æƒ…
                  </button>
                  
                  {request.status === 'draft' && (
                    <button
                      onClick={() => {/* ç¼–è¾‘é€»è¾‘ */}}
                      className="inline-flex items-center px-3 py-2 border border-transparent text-sm leading-4 font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
                    >
                      ç¼–è¾‘
                    </button>
                  )}
                </div>
              </div>
            </div>
          </li>
        ))}
      </ul>

      {/* ç©ºçŠ¶æ€ */}
      {filteredRequests.length === 0 && (
        <div className="text-center py-12">
          <DocumentTextIcon className="mx-auto h-12 w-12 text-gray-400" />
          <h3 className="mt-2 text-sm font-medium text-gray-900">æš‚æ— é‡‡è´­ç”³è¯·</h3>
          <p className="mt-1 text-sm text-gray-500">
            {filters ? 'æ²¡æœ‰ç¬¦åˆç­›é€‰æ¡ä»¶çš„é‡‡è´­ç”³è¯·' : 'è¿˜æ²¡æœ‰åˆ›å»ºä»»ä½•é‡‡è´­ç”³è¯·'}
          </p>
        </div>
      )}
    </div>
  );
};
```

#### 2.2.2 CreatePurchaseRequest åˆ›å»ºç”³è¯·ç»„ä»¶
```typescript
// src/components/purchase-requests/CreatePurchaseRequest.tsx
interface CreatePurchaseRequestProps {
  onSubmit: (request: Partial<PurchaseRequest>) => Promise<void>;
  onCancel: () => void;
  initialData?: Partial<PurchaseRequest>;
}

const CreatePurchaseRequest: React.FC<CreatePurchaseRequestProps> = ({
  onSubmit,
  onCancel,
  initialData
}) => {
  const [formData, setFormData] = useState<PurchaseRequestFormData>({
    items: [createEmptyItem()],
    priority: 'normal',
    deadline: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000), // é»˜è®¤7å¤©å
    remarks: '',
    type: 'external'
  });
  
  const [errors, setErrors] = useState<FormErrors>({});
  const [isSubmitting, setIsSubmitting] = useState(false);
  const [availableSKUs, setAvailableSKUs] = useState<SKU[]>([]);
  
  const { user } = useAuth();
  const { addPurchaseRequest } = useGlobalStore();

  // åˆå§‹åŒ–SKUæ•°æ®
  useEffect(() => {
    // è¿™é‡Œåº”è¯¥ä»APIåŠ è½½SKUæ•°æ®
    // æš‚æ—¶ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®
    setAvailableSKUs(mockSKUs);
  }, []);

  // åˆå§‹åŒ–è¡¨å•æ•°æ®
  useEffect(() => {
    if (initialData) {
      setFormData(prev => ({ ...prev, ...initialData }));
    }
  }, [initialData]);

  const createEmptyItem = (): PurchaseRequestItemFormData => ({
    skuId: '',
    quantity: 1,
    urgency: 'normal',
    remarks: '',
    material: '',
    packagingMethod: '',
    specifications: []
  });

  const validateForm = (): boolean => {
    const newErrors: FormErrors = {};

    // éªŒè¯åŸºæœ¬ä¿¡æ¯
    if (!formData.deadline) {
      newErrors.deadline = 'è¯·é€‰æ‹©æœŸæœ›äº¤æœŸ';
    } else if (formData.deadline <= new Date()) {
      newErrors.deadline = 'äº¤æœŸä¸èƒ½æ—©äºä»Šå¤©';
    }

    // éªŒè¯ç”³è¯·é¡¹ç›®
    if (formData.items.length === 0) {
      newErrors.items = 'è‡³å°‘éœ€è¦ä¸€ä¸ªç”³è¯·é¡¹ç›®';
    } else {
      const itemErrors: Record<string, any> = {};
      
      formData.items.forEach((item, index) => {
        const itemError: any = {};
        
        if (!item.skuId) {
          itemError.skuId = 'è¯·é€‰æ‹©äº§å“';
        }
        
        if (!item.quantity || item.quantity <= 0) {
          itemError.quantity = 'æ•°é‡å¿…é¡»å¤§äº0';
        }
        
        if (Object.keys(itemError).length > 0) {
          itemErrors[index] = itemError;
        }
      });
      
      if (Object.keys(itemErrors).length > 0) {
        newErrors.items = itemErrors;
      }
    }

    setErrors(newErrors);
    return Object.keys(newErrors).length === 0;
  };

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    
    if (!validateForm()) {
      return;
    }

    setIsSubmitting(true);
    
    try {
      // è®¡ç®—æ€»é‡‘é¢ï¼ˆåŸºäºé¢„ä¼°ä»·æ ¼ï¼‰
      const totalAmount = formData.items.reduce((sum, item) => {
        const sku = availableSKUs.find(s => s.id === item.skuId);
        const estimatedPrice = sku?.estimatedPrice || 0;
        return sum + (estimatedPrice * item.quantity);
      }, 0);

      // æ„å»ºå®Œæ•´çš„é‡‡è´­ç”³è¯·å¯¹è±¡
      const requestData: Partial<PurchaseRequest> = {
        requestNumber: generateRequestNumber(),
        requesterId: user!.id,
        items: formData.items.map(item => ({
          ...item,
          id: generateId(),
          sku: availableSKUs.find(s => s.id === item.skuId)!,
          status: 'pending',
          createdAt: new Date(),
          updatedAt: new Date()
        })),
        totalAmount,
        status: 'draft',
        approvalStatus: 'pending',
        priority: formData.priority,
        deadline: formData.deadline,
        remarks: formData.remarks,
        type: formData.type,
        createdAt: new Date(),
        updatedAt: new Date(),
        version: 1
      };

      await onSubmit(requestData);
      
      // é‡ç½®è¡¨å•
      setFormData({
        items: [createEmptyItem()],
        priority: 'normal',
        deadline: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000),
        remarks: '',
        type: 'external'
      });
      
      toast.success('é‡‡è´­ç”³è¯·åˆ›å»ºæˆåŠŸ');
      
    } catch (error) {
      console.error('Failed to create purchase request:', error);
      toast.error('åˆ›å»ºå¤±è´¥ï¼Œè¯·é‡è¯•');
    } finally {
      setIsSubmitting(false);
    }
  };

  const handleAddItem = () => {
    setFormData(prev => ({
      ...prev,
      items: [...prev.items, createEmptyItem()]
    }));
  };

  const handleRemoveItem = (index: number) => {
    if (formData.items.length <= 1) {
      toast.warning('è‡³å°‘éœ€è¦ä¿ç•™ä¸€ä¸ªç”³è¯·é¡¹ç›®');
      return;
    }
    
    setFormData(prev => ({
      ...prev,
      items: prev.items.filter((_, i) => i !== index)
    }));
  };

  const handleItemChange = (index: number, field: string, value: any) => {
    setFormData(prev => ({
      ...prev,
      items: prev.items.map((item, i) => 
        i === index ? { ...item, [field]: value } : item
      )
    }));

    // æ¸…é™¤ç›¸å…³é”™è¯¯
    if (errors.items && typeof errors.items === 'object' && errors.items[index]) {
      const newErrors = { ...errors };
      delete newErrors.items[index][field];
      if (Object.keys(newErrors.items[index]).length === 0) {
        delete newErrors.items[index];
      }
      setErrors(newErrors);
    }
  };

  return (
    <div className="max-w-4xl mx-auto">
      <form onSubmit={handleSubmit} className="space-y-8">
        {/* åŸºæœ¬ä¿¡æ¯ */}
        <div className="bg-white shadow rounded-lg">
          <div className="px-6 py-4 border-b border-gray-200">
            <h3 className="text-lg leading-6 font-medium text-gray-900">
              åŸºæœ¬ä¿¡æ¯
            </h3>
          </div>
          <div className="px-6 py-4 space-y-6">
            <div className="grid grid-cols-1 gap-6 sm:grid-cols-2">
              <div>
                <label htmlFor="priority" className="block text-sm font-medium text-gray-700">
                  ä¼˜å…ˆçº§ <span className="text-red-500">*</span>
                </label>
                <select
                  id="priority"
                  value={formData.priority}
                  onChange={(e) => setFormData(prev => ({ ...prev, priority: e.target.value as RequestPriority }))}
                  className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                >
                  <option value="low">ä½ä¼˜å…ˆçº§</option>
                  <option value="normal">æ™®é€š</option>
                  <option value="high">é«˜ä¼˜å…ˆçº§</option>
                  <option value="urgent">ç´§æ€¥</option>
                </select>
              </div>

              <div>
                <label htmlFor="type" className="block text-sm font-medium text-gray-700">
                  é‡‡è´­ç±»å‹ <span className="text-red-500">*</span>
                </label>
                <select
                  id="type"
                  value={formData.type}
                  onChange={(e) => setFormData(prev => ({ ...prev, type: e.target.value as PurchaseType }))}
                  className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                >
                  <option value="external">å‚å®¶åŒ…è£…</option>
                  <option value="in_house">è‡ªå·±åŒ…è£…</option>
                </select>
              </div>

              <div>
                <label htmlFor="deadline" className="block text-sm font-medium text-gray-700">
                  æœŸæœ›äº¤æœŸ <span className="text-red-500">*</span>
                </label>
                <input
                  type="date"
                  id="deadline"
                  value={formData.deadline ? formatDate(formData.deadline, 'YYYY-MM-DD') : ''}
                  onChange={(e) => setFormData(prev => ({ ...prev, deadline: new Date(e.target.value) }))}
                  className={`mt-1 block w-full px-3 py-2 border rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm ${
                    errors.deadline ? 'border-red-300' : 'border-gray-300'
                  }`}
                />
                {errors.deadline && (
                  <p className="mt-1 text-sm text-red-600">{errors.deadline}</p>
                )}
              </div>
            </div>

            <div>
              <label htmlFor="remarks" className="block text-sm font-medium text-gray-700">
                å¤‡æ³¨è¯´æ˜
              </label>
              <textarea
                id="remarks"
                rows={3}
                value={formData.remarks}
                onChange={(e) => setFormData(prev => ({ ...prev, remarks: e.target.value }))}
                className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                placeholder="è¯·è¾“å…¥ç›¸å…³å¤‡æ³¨ä¿¡æ¯..."
              />
            </div>
          </div>
        </div>

        {/* ç”³è¯·é¡¹ç›® */}
        <div className="bg-white shadow rounded-lg">
          <div className="px-6 py-4 border-b border-gray-200">
            <div className="flex items-center justify-between">
              <h3 className="text-lg leading-6 font-medium text-gray-900">
                ç”³è¯·é¡¹ç›®
              </h3>
              <button
                type="button"
                onClick={handleAddItem}
                className="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
              >
                <PlusIcon className="h-4 w-4 mr-2" />
                æ·»åŠ é¡¹ç›®
              </button>
            </div>
          </div>
          
          <div className="px-6 py-4">
            {formData.items.map((item, index) => (
              <PurchaseRequestItemForm
                key={index}
                item={item}
                index={index}
                availableSKUs={availableSKUs}
                errors={errors.items?.[index] || {}}
                onChange={(field, value) => handleItemChange(index, field, value)}
                onRemove={() => handleRemoveItem(index)}
                canRemove={formData.items.length > 1}
              />
            ))}
            
            {errors.items && typeof errors.items === 'string' && (
              <p className="mt-2 text-sm text-red-600">{errors.items}</p>
            )}
          </div>
        </div>

        {/* æäº¤æŒ‰é’® */}
        <div className="flex justify-end space-x-4">
          <button
            type="button"
            onClick={onCancel}
            className="inline-flex items-center px-6 py-3 border border-gray-300 shadow-sm text-base font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
          >
            å–æ¶ˆ
          </button>
          
          <button
            type="button"
            onClick={handleSubmit}
            disabled={isSubmitting}
            className="inline-flex items-center px-6 py-3 border border-transparent text-base font-medium rounded-md text-white bg-gray-600 hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500 disabled:opacity-50"
          >
            {isSubmitting ? 'ä¿å­˜ä¸­...' : 'ä¿å­˜è‰ç¨¿'}
          </button>
          
          <button
            type="submit"
            disabled={isSubmitting}
            className="inline-flex items-center px-6 py-3 border border-transparent text-base font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:opacity-50"
          >
            {isSubmitting ? 'æäº¤ä¸­...' : 'æäº¤ç”³è¯·'}
          </button>
        </div>
      </form>
    </div>
  );
};
```

---

**ç¬¬äºŒæ‰¹æ–‡æ¡£å·²å®Œæˆï¼**

ç°åœ¨è®©æˆ‘ç»§ç»­ç¼–å†™ç¬¬ä¸‰æ‰¹ï¼šè¿›åº¦è·Ÿè¸ªç³»ç»Ÿã€‚

ç»§ç»­ç¬¬ä¸‰æ‰¹ï¼Ÿ
